# 重访 HHVM

> 原文:[https://www.sitepoint.com/hhvm-revisited/](https://www.sitepoint.com/hhvm-revisited/)

距离马特·特兰上一篇关于 HHVM 的文章已经过去两年多了。那段时间发生了什么变化？做了什么吗？让我们看看 PHP 对性能的追求有多成功。

## HHVM——那是什么？

就像马特在他的文章中说的，HHVM 是

> […]实时(或 JIT)编译器。hhvm 不是通过 C++编译阶段将 PHP 翻译成本机代码，而是将 PHP 翻译成一种称为 HipHop 字节码(HHBC)的中间字节码语言，可以在需要时实时翻译成本机代码[…]

换句话说，您的 PHP 代码以接近本机(接近 C++)的速度动态执行。HipHop 最初是一个编译器，它的二进制文件生成后，您可以进行部署——很像 Zend Guard 或 IonCube。HHVM 的不同之处在于它是实时的。本质上仍然没有手工编译过程，开发周期仍然很快。

那是什么呢？一个服务器？它是如何执行我的 PHP 的？它能和 Apache/Nginx/IIS 一起工作吗？它会取代它们吗？它能和他们竞争吗？你如何使用它？你是作为扩展安装的吗？我知道，当这些问题听起来如此抽象时，它们会引起一些令人头疼的问题。让我们试着进一步揭开它的神秘面纱。

## HHVM 实际上是如何工作的？

当给 HHVM 一个 PHP 文件时，它会把这个文件编译成 HHVM 字节码。它实际上将其重写为一种更低的语言，这种语言更快地进一步重写为本机代码——CPU 可以直接解释的代码。正如您可能想象的那样，每次访问一个文件时都重复这样做是多余的，实际上会使整个应用程序变慢。这就是为什么 HHVM 使用磁盘上的 SQLite 数据库来记住编译过的文件。

如果你熟悉 APC，这或多或少是一回事。当 HHVM 第一次启动时，缓存是空的，所以在最初的几个请求中，一切都显得较慢。然而，随着时间的推移，事情开始升温，应用程序加速。APC 的工作方式和 HHVM 的有一个重要区别。APC 将编译后的代码存储在内存中，而 HHVM 将编译后的代码存储在磁盘上(SQLite DB)。这意味着编译结果**在重启**后仍然存在——当您重启服务器时，缓存的编译文件仍然存在，因此不需要预热时间。虽然这比从内存中读取要慢一些(每个磁盘总是比 RAM 慢)，但这也意味着你可以通过将应用程序托管在 SSD 服务器上来进一步提高应用程序的速度。

通过 JIT 可以进一步提高性能。这是一个选项，但是对于服务器和守护进程模式，默认情况下是`on`。JIT 所做的是进一步将 HHVM 字节码编译成本地代码，因为它知道最常用的文件。同样，这带来了一定的热身期，但一旦球开始滚动，就会有相当多的惯性与之竞争。

## HHVM 与流行服务器的兼容性

HHVM 是通过包管理器安装的，或者是从源代码构建的。本质上，它只是一个你需要像其他程序一样安装的程序——目前可以在 Ubuntu、Debian、CentOS 和 Fedora 上安装。最初，HHVM 替换了整个 PHP+服务器堆栈——它有自己的服务器。事实上，现在仍然如此。HHVM 的服务器与你在使用 NodeJS 时可能看到的服务器没有什么不同——你从命令行运行它，告诉它接受给定端口上的请求，以及你通常告诉 Apache、Nginx、IIS、Tomcat、Lighttpd 或任何其他服务器的所有其他东西。有大量的配置选项供您阅读([https://github.com/facebook/hhvm/wiki/runtime-options](https://github.com/facebook/hhvm/wiki/runtime-options))，其中大多数都是不言自明和简单明了的。事实上，如果你跟随 HHVM 的[优秀的 WordPress 教程](http://www.hhvm.com/blog/113/getting-wordpress-running-on-hhvm)，你会看到一个基本的服务器配置是多么简单。

然而，2013 年 12 月 17 日，HHVM 团队[宣布](http://www.hhvm.com/blog/1817/fastercgi-with-hhvm)支持 FastCGI。FastCGI 是服务器与应用服务器通信的协议。这允许职责分离——HHVM 运行 PHP 代码，这是它的本意，而你的服务器处理所有的 HTTP 方面，将 PHP 处理转发给 HHVM。虽然最初的 HHVM 服务器还不错，但很高兴知道 HHVM 现在可以与您通常选择的服务器协同使用。值得注意的是，它目前只支持通过 TCP 进行通信——一旦增加了 Unix 套接字支持，目前困扰它的网络瓶颈将会消失，HHVM 的性能将会进一步提高。

## 性能考虑因素

当考虑速度时，HHVM FastCGI 与 HHVM 的实际性能仅取决于静态资源的数量。尽管纯 HHVM 在执行 PHP 脚本时几乎总是更快，但当涉及到静态资源数量时，针对此类任务优化的服务器可能会做得更好——正如 HHVM 的推文所证实的:

> [@matthieunapoli](https://twitter.com/matthieunapoli) 视静态资源数量而定？可能吧。Nginx 肯定会在非 php 内容上击败我们。
> 
> -跳转行(@跳转行)[2013 年 12 月 18 日](https://twitter.com/HipHopVM/statuses/413368254631907328)