# 你试过 Opa 吗？

> 原文:[https://www.sitepoint.com/have-you-tried-opa/](https://www.sitepoint.com/have-you-tried-opa/)

网络不仅在规模上增长，而且在重要性上也在增长。我们所知的现代网络与早期的静态页面没有太大关系；今天，它绝不是静态的。一些页面甚至获得了网络应用的称号——比如谷歌文档(Google Docs)——通过浏览器访问的应用，并开始对更传统的分发模式构成严重竞争。

开发这些应用程序并不简单。它们本来就分布在客户端(浏览器)和服务器之间。两者通常都是用不同的技术开发的，需要投入精力在它们之间进行交流。

我们经常以复杂的技术堆栈告终。一种用于服务器端的编程语言，通常在它上面有一个框架，一种用于客户端的编程语言(通常是 JavaScript)有一些库(jQuery，Dojo，Prototype，…)，还有一个数据库及其查询语言。所有不同的技术，不同的概念和模型。添加配置和倾向于他们之间的交流，你会得到一个相当复杂的拼图图片。将所有元素整合在一起并非易事。

新的 web 编程平台 Opa 的目标是简化这种情况，并用单一的编程语言取代复杂的技术堆栈。让我们来看看一些简单的 Opa 程序，看看它是如何试图让 web 开发人员的生活变得更容易的。

## 你好，欧巴！

也许最简单的 Opa 程序如下:

```
Server.start(Server.http,
  { title: "Hello web",
    page: function() { <h1>Hello web</h1> }
  }
)
```

让我们试着理解这里发生了什么。首先，`Server.start`是启动网络服务器的功能。它需要两个参数，第一个是服务器配置，包括端口、加密参数等。–这里我们只是使用默认的 http 设置。第二个参数是服务器应该如何处理传入请求的描述。第二个参数可能有许多变体，这里我们使用一个简单的单页面服务变体，它接受一个带有两个字段的记录:title 和 page。

`Title`只是这个单页标题的字符串。`Page`是一个没有参数的函数，返回页面的 HTML 内容。注意我们是如何为这个字段使用匿名函数的，函数中的最后一个表达式是它的返回值。还要注意 Opa 如何“理解”HTML 并通过通常的语法接受它。

Opa 建立在现代标准之上，因此它支持 HTML5，正如现有的社区项目所见证的那样，它们使用:WebGL、Canvas 和 SVG 矢量图形。它还提供与现有服务的连接，包括广泛的图书馆:脸书，Twitter，Dropbox 和 GitHub。

## 汇编

我们如何运行应用程序？在 Opa 中，这是一个两步过程。首先，我们必须编译这个程序:(假设我们把它保存在名为 hello.opa)
`opa hello.opa`的文件中，然后我们可以用:`./hello.exe`运行它

随着解释语言的日益流行，有人可能会问为什么 Opa 需要编译。除了通常认为编译允许优化和更好的整体性能之外，这种方法至少有两个优点。

Opa 编译器将所有应用程序资源(包括图像等)收集并打包成一个最终的可执行文件(在我们的例子中是 hello.exe)。这意味着在服务器上部署它只需要复制这个文件并在那里运行它。没有外部依赖性。没有被遗忘的文件。

## 类型检查

其次，Opa 是一种强静态类型语言，编译阶段有许多检查，包括类型检查。这意味着编译器能够检测出一大类编程错误并指出来，甚至在你运行你的程序之前。这非常重要，事实上这也是 Opa 和其他一些 web 技术的关键区别之一，比如 [Node.js](https://www.sitepoint.com/serving-static-files-with-node-js/) 。

为了更好地理解这一点，让我们看一下我们的简单程序。如果我们在其中一个函数或字段名中打错了会怎么样？如果我们忘记了一个论点呢？如果 page 返回一个字符串，而不是一个 HTML 片段会怎么样？在所有这些情况下，编译器会指出错误，并清楚地指出问题。

但是支票远不止于此。Server.start 函数的第二个参数可能有许多变体。Opa 的类型检查器足够强大，可以推断出哪些变体是允许的，并且只接受那些变体。我说推断，是因为在大多数情况下，你不需要用类型来注释你的程序(比如在 Java 中)，相反，编译器会为你执行类型推断。尤其是在更大的项目中:这是一个救命稻草。

## 简单演示

很难通过一个人如何编写“Hello world”来判断一种语言，所以让我们来看一个稍微复杂一点的 Opa 程序，尽管它仍然是基本的。

```
database mydb { int /counter = 0; }
function action(_) {
    /mydb/counter < - /mydb/counter + 1;
    #msg = <>Hello, user number {/mydb/counter}!;
}
function page() {
    <h1 onclick={action}>Hello, world</h1>
    <div id="msg">Click the header</div>;
}
Server.start(Server.http, { ~page, title: "Hello, world" });
```

这个程序是做什么的？它显示了一个带有“Hello，world”标题的页面，以及一条“单击标题”的消息。在点击标题时，消息被替换为“你好，用户号 x”，其中 x 被替换为自从服务开始以来标题被点击的次数，即:例如，在重新启动 web 服务器时，它不会被重置。

## 数据库ˌ资料库

让我们仔细看看这个程序。为了统计点击次数，它使用了一个数据库，因此它从一个名为 mydb 的数据库声明开始，在 path /counter 中包含一个 int 类型的值。Opa 中的数据库路径是 DB 值的位置，从概念上讲，有点类似于文件系统路径。这是一个非常普通的数据库，但是在路径的数量和复杂性上基本上没有限制。

在 action 函数中可以看到，Opa 在核心语言中紧密集成了数据库编程，为数据库读取和更新提供了便捷的语法；和查询，尽管这超出了本文的范围。通过一个简单的注释，人们可以选择驱动应用程序的数据库引擎，MongoDB 是目前 Opa 中的首选。

## 交互性

到页面功能上。有趣的是，静态 HTML 包含一个事件处理程序，它指向我们程序中的一个函数。

```
<h1 onclick={action}>Hello, world</h1>
```

其中所述函数使用特殊语法进行一些数据库操作和 DOM 操作:

```
#msg = <>Hello, user number {/mydb/counter}!;
```

这里有两件事在起作用。首先，#id = content 的意思是:用内容替换 id 为的 DOM 元素的内容。第二，HTML 片段包含一个 insert，这是一种将值注入字符串/HTML 片段的简单而安全的方法(稍后将详细介绍)。例如 Java 的:

```
System.out.println(x + " + " + y + " = " + (x+y));
```

在 Opa 中会变成:

```
println("{x} + {y} = {x+y}");
```

## 统一的客户端/服务器编码

在 action 函数的代码片段中，插入恰好是数据库中的一个读操作。这个函数有趣的地方在于，显然所有的数据库操作都必须在服务器上执行，而所有的 DOM 操作都需要在客户机上进行。Opa 编译器不仅能计算出应该在哪里发生什么，而且还能自动为客户机生成 Javascript，并透明地处理所有客户机-服务器通信。

当然，开发人员可以更好地控制正在发生的事情，并通过简单的函数注释自己决定什么应该去哪里。但是好的一面是，将函数从客户机移动到服务器(反之亦然)归结为用 server 替换 client 关键字，其余的由编译器处理。

另一件值得注意的事情是，在 Opa 中编写事件处理程序和实现交互性是多么容易。事实上，这种语言为实时 web 提供了强大的构造，但是这超出了这篇短文的范围。

## 安全性

web 应用程序的一个主要挑战，也是 Opa 特别关注的一个挑战，就是安全性。由于持续的客户端-服务器通信和 web 应用程序的交互性质，确保敏感信息不泄漏以及用户不会做有害的事情非常具有挑战性。Opa 对这个问题采取了双重方法。

除了客户机/服务器函数注释之外，它还为服务器函数提供了两个额外的注释:exposed 和 protected，这两个注释区分了可以针对性能进行优化的服务器入口点和那些不应该被访问的入口点(对于受损的客户机事件)。

第二个安全措施来自前面提到的 Opa 的类型安全。一方面，这意味着(就像其他一些高级语言一样)缓冲区溢出或空指针异常不会在 Opa 中发生。另一方面，它提供了对大多数流行的安全威胁的保护，如 XSS 攻击和代码注入。这种保护是可能的，因为通过键入 Opa 知道什么是 URL，什么是 HTML，什么是数据库查询(与动态/弱类型语言相反，在动态/弱类型语言中，上述所有内容都只是字符串)，因此可以正确地清理所有插入。

在这篇短文中，我仅仅有机会了解了 Opa 所提供的一些皮毛，但是我希望这足以让您对这门语言感兴趣。我希望在不久的将来继续发布更多关于 Opa 的新闻和教程。现在，如果你想了解更多，我建议你访问 Opa 的 [网站](http://opalang.org/) ，在那里你可以 [下载](http://opalang.org/get.xmlt) [it](http://opalang.org/get.xmlt) ，阅读 [手册](http://doc.opalang.org/) ，[博客](http://blog.opalang.org/) (附带众多教程)等等如果你想知道更多，你可以在 [论坛](http://forum.opalang.org/) 上找到有用的 Opa 社区。

## 分享这篇文章