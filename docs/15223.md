# 使用 PHPCache 节省资源

> 原文:[https://www.sitepoint.com/saving-resources-phpcache/](https://www.sitepoint.com/saving-resources-phpcache/)

数据库是非常棒的工具——在你的网站后面使用一个数据库可以在灵活性和可维护性方面给你巨大的力量。数据库有效地将您的内容与设计分开，允许您编辑一个而不影响另一个。再加上 PHP 等新型脚本语言和 MySQL 等免费数据库的发展，数据库驱动的网站越来越受欢迎。

然而，尽管数据库驱动的网站比传统的静态网站有很多好处，但运行动态网站也有两个主要的缺点。首先，人们倾向于使用查询字符串(任何跟在“？”后面的东西)在 URL 中)，将正确的信息传递给它们的脚本。这种方法会给搜索引擎带来问题，然而，有一些解决这个问题的方法。

动态站点的第二个问题是，它会产生很高的服务器负载，随着站点越来越受欢迎，它可能会由于执行的数据库查询数量的增加而变得更慢。在本文中，我们将研究这个问题的解决方案——为您的站点实现一个缓存系统。

有不同的方法来减少你的站点产生的服务器负载。有些人建议使用静态页面而不是动态页面，并定期运行生成新静态页面的脚本或程序。这种方法是可行的——但是如果您仍然希望在相关页面上动态提供一些元素，该怎么办呢？

嗯，你可以写一个脚本，定期生成另一个脚本。例如，您可以使用一个 PHP 脚本来生成另一个 PHP 脚本，而不是使用 PHP 脚本来生成 HTML 文件。在这种情况下，生成的脚本会比其父脚本产生更少的服务器开销。虽然这种方法可能会成功，但也可能会产生更多的工作—您需要编写不同的脚本来生成使用这种技术运行的每个页面。此外，如果您选择生成 HTML 页面，然后又改变主意，您可能需要等待一个月或更长时间才能让搜索引擎将您的所有新页面编入索引。在这段时间里，你很容易失去你的成绩排名。

相反，为什么不使用缓存系统呢？这个工具允许您缓存部分脚本，比如数据库查询，同时保持其他元素完全动态。那么如何编写一个缓存系统呢？嗯，你不需要，因为 0x00.org[的](http://0x00.org)[内森](mailto:nathan@0x00.org)已经写了一个很棒的系统，并在通用公共许可证下发布。这篇文章将教你如何在你自己的站点上安装和使用这个脚本。

##### 安装 phpCache

首先，[下载脚本](http://www.0x00.org/php/phpCache/)。解压缩它-您需要的唯一文件是 phpCache.inc .在您空闲时查看其他包含的文件:它们可能会为您提供使用脚本的不同方法的想法，但是对于本文的目的来说，它们是不需要的。

提取文件后，考虑对其进行重命名。将任何不以正确的文件扩展名结尾的脚本放在服务器上的任何公共区域都不是一个好主意。这是因为该文件中可能存在敏感信息，如果用户试图直接访问该文件，他们将能够:如果该文件没有正确的扩展名，其中的代码将显示在浏览器中。因此，最好使用. php 扩展名重命名该文件，或者将其存储在根公共目录之上的目录中。

您需要在文件本身内部编辑一些东西。在您最喜欢的文本编辑器中打开该文件，并查找这一行:

```
define(CACHE_DIR, "/tmp/phpCache/");
```

除非你有自己的服务器，否则你需要编辑代码。您应该在您的 html 根目录上创建一个 tmp 目录，并在其中放置一个 phpCache 目录。然后输入新目录的路径，如下所示:

```
define(CACHE_DIR, "/home/username/tmp/phpCache/");
```

如果您不知道目录的路径，请询问您的服务器管理员或登录到 shell 会话并使用 pwd 命令。

你可能需要编辑的另一件事是按键功能。phpCache 使用一个键来存储缓存的数据。默认情况下，使用 GET 和 POST 变量以及您的查询字符串来生成密钥。如果您使用另一种方法向动态页面传递信息，那么您需要编辑这个函数，以便将这些变量考虑在内。

您可能使用的两个变量是`$PATH_INFO or $REQUEST_URI`——如果您正在使用它们，请将您的`cache_default_key()`函数(在 phpCache.inc 文件中找到)更改为:

```
function cache_default_key() {  

  global $HTTP_GET_VARS, $QUERY_STRING, $PATH_INFO,   

  $REQUEST_URI;  

  return md5("GET=" . serialize($HTTP_GET_VARS) . "QS=" .   

  $QUERY_STRING . "PATH_INFO=" . $PATH_INFO . "REQUEST_URI=" .   

  $REQUEST_URI);  

}
```

或者，如果您在进行缓存时选择使用`cache()`而不是`cache_all()`函数，您可以指定您想要键入的内容。如果使用`cache()`函数，您还可以选择基于其他东西对缓存进行键控，比如您的数据库主键。稍后会详细介绍。

一旦你上传了文件，你需要把它放在你想使用它的 PHP 脚本的开头，就像这样:

```
include("../phpCache.inc"); 
```

现在您已经安装了脚本，并在您希望使用它的脚本中就位，让我们学习如何使用它来缓存您的数据。

##### 设置缓存功能

有一个主要的功能你需要熟悉，那就是`cache()`。这个函数有三个参数:时间、对象和关键点，用法如下:

```
if (!($et=cache(time, object, key))){  

.  

.  

.  

endcache();  

}
```

上面的第一行使用缓存脚本定义的`$et`变量来检查是否有可用的缓存。如果没有，它后面的代码块将被执行。正是在这个代码块中，您需要包含想要缓存的信息(比如您的数据库查询)。最后执行`endcache()`函数，它保存并关闭缓存。没有`endcache()`功能，你的数据不会被保存，所以一定要包括它。

在你的页面上设置它之前，有一个重要的细节你需要知道。如果您将在缓存之外运行任何查询，除了您将在缓存内运行的查询之外，不要在缓存的代码块中建立数据库连接。而是将它放在代码块之上，这样您的非缓存查询仍然可以运行。

现在我们需要填充`cache()`函数的参数。第一个参数 time 非常简单:它是以秒为单位的缓存持续时间。您可以将该参数设置为 60 秒到 600 万秒之间的任何数字。如果将 time 参数设置为 0，缓存将永远不会超时。

接下来的参数实际上是一起工作的，因为它们都用于存储和标识缓存的数据。object 参数通常包含脚本的名称或 URL。key 参数通常包含一个与脚本名称无关的标识符，如查询字符串、表单变量或数据库的主键，如上所述。为了存储和检索缓存的数据，phpCache 将交叉引用对象和键。

还有另外一个用于缓存的函数，叫做`cache_all()`，可以这样使用:

```
if (!($et=cache_all(time))){  

.  

.  

.  

endcache();  

}
```

这个函数的明显区别是它只需要一个参数，时间。它没有 object 或 key 参数的原因是它对这些字段使用默认值。默认值由您在`phpCache.inc`文件中找到的两个函数生成。一、`cache_default_key()`，我们上面提到过。这个函数根据表单变量和查询字符串生成一个键。对象默认值由`cache_default_object()`函数生成，并简单地返回脚本的主机和文件名。

在许多情况下，您可以使用这些默认值。我上面提到过一个例外，您可能想要编辑或者不使用默认键，如果您想要跨多个页面共享相同的缓存数据，您可能不想使用默认对象。这些属性可以很容易地用您选择的任何标识符替换。

##### 缓存您的数据库查询

您必须做的不仅仅是将数据库查询放入缓存代码块中进行缓存。您仍然必须明确标识您想要缓存的信息，为此我们使用了`cache_variable()`函数。

`cache_variable()`函数接受一个参数:想要缓存的变量的名称。它可以这样使用:

```
cache_variable("variablename"); // the variable $variablename    

has been cached
```

当然，这需要放在缓存代码块中。

从技术上讲，这是该脚本运行所需的所有信息。然而，由于你们中的一些人可能在从缓存单个变量到缓存多个查询结果的过程中遇到了问题，我想分享一下我的特殊方法。

缓存返回一行的数据库查询非常简单——您可以简单地单独缓存每个字段——但是当您的数据库返回多行时就变得复杂了。当然，您不希望独立缓存 100 行结果集中的每个变量吧？为了缓存包含多行的结果，我们使用了数组——特别是两个奇妙的函数`array_push()`和`array_walk()`。

假设您有一个文章驱动的站点，并希望缓存所有不同作者的列表，以及他们的电子邮件和您用作主键的任何内容(我们只说 id)。要缓存这样的查询，您可以这样做:

```
$result_authors = mysql_query("SELECT first_name, last_name, email, id    

FROM authors ORDER BY last_name", $db);   

if (!$result_authors) {   

  echo("<p>Error performing author query: " . mysql_error() . "</p>");     

  exit();   

} // run the query and do error checking   

$authors = array(); // create the array   

// extract the query data into array $main   

while ($main = mysql_fetch_array($result_authors)){    

  // use array push to insert a result set row into our array   

  array_push($authors, $main);    

}   

cache_variable("authors"); // cache your array   

mysql_free_result($result_authors);
```

其中大部分你应该很熟悉。如果你需要一些关于如何使用 PHP 进行数据库查询的帮助，我建议你阅读 Kevin Yank 的[系列文章](http://www.webmasterbase.com/article/228)，其中详细介绍了这个主题。

我要解释的是`array_push()`函数。这个函数有两个参数，第一个是您希望使用的数组的名称，第二个是您希望放入数组的数据。该函数真正做的只是获取数据，并将其放入数组中的下一行。我所做的是将每个结果行推入我们的`$authors`数组，由于所有的数据库信息都包含在一个变量中——我们的数组——我们可以使用`cache_variable()`函数轻松地缓存它。

现在我们来看我提到的第二个数组函数，`array_walk()`。虽然`array_push()`非常适合一次在数组中插入一行，但是`array_walk()`非常适合一次在数组中的一行上运行函数。

要从缓存数组中提取数据，您需要在您希望数据出现在页面上的地方使用`array_walk()`:

```
if($authors){ // if the array exists   

print("<p><h2>Authors</h2>");   

// array walk the array $authors through the function print_authors();   

array_walk($authors, 'print_authors');    

print("</p>");   

}
```

`array_walk()`函数也接受两个参数，第一个是您希望使用的数组，第二个是您希望将数组的每个元素传递给的函数。同样，如上所述，如果您知道`$authors`将一直存在并包含一个数组，那么这里的“if 语句”完全是可选的。在这种情况下包含它是因为如果确实没有作者,“Authors”标题可能看起来很傻(要么是因为数据库中没有作者，要么是因为缓存丢失或损坏)。

在上面的例子中，我使用了函数`print_authors()`。这是一个用户定义的函数，你应该在你的 PHP 脚本中定义它。有些人喜欢将他们所有的函数放在一个单独的文件中，然后将它包含在内，如果您要在多个页面上使用同一个函数，这是一个很好的解决方案。否则，PHP 脚本的顶部是定义函数的好地方。

在这个特定示例中，函数可能如下所示:

```
function print_authors($authors){    

// extract  the data from our array    

$first_name = $authors["first_name"];    

$last_name = $authors["last_name"];    

$email = $authors["email"];    

$id = $authors["id"];    

// print the author's information    

  print("<li><a href = "mailto:$email">$id: $last_name,     

$first_name</a><br/>");    

}
```

上面函数里的东西大家应该都很熟悉。这里，我们简单地从上面制作的数组中取出数据库信息。

##### 落实！

如果您还没有开始，那么您现在应该能够在您的站点上实现这个脚本了。如果您参考我上面概述的例子，它应该向您展示启动和运行这个系统所需的所有代码。如果你碰巧有任何问题，尽管来 SitePoint 论坛，不要害怕寻求帮助。

## 分享这篇文章