# Rails 开发者的 DDD。第 1 部分:分层架构。

> 原文:[https://www . site point . com/DDD-for-rails-developers-part-1-layered-architecture/](https://www.sitepoint.com/ddd-for-rails-developers-part-1-layered-architecture/)

## 什么是 DDD

在开发软件的过程中，你需要处理各种各样的复杂性，不同种类的应用程序会有不同的问题需要你去解决。如果你正在构建下一个 Twitter，可伸缩性和容错性可能是你要解决的问题。另一方面，在处理企业应用程序时，这些问题几乎从来都不是问题。复杂领域是您在开发企业软件时要解决的问题。许多公司的业务流程远非微不足道。因此，提炼提供松散耦合并在未来具有灵活性和可维护性的领域是极其困难的，需要大量的实践和知识。

### 这本书

Eric Evans——*领域驱动设计*的作者——创造了一套帮助解决领域复杂性的实践和术语。他的书是每个从事企业应用的开发人员的必读之作，我强烈推荐这本书。

### DDD 和铁路

我越来越多地在大型 rails 应用程序上工作，我注意到 DDD 和 Rails 在许多方面相互矛盾。因此，我决定写一个简短的系列文章，这将是我试图调和两种范式，并找到一种使用 DDD 而不与 Rails 对抗的方法。

在开始之前，我想提一下，我将写一篇关于将 DDD 概念引入现有应用程序的文章。因此，尽管 Bob 叔叔的方法([查看这篇精彩的演讲](http://confreaks.com/videos/759-rubymidwest2011-keynote-architecture-the-lost-years))可能看起来很吸引人，但将它引入到一个现有的具有数十万行代码的 Rails 应用程序中可能是我最不想做的事情。因此，在某种程度上，我在这里要写的一切都是一种妥协。

## 分层架构

领域驱动设计的核心概念之一是分层架构。让我们看看它是什么，它带来了什么样的好处，以及一个典型的 Rails 应用程序是如何违反这个基本概念的。

首先，术语“分层架构”意味着您将应用程序划分为多个层:

*   用户界面。负责向用户显示信息并处理用户的输入。
*   应用层。这一层应该很薄，不应该包含任何域逻辑。它可以具有对业务有价值的功能，但不是特定于“领域”的。这包括生成报告、发送电子邮件通知等。
*   领域层。负责描述业务流程。抽象的领域概念(包括实体、业务规则)必须包含在这一层中。相比之下，持久性、消息发送不属于这里。
*   基础设施层。负责持久性、消息传递、电子邮件发送等。

这种架构背后最重要的思想是，每一层都应该只依赖于它下面的层。因此，所有的依赖关系都具有相同的方向。例如，领域层可能依赖于一些基础设施，而不是相反。

## 分层架构和 Rails

现在让我们来看看我在典型的 Rails 应用程序中看到的最常见的违反分层架构的情况:

*   域对象将自己序列化成 JSON 或 XML。在我看来，将一个对象表示为一段 html 和表示为一段 JSON 没有太大的区别。两者都是外部系统使用的，都是 UI 层的一部分。所以每次你覆盖了`as_json`方法，你就违背了分层架构的核心思想——你改变了层与层之间依赖关系的方向。您的域对象开始意识到 UI。
*   控制器包含大量的业务逻辑。通常，它是对领域层的一些调用，然后使用底层方法如`update_attributes`来持久化更改。所以下次你去调用控制器内部的`update_attributes`时，停下来再想一想:很可能你做错了。谢天谢地，大多数 Rails 开发者已经意识到这种控制器很难维护。我相信，这样做是没有借口的——即使是小应用程序。
*   域对象执行各种与基础设施相关的任务。作为一个社区，我们同意不写胖控制器，但我们遇到了另一个问题——“瑞士军刀”领域对象。这样的对象，除了描述业务，还可以连接到远程服务，生成 pdf 或发送电子邮件。如果您遇到这样一个对象，那么它至少需要分成两部分:一部分负责领域知识，另一部分负责执行与基础设施相关的任务。
*   域对象太了解数据库了。如果从 ActiveRecord 扩展域对象，就将域层耦合到了基础设施层。您的域对象同时扮演两个角色。这种耦合使得它们几乎不可能单独测试。

这些问题大部分都是可以解决的。让我们看看所有这些方法，看看可以做些什么。

### 为 JSON 序列化创建一个单独的类

你不应该在你的域类中覆盖`as_json`或者其他类似的方法。请记住，领域层的职责是反映业务概念。我没有从事过 JSON 是一个重要概念的领域。因此，如果您没有编写 JSON 解析器，请将所有与 JSON 相关的内容移出您的领域。

想象一个控制器有一个如下所示的动作: