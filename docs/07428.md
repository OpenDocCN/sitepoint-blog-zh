# 圣诞节销售后端是如何构建的

> 原文：<https://www.sitepoint.com/how-the-xmas-sales-backend-was-built/>

尽管 2012 年 site point 圣诞特卖的大部分乐趣都发生在前端，我们仍然需要后端服务数据。它没有发挥巨大的作用，但它仍然是一个重要的作用。

在开始开发 it 之前，我们讨论了这个角色应该是什么样的，并提出了以下要求:

*   以 JSON 格式提供销售数据(交易信息)和故事数据(图像和动画)
*   每天的数据需要不同:每天不仅包含当天的数据，还包含前几天的数据(有一些小的修改，比如禁止销售)
*   管理界面编辑销售和交换他们容易，如果需要的话

特别是最后一项任务，如果必须从头开始编写，将需要大量的工作，所以我们决定使用一个**框架**。在我们的例子中，当我们使用 PHP 时，我们选择了 [Symfony2](http://symfony.com) 。

下面将描述基本设置如何工作以及使用 Symfony2 的一些优点。

## 设置

Symfony2 是一个基于许多连接在一起的组件的 MVC 框架。这些组件由 [composer](http://getcomposer.com) 管理，这是一个 PHP 的**依赖管理器**。使用 composer，只需要几个命令行就可以让 Symfony2 运行起来。

一旦框架准备好使用，我通常从定义实体开始(MVC 的*模型*部分)。通常这意味着要编写大量样板代码(所有数据库字段都有 getter/setter 的类)，但是 Symfony2 提供了方便的 CLI 命令来生成实体。这不仅不容易出错，而且速度更快。

## 管理界面

第二个乏味的任务是编写一个带有表单的管理界面来创建和编辑实体。幸运的是，Symfony2 允许我们用另一个命令自动创建一个 **CRUD** (创建/读取/更新/删除)接口。为了让东西看起来更好用，我用 **Twitter 引导**设计了界面。

经过一些调整，如添加验证和列表排序，我们得到了一个已经相当可用的管理界面。准备向客户端提供内容！

## 服务 JSON

当然，静态存储销售和故事数据是可能的，但是您也可以在源代码中先睹为快:)。因此，我们决定从后端提供当天所需的 JSON。

对于每个请求，我们的 Symfony2 应用程序都会获取当天的信息，并根据这些信息来决定应该将哪些销售和故事的哪一部分发送给客户。这很容易实现，方法是查询数据库，将检索到的数据组装成一个数组，通过 json_encode 运行它，然后将其发送回客户端。完成了。

## 贮藏

实际上，每次有请求时都执行这个过程是对资源的巨大浪费。每天对所有客户端的响应都是一样的。在任何给定的一天，只需要生成一次响应，将其存储在**缓存**中，然后在这一天的剩余时间里重用它。

缓存很棒，但是缓存失效是计算机科学中最难的两件事情之一。Symfony2 带有一个内置的缓存机制(模仿 HTTP 缓存规范)，这使得它更容易处理。

首先，我们需要选择使用哪种失效模型。有两种可能的模式:**到期**和**验证**。

过期是比较容易的方法，如果可能的话，应该总是首选。开发人员定义资源的有效时间，如果请求超过该时间，就会生成一个新的缓存。不幸的是，这对我们不起作用，因为我们不知道第一个请求是什么时候发出的，所以我们不知道缓存应该有效多长时间。我们需要使用第二种模型。

使用验证模型时，您只需计算足够的数据来查看缓存中的数据是否仍然有效。如果是，则服务缓存；如果没有，重新生成它。然而，与第一种模式相反，这一过程意味着您必须启动应用程序并检索一些数据，以确定缓存是否仍然有效。幸运的是，在我们的例子中，我们需要查看缓存是否仍然有效的信息只是当天的信息，这当然不是很复杂。

现在，在生成缓存时，我们将最后修改的值设置为当天。然后，在每个后续请求中，我们将缓存的最后修改值与当天进行比较。如果它们匹配，我们提供缓存的响应。有了这段代码，我们每天只访问数据库一次(而不是每次请求都访问！).

## 测试

当然，我们希望确保我们的代码能够正常工作，并且每天在销售开始前，JSON 中都会有正确的信息。我们绝对不想坐在我们的电脑前焦虑地看着时钟指针经过墨尔本时间下午 12 点，并重新加载页面，看看新的销售是否得到了正确的服务…

对于这个任务，我们使用**功能测试**。功能测试与**单元测试**非常相似，但它们的重点是测试应用程序的输出是否正确。每个测试都模拟一个 HTTP 请求，并允许开发人员对返回的响应运行各种断言。这在 Symfony2 中非常简单，因为框架是围绕 HTTP 的[请求-响应模型](http://en.wikipedia.org/wiki/Request-response)建模的，所以模拟请求非常容易。

在我们的用例中，我决定创建额外的路线(内部可访问)，允许开发人员在期望的一天通过。然后，响应将是公共可访问路由的响应在实际一天被请求时的样子。在我们的测试中，我们调用这些路由并检查返回的 JSON 是否包含我们期望的信息。通过这种设置，我们能够提前模拟完整的圣诞销售，并检查所有数据是否完全符合预期——让我们完全放心地开始销售。

## 分享这篇文章