# 在您的 Flash 预加载程序中显示下载状态

> 原文:[https://www.sitepoint.com/status-flash-preloader/](https://www.sitepoint.com/status-flash-preloader/)

我们都听说过这种宣传，但你我都知道 Flash 是一个强大的工具，不一定会让用户感到厌烦(是的，*甚至是*那些拨号上网的用户)。

你可以花很多时间来完善你的网站和电影，让你的访客更享受 Flash 的体验。例如，您可以在下载文件时向用户显示“正在加载”的图形，并对电影进行编程，使其仅在完全加载后才开始播放，从而帮助平滑播放 Flash 电影。

然而，这些技术可能会让你的访问者疑惑“这要花多长时间？”更糟糕的是，他们可能会在下载完成前就放弃你的下载，更别说开始播放了。

解决办法？随时通知你的访客！

使用反馈机制通知用户下载进度。通过你的 Flash 预加载器提供反馈会让你的访问者更加开心，并降低放弃下载的风险。

您向用户提供的反馈可以是数字的、可视的和/或显示以下任何内容:

*   装载百分比
*   加载的字节数
*   剩余百分比
*   剩余字节数
*   估计剩余时间

…或以上各项的任意组合。让我们看看它是怎么做的。

##### 基本机制

完成后，我们的预加载程序将执行以下程序:

1.  电影开始了。停止主时间轴并显示预加载器。
2.  计算并显示文件加载状态。
3.  如果电影仍在加载，返回步骤 2，否则
4.  继续播放主时间轴。

首先，我们需要在你的电影开始处有一个空白帧(在主时间轴上)。在舞台上有其他东西之前插入这个。

我还为预加载器添加了一层，因为我想这样做——这将有助于保持电影的组织性。

使预载层的第一帧成为关键帧:单击它并按下 F6，或从菜单中选择“插入”>“关键帧”。

![1119_pic1](../Images/088e4cbf0d7420d0addba8114b51da96.png)

现在，让我们创建我们的预加载器电影剪辑。

从“插入”菜单中选择“新符号…”。将其命名为逻辑名称，并确保它是一个电影剪辑，然后单击“确定”。

![1119_pic2](../Images/78770bad2b29c3f9ecb5fc4ce25fc42e.png)

现在，您将看到新剪辑的空白舞台和时间线。在这里添加一个新层。我们的预加载器总共只需要两层:一层用于动作脚本，一层用于图形。

##### 剧本

这是有趣的部分！我们新的“预加载器”剪辑将有 3 帧长，其中每个都将包含 actionScript。

现在，要向任何特定的帧添加代码，它必须是关键帧。所以，添加一个新层，点击第二帧，并从菜单中选择“插入>关键帧”(或按下 F6)。点击第三帧，并使其成为关键帧。对于电影的第一帧，我们不需要这样做，因为默认情况下，第一帧总是一个关键帧。

![1119_pic3](../Images/4dedb27502e4801b1e86ee409e8df4fe.png)

好的。现在，让我们一步一步地了解这个过程，看看我们需要做些什么来实现每一步

**第一步。电影开始了。停止主时间轴并显示预加载器。**

在 actionScript 图层中，单击第一帧。如果尚未打开，请打开“操作”窗口(您可以在“窗口”菜单下找到它)。

“操作”窗口有两种模式，“普通”和“专家”。为了让我们能够直接在窗口中键入代码，它需要处于“专家”模式。要更改模式，请单击窗口右上角的箭头，并从下拉列表中选择“专家模式”。

“操作”窗口将为空。在 actionScript 窗口中输入以下内容:

```
_parent.stop();
```

这就是框架 1 的全部内容(简单，但有效！).让我们看看这段代码做了什么…

我们使用'`stop()`'动作，因为我们想停止主时间轴。但是，因为我们在预加载器电影剪辑中，所以只调用'【T1]'将停止预加载器的时间轴(而主时间轴愉快地继续播放)。

我们需要做的是向主时间轴发送“停止”消息。请注意“.”(点/句号或句号)。在时间轴和电影剪辑之间传递信息的最佳方式是使用这种“点语法”。它是这样工作的:

```
target.message
```

(或者`target.property`，我们稍后会看到)

在我们的例子中，' _parent '是目标(父对象是包含引用剪辑的对象)。

所以，`_parent.stop();`发送我们所在的时间线(即主时间线)，‘stop()’命令。

**第二步。预加载器计算并显示加载状态。**

我们如何计算这些值？

为了计算加载进度，我们需要使用两个主要函数:

1.  `getBytesLoaded()`
2.  `getBytesTotal()`

这两个函数都返回以下数值:

1.  已下载的字节数(在当前电影中)
2.  总字节数(在当前电影中)

同样，我们将使用“T0”来定位主时间轴，因为“T1”和“T2”是整个“主”电影的属性。

就我个人而言，我不太喜欢字节，它们很小，很滑，而且总是有很多(移动相当快)。

为了向我们的访问者显示一些更友好的东西，我将把它们转换为千字节，这是我们通常在等待数据传输和下载时看到的值。

一千字节有 1024 个字节，因此，单击第 2 帧，在 actionScript 窗口中输入以下代码行…

```
kBytesLoaded = _parent.getBytesLoaded()/1024;  

kBytesTotal = _parent.getBytesTotal()/1024;
```

有了这些信息，我们可以计算一些更令人兴奋的值…

```
kBytesRemaining = kBytesTotal - kBytesLoaded;  

percentLoaded = 100 * kBytesLoaded / kBytesTotal;  

percentRemaining = 100 - percentLoaded;
```

也输入这几行代码。

![1119_pic4](../Images/881b41165b659ada253d9b82614885d2.png)

好了，暂时说够了，让我们看看第 3 步。

**第三步。如果仍在加载，返回步骤 2，否则继续播放主时间轴。**

在时间轴中，单击 actionScript 层的第三帧。同样,“操作”窗口是空的。

现在我们的过程说，“如果电影仍然在加载，返回到步骤 2”——帧 2，我们的信息将被再次计算。

嗯，“如果还在加载”…好吧，我们已经从第一帧的计算中得到了一些有用的信息，不如这样:

```
if (percentLoaded < 100){  

  gotoAndPlay(2);  

}
```

也就是说，如果括号(`percentLoaded` < 100)中的内容为真，那么就做花括号`{gotoAndPlay(2);}`中的内容

那看起来相当不错…

但是我不喜欢！计算机正在尽最大努力执行所有的计算，它做得相当好，但有时，不是达到 100%，你可能实际上达到 99.999999999%。

这个值会让访问者卡在加载器中，直到计算机判定 99.9999999999 不小于 100，我个人认为这不会发生。

因此，让我们将代码改为:

```
if (percentLoaded < 99){  

  gotoAndPlay(2);  

}
```

…否则继续播放主时间轴。

再次修改代码，使其看起来像这样:

```
if (percentLoaded < 99){  

  gotoAndPlay(2);  

} else {  

  _parent.play();  

  stop();  

}
```

这里，

“`_parent.play()`”向主时间轴发送“`play`”命令，我们之前使用“`_parent.stop();`”停止了它

`stop();`'将停止当前(预加载器)时间线

我们完事了。(看，我告诉过你这是有趣的部分)

##### 测试一下

在我们尝试之前，我们显然需要在电影中有我们的预加载程序(而不仅仅是在目前的库中)。

因此，转到主时间轴，单击第一帧，并将我们的“预加载器”电影剪辑从库中拖到舞台上。如果找不到该库，请从“窗口”菜单中选择它。

![1119_pic5](../Images/785229689e77c4bfc5f1537afbae52ff.png)

注意，如果你从一个空白电影开始，你现在需要给它添加一些内容，否则我们无法判断预加载器是否工作。导入图像或其他会增加影片文件大小的内容，并将其放在主时间轴中的第 2 帧(或稍后的某帧)上。

好，测试你的电影，并确保在预览运行时打开“显示流”(在“视图”菜单下)。它应该在第 1 帧等待，直到加载完成，然后继续播放。

太棒了。

“嗯，是的，但是舞台上什么都没有，”你在想。“我以为这都是关于反馈的？”

好吧，好吧，我要开始了！

##### 提供反馈

以下所有更改必须在“预加载器”电影剪辑中进行，因此如果您还没有，请双击库中的“预加载器”。

在我们直观地展示预加载器的进度之前，让我们从显示一个数字百分比加载指示器开始。

单击图形层，并在舞台中央绘制一个文本框。在“文本选项”面板中，选择“动态文本”并键入“进度”作为变量的名称。

在 FlashMX 中，单击“字符…”按钮并选择“仅”，然后选择“数字”并在“和这些字符”字段中键入“%”。

如果您使用的是 Flash5，在字体嵌入选项下，单击标记为“123”的按钮，并在右侧的字段中键入一个百分号(%)。

这将只嵌入数字字符和“%”的轮廓。通过仅嵌入一些字符，我们减少了字体定义的字节大小，并最小化了字体加载时的任何潜在延迟。

请注意，如果您希望完全避免字体加载，请选择系统字体，不要选择任何嵌入选项。这将导致电影使用用户系统上的字体，而不需要下载轮廓。但是请注意，您将失去对某些显示属性的控制。系统字体不能旋转、倾斜、不成比例地缩放或应用 alpha 值。

这就是我们在舞台上所需要的，但是如果你现在测试你的电影，你仍然不会看到任何东西！

我们要做的是从我们在第 2 帧的计算中获取一条消息，并放入我们刚刚创建的动态文本字段中。

单击 actionScript 层中的第 2 帧，如果您已经关闭了它，请再次打开动作窗口。

我们现在要做的是设置变量“progress”(我们的动态文本字段)，以显示类似“75%”的内容。嗯，实际上不是 75，而是由“percentRemaining”代码计算的值，它将随着电影在第 1 帧的循环而重复更新。

在现有代码之后，输入以下内容…

```
progress = percentRemaining add '%';
```

![1119_pic6](../Images/4e41b5103cce3bbe43eeba355b9a8f6b.png)

这将在“剩余百分比”的末尾添加一个“%”字符，并将结果放入“进度”文本字段。

现在再测试一次！

很可能你不喜欢它。我也不知道。我们输入的代码将显示像 27.56793256432%这样的数字。事实上，因为我们没有在字符中嵌入小数点，它可能会显示像 27568793256432%这样的数字，这很傻。

尽管我们要去掉所有这些数字，但还是回到字符嵌入选项，在带“%”的字段中添加一个句号/句号/小数点(或任何您喜欢的名称)。你以后可能会想要它。

现在，我们需要砍掉数字末尾的所有小数位。有一个很简单的方法可以做到。

Flash 包含了一大堆数学相关的函数，其中一个就是'`floor()`'。

给 floor 函数一个数字，它会找到紧接在它下面的整数(整数)。这正是我们想要的！' 87.56793256432 '变成了' 87 '。

所以，把最后一行改成…

```
progress = Math.floor(percentRemaining) add '%';
```

再测试一遍…漂亮！

好的，这是剩余的加载百分比，但是你可能想要别的东西，并且，很有可能，它也一样简单。

那些诸如“加载了 200 千字节中的 125 个”之类的消息呢

这条消息有点长，但还是让我们做吧——它会给那些等待的用户一些东西来读。

```
progress = Math.floor(kBytesLoaded) add ' of '    

add Math.floor(kBytesTotal) add ' kBytes loaded';
```

简单吧。

不要！等一下，我们刚刚添加了一大堆我们没有包括的字符，它们可能无法在没有安装您的字体的计算机上显示。点击“进度”文本字段，并在字体嵌入选项中添加“ofkByteslad”到字段中，以嵌入这些字符。

##### 获取图形

好了，短信发够了。你怎么做那些时髦的，进度指示加载栏？

嗯，真的很简单。

在文本字段下方的舞台上画一个实心矩形(或者任何您希望它出现的地方)。

使用选择工具，单击矩形的填充(这将选择填充，但不是笔画)。我将只缩放填充，留下笔画作为总尺寸的指示器。

将所选填充转换为符号(菜单:“插入”>“转换为符号…”或按 F8)。将出现符号属性对话框。输入符号名称，然后单击“确定”。

![1119_pic7](../Images/7b02626d91fcd2a3241ff9b399a45a0e.png)

请注意，如果您使用的是 FlashMX，则必须在小网格的左侧选择一个注册点选项。如果您使用的是 Flash5，我们需要马上修复其他内容。

现在，当您在舞台上创建或放置一个 movieClip 时，您可能已经注意到您可以给它一个“实例”名称(这在 MX 的“属性”面板上，在 5 的“实例”面板上)。此名称允许 actionScript 识别剪辑，并且可以检查和控制各种剪辑属性。

在“属性”/“实例”(FlashMX / Flash5)面板上，输入“loadBar”作为实例名称。

正如我们使用计算的变量来设置文本字段中的文本一样，我们现在将使用它们来设置'`loadBar`'的比例。

为了帮助您将它们与函数和变量区分开来，属性名以下划线字符'`_`'开头。

我们将设置的属性是'`_xScale`'。还有一个'`_width`'属性，但它们略有不同。`_width`以像素为单位设置剪辑的实际宽度，而`_xScale`以剪辑的定义大小的百分比来设置宽度。

```
_xScale is the best choice in this case, as we've just defined the clip at a size that fits perfectly into the stroke we left on the stage (when it has a scale of 100%). Our 'percentLoaded' value also ranges from 0% to 100%, so they should be very happy together.请注意，您也可以使用 width 属性，但是，除非您想要从 0 到 100 像素的宽度缩放，否则会涉及到稍微多一点的数学问题。在这种情况下，`xScale`比较容易。

现在，要设置 movieClip 的属性，我们必须告诉 Flash 我们在谈论哪部电影。这是我们之前输入的实例名(`loadBar`)。这是它看起来的样子...

```
loadBar._xScale = percentLoaded;
```

又是点语法，但这次我们用它来设置属性，而不是调用函数。
继续将其添加到第 2 帧的脚本中。现在看来...

```
kBytesLoaded = _parent.getBytesLoaded()/1024;    

kBytesTotal = _parent.getBytesTotal()/1024;    

kBytesRemaining - kBytesTotal - kBytesLoaded;    

percentLoaded = 100 * kBytesLoaded / kBytesTotal;    

percentRemaining = 100 - percentLoaded;    

progress = Math.floor(kBytesLoaded) add ' of '     

add Math.floor(kBytesTotal) add 'kBytes loaded';    

loadBar._xScale = percentLoaded;
```

 <q>** Flash 5 注** 
当你测试你的电影时，它可能不会完全按照你的预期出现。loadBar 不是从显示器的一侧向另一侧增长，而是从中心向外增长。这是因为剪辑的缩放是基于其“注册点”的。</q>
选择 loadBar 符号，您会在中间看到一个十字。这是注册点。
让我们将注册点移动到矩形的左边。这将使缩放剪辑向右延伸。
双击剪贴画进入编辑模式，单击一次矩形将其选中。
在“信息”面板(菜单，窗口>面板>信息)中，形状相对于剪辑注册点的位置显示在标记为 X 和 y 的字段中。旁边是一组小框，一些是灰色的，一个是白色的，一个是黑色的。在这里，您可以设置 X，Y 值是相对于形状的中心，还是相对于左上角。在下图中，X，Y 值相对于中心为 0.0。
![1119_pic8](../Images/c6f23ae1df7463362676f23b58ed8648.png)
单击角框，注意 X，Y 值发生了变化。在 X 值中输入 0(零)，然后按 tab 键进行设置。舞台上的矩形跳到右边，使其左边缘与注册点对齐。
这很好，但是有点烦人的是我们的夹子现在在错误的位置。
通过单击窗口左上角的“场景 1”链接(就在时间轴上方)退出剪辑编辑。点按剪辑并将其拖回左侧，使其再次适合笔画。
再次测试电影，你会看到一个更“传统”的进度条。
您可能已经注意到，在有任何移动之前，该条非常短暂地显示为 100%宽度。这是因为，在它有机会在帧 1 中进行任何计算之前，该条被显示为它被放置在时间轴上。但是有一个简单的解决方法！选择剪辑，然后在“信息”面板的“宽度”字段中输入 1。按 tab 键进行设置。
再次测试电影...修好了！

##### 多一点

一开始，我说过我们可以使用的一个可能的反馈显示是估计的剩余时间。它只需要多一点代码，所以让我们开始吧。

Flash 中另一个方便的函数是'`getTimer()`'，它返回电影开始后的毫秒数。正如我对字节不感兴趣一样，我也不喜欢毫秒。我将使用(`getTimer()` /1000)，它将以秒为单位给出值。

在 frame 2 代码中，让我们计算每秒的千字节数——如果您愿意，也可以显示出来。

```
kBytesSec = kBytesLoaded/(getTimer()/1000);
```

就是这么简单:载入的千字节数，除以花费的秒数。

现在，剩下的时间:

```
timeRemaining = kBytesRemaining / kBytesSec;
```

另一个简单的。我们将剩余量除以新计算的下载速度。

所以我们的展示信息可能是...

```
progress = Math.floor(timeRemaining) add " seconds remaining";
```

嘿，太酷了！现在你的访客知道在电影开始前是否真的有足够的时间烧开水。

所以，不要让你的访问者闲得无聊，咬牙切齿，甚至完全放弃下载。告诉他们发生了什么——就这么简单！让他们了解情况，让他们开心。

而这仅仅是开始。你能做的还有很多。查看您可以访问的其他 movieClip 属性，使用旋转或位置值，进入其中并四处乱逛，享受一些乐趣！

##### 问题、解决方法和其他细节

我们在这里建立的预加载器将适用于大多数 Flash 电影。但是，在某些情况下，它可能不会像您希望的那样运行。

 ***载入子电影*** 

`getBytesLoaded`和`getBytesTotal`返回的值只适用于主电影。
如果你正在将电影和声音加载到你的主电影中，这些字节不会被预加载程序计算在内，只要主电影被加载，它就会继续，而不管任何仍在加载的外部文件。

如果你有一个子电影被加载到级别 1，并希望它和主电影一样被预加载，你可以按照下面的方式做一些事情...

```
kBytesLoaded = (_parent.getBytesLoaded() +      

_level1.getBytesLoaded()) / 1024;     

kBytesTotal = (_parent.getBytesTotal () +     

 _level1.getBytesTotal ()) / 1024;
```

 ***关联资产*** 

当影片的库包含具有链接的项目时，链接的对象以及它们所依赖的任何对象都将在第一帧中导出(这在 MX 中可以避免，见下文)。

由于 Flash 在加载之前不会显示一个帧，这可能会在加载电影时产生“停滞”效果(因为第一个帧显然会变得很大)。

使用'`attachSound()`'和'`attachMovie()`'的文件有链接的资产。链接在闪存组件中也很常见。

Flash MX 引入了一种链接资源的方法，这种方法不会将资源放在电影的第 1 帧中。默认情况下，链接的资源仍被写入第一帧，但这是可以避免的。

取消选中链接资产的“在第一帧中导出”选项。这样做将阻止项目被导出，除非它被手动放置在舞台上。然后，你需要手动将该项目放置在一个框架中，在预加载器的之后的*和调用附加功能的任何 actionScript 的*之前的*。*

您可能不希望手动放置这些项目，这也是您首先使用附加功能的原因，因此您可能希望将它们放置在屏幕外的某个地方，或者放置在永远不会播放的帧上。

这可能会有点费力(特别是如果您使用组件的话)，因为这些组件通常有许多导出的子元素，您还必须调整和手动重新定位这些子元素。

 ***资源和链接*** 

有问题吗？这里有一些链接可以减轻你的麻烦。

ActionScript.org Flash 社区论坛，电影，教程。
[http://www.actionscripts.org](http://www.actionscripts.org)

资产移交。将链接的资源移动到指定帧的工具。
[http://www.flexidev.com](http://www.flexidev.com)

Flashcoders/Flashnewbie(以及其他列表)。一些很棒的邮件列表。Flashcoders 列表上的东西可能会变得非常顽固(并且会填满你的收件箱。你可能想订阅文摘！).
[http://chattyfig.figleaf.com](http://chattyfig.figleaf.com)

闪光灯套件。Flash 社区站点、论坛、教程、电影。适合所有人的东西，从设计师到代码爱好者。
[http://www.flashkit.com](http://www.flashkit.com)

尼夫的网页游戏。完全跑题，但是当你需要消磨时间的时候，这个网站有一些用 Flash 重新制作的经典游戏(完全免费下载。fla 的和所有的)。嘿，等一下，不要分心-先做好你的预装！
[http://www.neave.com/webgames/](http://www.neave.com/webgames/)

在我的桌子上，除了其他书籍之外，还有 Colin Moock 的《Flash MX 的 ActionScript 权威指南—第二版》。超过一千页的动作脚本信息。这不是一本真正的教程/操作指南，但却是一本非常可靠的参考资料。

## 分享这篇文章

```