# 社交网络认证:合并帐户

> 原文：<https://www.sitepoint.com/social-network-authentication-merging-accounts/>

在这一部分中，我们将了解如何确保人们在通过不同方式登录我们的应用程序后不会有多个帐户。

## 合并帐户

如果你允许用户通过不同的社交网络或者你自己的注册系统注册，很有可能一些用户会有多个账户。对于一个早先通过脸书注册的用户来说，过一会儿再回来通过 Twitter 登录会有多烦人，因为他认为他用了那个 Twitter？我们可以通过让用户手动合并或者尝试使用自动系统来尝试和识别重复的用户来防止这种情况。

## 设置

我建议设置两个数据库表。第一个表是常规用户表，包含用户的所有信息。

```
CREATE TABLE IF NOT EXISTS `user` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `username` varchar(255) NOT NULL,
  `password` varchar(255) DEFAULT NULL,
  `firstname` varchar(50) NOT NULL,
  `lastname` varchar(50) NOT NULL,
  `emailaddress` varchar(50) NOT NULL,
  `city` varchar(50) NOT NULL,
  `birtdate` date NOT NULL,
  `gender` varchar(10) NOT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1 AUTO_INCREMENT=1 ;
```

*注意:*如您所见，我使用了我们在`SocialLoginInterface`中也使用过的字段。根据您的应用程序，您可能需要更多或更少的字段。如果你愿意，你甚至可以把这张桌子分成`user`和`user_profile`两张桌子。

第二个表包含关于用户使用的任何第三方登录的所有数据。

```
CREATE TABLE IF NOT EXISTS `user_provider` (
  `id` int(10) unsigned NOT NULL AUTO_INCREMENT,
  `user_id` int(11) COLLATE utf8_unicode_ci NOT NULL,
  `provider` varchar(50) COLLATE utf8_unicode_ci NOT NULL,
  `provider_uid` varchar(255) COLLATE utf8_unicode_ci NOT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB  DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci AUTO_INCREMENT=1 ;
```

在`provider`中，我们保存我们使用的提供商的名称，例如 Google+。在`provider_uid`列中，我们保存来自提供者的实际用户 ID。

## 手动合并用户帐户

让我们想象一个通过 Google+注册的用户。稍后，他回来并通过您的默认注册系统注册自己。登录后，他突然想起之前已经用 Google+登录过一次了。

根据上面的数据库方案，在`user`表中将有两条记录，在`user_provider`表中将有一条记录。合并这两个帐户的最佳方式是让用户将其他社交网络连接到他们的帐户。

在您的系统中获得授权后，您可以通过允许用户“登录”社交网络来实现这一点。但是，我们现在不叫它“登录”，而是叫它“连接”。

只需在您的应用程序中添加一个“连接”按钮，就可以像您可能在登录页面上所做的那样，从社交网络调用登录 URL。一旦回调 URL 被调用，您将检查来自社交网络的用户 id 是否已经在您的`user_provider`表中。

如果是这样，这意味着您找到了用户的不同帐户。在这种情况下，您基本上可以删除重复的帐户，并将`user_provider`记录与当前用户连接起来。

如果不是，那么就好像这个用户以前没有登录过那个社交网络。在这种情况下，您可以向`user_provider`添加一条记录。下次他通过这个社交网络登录时，他会立即被认出来。

*注意:*在合并两个账户之前，你可以先询问用户是否真的想这样做。也许用户拥有两个独立的账户是有原因的。接下来，不要忘记将重复用户添加的任何内容与当前用户合并，这样所有数据都与一个帐户相关联。

然而，也有可能用户通过 Google+登录，现在想要将其帐户与已经存在的帐户合并，该帐户是通过默认注册系统注册的。在这种情况下，您可以只要求用户填写用户名和密码。填写后，您可以检查在`user`表中是否有实际可用的组合，包含提供的用户名和密码。

## 自动合并用户帐户

除了让用户手动合并帐户，我们还可以尝试看看是否可以自动合并。这可以通过检查我们从社交网络取回的用户的简档和已经存在的用户来实现，就在与社交网络连接之后的时刻。

一个好的开始是检查电子邮件地址。电子邮件地址是一个不容易伪造的字段，并且非常独特。因此，当您从社交网络收到所有数据后，您可以检查您检索的电子邮件地址是否已经存在于数据库中。如果是这样的话，你好像找到匹配了。您可以更新现有用户，而不是创建一个全新的用户。

就这样？我希望它是。然而，并不是所有的社交网络都会回复电子邮件地址。例如，Twitter 不返回电子邮件地址，你也不能通过任何其他方式检索它。接下来，谁说我的 Google+邮箱地址和我在你的申请中使用的一样？最后，不能完全保证你合并了所有可能的账户。

因为我们不能保证存在实际的合并，所以我们可以添加第二个级别来检查用户配置文件。正如你在上一篇文章中看到的，我们正在收集更多的数据，而不仅仅是电子邮件地址。我们可以执行的下一个检查是其他字段之间的任意组合。例如，只检查出生日期，会给你太多的可能性。然而，你找到两个姓氏和出生日期完全相同的人的几率有多大？或者你找到两个位置、名字和性别都一样的人的几率有多大？

基本上，组合是无穷无尽的。试着理性思考，并考虑到不是所有的社交网络都返回所有的数据。在之前的文章中，我们看到谷歌没有给你一个出生日期。

那么，基于这些细节，我们真的可以合并吗？**不！如果你这样做了，你就打开了一个潜在的安全漏洞。想象一下我在 Google+上模仿某人。通过登录到您的应用程序，我将能够控制我正在模拟的帐户。为了防止这种情况发生，我们需要在登录和实际合并之间增加一个步骤:验证。**

每当用户通过 Google+登录，并且您的系统在您的数据库中找到可能的匹配时，请用户进行验证。最简单的方法是告诉用户你找到了一个可能已经存在的账户。接下来，允许这个用户通过允许他的原始登录来验证是他。因此，如果现有帐户是通过您的默认注册系统创建的，请允许用户填写该帐户的密码。如果帐户是由不同的社交登录帐户创建的，则允许用户通过相同的方法再次登录。如果用户这样做了，并且您得到了一个肯定的验证结果，那么您就可以确定您得到了正确的用户。

最终，我们还是会有一些重复的账户。然而，我们至少试图将它保持在最低限度，通过尝试，我们也试图改善用户体验。

### 结论

通过这篇文章，我们到达了这个系列的结尾。希望这些文章能教你一些关于如何创建框架无关的包，如何用 Google+建立一个社交网站，以及如何合并账户。

一些后续文章将很快上线，向你展示如何用其他社交网络扩展这些文章。我期待你在下面的评论中的反馈。

## 分享这篇文章