# 如何放弃定期维护

> 原文：<https://www.sitepoint.com/ditch-scheduled-maintenance/>

*本文由[page duty](http://www.pagerduty.com/)赞助。感谢您对使 SitePoint 成为可能的赞助商的支持。*

定期网站维护是对服务进行有计划的维护，通常需要大量的时间和人力，以及停机时间。这在互联网上相当于把你的车送去调试。问题是，web apps 绝对不是汽车。

让我们面对现实:没有人喜欢定期维护——无论是客户还是开发人员。这很耗时，通常发生在周末，并且可能会花费公司的维护费用。例如，即使您在美国的周日晚上进行维护，在印度也是第二天的凌晨，因此这些用户会受到您的中断的影响。

网站管理员“安排”这样的维护任务，对网站进行重大修改。即使他们知道潜在的影响，他们这样做的唯一原因是为了避免他们的服务仍然工作时会面临的干扰。想象一下，一个汽车修理工试图在发动机还在运转的时候修理它。

幸运的是，现代发展方法意味着事情已经发生了变化。这篇文章将讨论如何放弃定期维护，并找到一种方法来实时修复 bug，而不影响任何一个用户！起初令人望而生畏，但通过适当的规划和执行策略，这是非常可以实现的。

## 持续部署—无需定期维护的世界

先从头说起，说说计划维修的目标。这通常是你对产品进行重大变更的时候——无论是解决 bug 还是添加特性。通常，您会在一次维护期间执行一系列更改，以充分利用停机时间。

另一个更好的方法很简单，就是实时改变。这称为持续部署。一旦你发现了一个 bug，你就把它分配给一个开发人员去解决。一旦错误被纠正，您就可以将它与您的主要代码库合并。这听起来很简单，但是还需要几个步骤。

## 维护临时服务器

许多组织维护一个带有虚拟数据库的临时服务器，虚拟数据库充当本地计算机和主服务器之间的链接。临时服务器的主要目的是测试最终用户如何看待这些更改。您将首先在临时服务器上预览更改，如果您对更改感到满意，您将使它们出现在主服务器上。

对临时服务器的访问必须受到限制，这可以通过将它托管在一个不常见的子域(而不是“staging.yoursite.com”)上来实现。

## 自动化测试

您应该确保一个适当的测试框架(包括单元测试和集成测试之类的测试)，在与主代码库合并之前，给定的修复应该通过该框架。这很重要，因为修复本身可能会引入新的错误，从而导致停机。在许多组织中，这种测试是自动化的——只有当您的代码通过了所有指定的测试时，它才会被合并到主服务器上。

这里的想法是确保您添加的任何代码都不会破坏某些东西。

## 连续累计

这种自动化测试在哪里进行？我们需要一个集中的服务器，在变更生效之前对代码进行测试。有许多开源解决方案，如 [Buildbot](http://buildbot.net/) 和云解决方案，如 [Travis CI](https://travis-ci.org/) 或 [Jenkins CI](https://jenkins-ci.org/) 执行这项自动化任务。

我确信你使用某种版本控制来管理你的源代码。在流行的版本控制系统 Git 中，您可以编写名为“钩子”的脚本，根据您的需求执行一系列任务。一旦测试通过，最常见的任务是将代码与主存储库合并。这里有一个关于使用 Git 钩子进行持续集成的详细教程。

## 无需停机即可管理对数据库模式的更改

一个真正吸引定期维护的问题是发布需要更改数据库模式的特性补丁。如何在不停机的情况下进行这样的发布？

事实证明，也有办法解决这个问题，尽管确实需要采取一些谨慎的步骤。您需要大致遵循以下步骤:

*   通过创建新表或添加新列(不删除旧表或列)来修改架构
*   修改您的应用程序，以读取旧数据并写入旧数据和新数据
*   通过将旧数据复制到新模式来迁移数据
*   修改您的应用程序，只读写新的模式

你应该谨慎行事。下面是[更详细的教程](http://www.slideshare.net/pascallouis/database-compatibility)。

## 实时警报和态势感知

即使您的部署系统是完美的，bug 仍然会悄悄进入。这些错误通常是最终用户首先遇到的。好心人会报告它，但你可能不会立即知道这个 bug。

因此，重要的是建立一个警报系统，让您在最终用户遇到错误时立即知道。理想情况下，这可以通过向您的开发人员的邮件列表发送电子邮件，或者指派某人使用 ChatOps 随时待命来完成。

拥有一个系统来获得基础架构的单一视图非常有帮助，因此您可以跟上并应对错误和停机。PagerDuty 是一个平台，让您的随叫随到的开发人员跟踪问题，提供详细的分析并与 New Relic、Crashalytics 和 AppDynamics 等应用程序集成。在事故期间，警报将通过电子邮件、电话、推送通知或通过与这些其他服务的集成发出。该服务具有连续路由和自动升级功能，以确保每个警报都得到应有的关注。

## 分阶段推出功能

到目前为止，我们主要讨论的是 bug。当涉及到发布新功能时，像脸书这样的公司会分批推出(比如新的时间轴或图形搜索)。这有助于修复新功能早期版本中的错误，而不会对服务造成太大影响。

除了修复 bug 之外，随着新功能流量的增加，您可以评估其性能，并做出必要的更改，使其达到最佳性能。

## 使用高可用性架构

您的用户(希望)遍布全球，您的应用程序全天都有流量。这使得正常运行时间非常重要。开发人员寻求高达 99.9999999%的正常运行时间，这意味着一年中不到一秒的停机时间。

有了这样的需求，就需要像[负载平衡](https://en.wikipedia.org/wiki/Load_balancing_%28computing%29)和[故障转移系统](https://en.wikipedia.org/wiki/Failover)这样的高可用性方法。除了在应用层应用这些原则之外，您可能还需要根据需要在数据库上执行[复制](https://en.wikipedia.org/wiki/Replication_%28computing%29)或[分片](https://en.wikipedia.org/wiki/Shard_%28database_architecture%29)。

## 最后的想法

在我们结束这篇文章之前，让我给你举几个公司的例子，这些公司不仅执行持续部署，而且鼓励其他人也这样做——[脸书](http://www.infoq.com/presentations/Facebook-Release-Process)、[谷歌](https://air.mozilla.org/continuous-delivery-at-google/)、 [LinkedIn](http://www.wired.com/2013/04/linkedin-software-revolution/) 和[page duty](http://www.pagerduty.com/)(这里的[是关于后者如何管理它的](https://www.pagerduty.com/blog/ditch-scheduled-maintenance/))。它只是向您展示了持续部署是未来的发展方向。

*您是如何摆脱定期维护的？你有什么让转变变得更容易的建议吗？*

## 分享这篇文章