# PHP 中的防御性编程

> 原文:[https://www.sitepoint.com/defensive-programming-in-php/](https://www.sitepoint.com/defensive-programming-in-php/)

[欺骗的动态否定法则](http://en.wikipedia.org/wiki/Finagle%27s_law) :
*任何可能出错的事情，都会在最糟糕的时刻发生。*

![Lightbulb with shield inside it](../Images/25d1a394b08b931fb848649d2785592e.png)

## “防御性编程”是什么意思？

简而言之，防御性编程是为了预测可能的故障点而进行的编程。目标是在这些可能的问题发生之前规避它们。你看到问题了，对吧？“期待意想不到的事情”这个建议本身就有一些困难，当一个人把它改成“期待意想不到的事情并试图阻止它”时，情况会变得更糟很多倍。

让我们看一些实际的例子。

## 条件语句

这是最容易进行防御性编程的地方之一，也是最容易自满的地方。在用 PHP 编程的许多情况下，你根本不需要“else”的情况。

假设，你正在处理一个函数，需要一个条件。此时，您的特定变量只有三种可能的状态，并且这些状态包含在这样的块中:

```
if($var == a){ }
else if($var == b){ }
else if($var == c){ }
```

你说没有其他的可能性，然后继续你的代码。让我打断你一下。我知道*你*知道没有其他可能性。我相信你。但有时(意想不到的)事情会发生。我们忘记了一些事情。我们检查错误。我们最终会重用一些超出其最初预期范围的代码。突然，我们有泄漏，有时无声的错误状态，因为这里没有捕捉。利用`else`块。利用`switch` es 中的`default`。使用它们来返回或记录错误，以便您知道发生了什么，如果它曾经发生过的话。这可能需要额外的几行代码，但是当发生了您没有预料到的事情时，这是值得的。

## 永远不要相信用户输入

你以前听过这种说法吗？大多数程序员都有。这是一个有点模糊，笼统的东西说，当然。但这是真的。你不应该相信用户的输入。这并不意味着你认为所有的用户都是疯狂的黑客，他们会用一组精心设计的命令来破坏你的应用程序。没必要疑神疑鬼。但是，你应该假设用户不知道你的代码。他们不知道你需要填充什么参数，也不知道输入可以有多长。他们不知道可以上传什么类型的文件(即使应用程序告诉他们)，也不知道文件的大小。偶尔，他们是一个机器人或黑客，他们会试图在他们的输入中运行脚本。有时甚至来自登录墙后面的输入。在用户到达输入表单之前，您如何知道何时可以信任诸如身份验证或验证码之类的东西来提供安全屏障呢？

答案是:永远不会。

如果你从不信任用户输入，那么你就永远不会违反*，因为*你信任用户输入。看到了吗？因此，请始终验证您的输入，并始终确保您在处理数据时使用了适当的技术，尤其是在将数据存储在数据库中或检索数据以供显示时。就此而言——根本不要相信输入，即使来自用户之外的地方——输入验证永远是你的朋友。查看[生存困境:PHP 安全](http://phpsecurity.readthedocs.org/en/latest/Input-Validation.html)并考虑使用[验证库](https://www.sitepoint.com/validating-your-data-with-respect-validation)。

## 关于代码的假设

不要假设*任何事情*。如果说前两个话题教会了我们什么，那就是我们不应该做任何假设。作为程序员，尤其是专注于一个项目太久的时候，我们开始假设很多。我们开始假设用户知道一些我们知道的事情。不一定是技术细节，而是关于程序的功能细节。我们假设用户知道文件有多大，因为…我们已经知道了这个事实。或者他们知道为了让邮件脚本…但是不，他们对此一无所知。这有时对前端工作来说更重要，但是显然你也在后端处理用户行为和用户输入，所以这是值得考虑的。

许多程序员所做的另一个惊人的假设是，我们的函数、类或者我们在任何给定时间工作的任何其他代码的明显性质的假设。防御性的程序员不仅会仔细考虑普通的文档和描述一点功能是做什么的，还会记录他们对输入、参数、用例或任何其他类似事情的假设。因为我们都是人，有时候会忘记后来的事情。总有一天，我们很可能会被维护、扩展或替换我们代码的人终结。如果没有别的，回想一下编程发生在一个充满技术变革的世界。如果您的应用程序在几年内仍然存在，它可能需要更新到 PHP 的新版本，并失去一些功能，或者它与之交互的任何数量的组件可能会发生变化，并需要更改您自己的代码。预测这些事情非常困难，所以好的注释和文档非常重要。

## 管状视

另一件可能导致我们忘记好的评论实践和标准的事情是狭隘的观点。隧道视野在程序员身上经常发生。你知道那种感觉。你在解决问题，你在最佳状态。你在自己的小世界里感到孤立，有音乐(或者没有音乐)，你只是在*编码*，突然，自从你上次检查时钟以来，两个小时过去了，你意识到你已经写了无数行代码，没有任何注释。我们每个人都或多或少会遇到这种情况，但重要的是，在某些时候，抓住这一点，并在适当的时候增加一些。

## 语法和命名的一致性

一致性是一个有点灰色的领域——更深入地研究编码标准之类的东西，但是它与防御性编程相关。在 PHP 中，有一些[标准](https://www.sitepoint.com/psr-1-and-psr-2-to-be-approved-as-standards/),你可以遵循这些标准来简化你的代码，以供其他人查看，或者供你自己将来使用。但是通常，没有人真的让你按照标准编码。然而，不管你是否按照某种标准编码，你至少应该内部一致——因为这将使你不容易出错。这尤其适用于小的语法错误，这些错误在被发现后需要很长时间才能恢复和修复。如果您总是使用相同的间距、相同的格式和语法、命名约定等。，那么你就不太可能犯错误，导致你对你自己的代码的误读。你也更有可能快速浏览并找到你需要找的东西。

## 结论

除了用户行为和动作，不要对你的程序做任何假设。假设是防御性程序员最大的敌人之一。不要假设您不需要默认 case 或 else 语句。不要因为假设不需要它们，就避免创建适当的用户错误消息、警报、日志和其他任何您需要的东西。你的假设通常是正确的——但我们不在乎这些。我们关心的是他们出错的次数。总是做好计划，就好像你可能需要在几个小时、几周、几个月甚至几年后回到你的代码，或者其他人会这样做——并相应地记录下来。不要认为它永远不需要更新、扩展或维护。这是天真的，在更多的情况下是疏忽。有时候，将防御性编程的想法保留在脑海中可以帮助您更有效、更安全地评估、计划和编程。

## 分享这篇文章