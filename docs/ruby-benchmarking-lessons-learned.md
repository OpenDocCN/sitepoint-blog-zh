# Ruby 基准测试的经验教训

> 原文：<https://www.sitepoint.com/ruby-benchmarking-lessons-learned/>

![Ruby Benchmarking lessons learned](img/9a92f783347491c9d72cfa953201d3d0.png)

大约一个月前，我完成了 Ruby Web 基准测试报告第一版，这是 Ruby 有史以来最全面的“Hello World”Web 应用基准测试。这是一项意义重大的任务。一路走来，我学到了一些关于理解性能、基准测试和 Ruby 的东西，这些都是我刚开始时不知道的。这些教训远远超出了我开始这个项目时所期望的。

## 你永远不会真正知道，直到你测试

让我感到惊讶的第一件事是，你永远不会真正知道你有什么样的性能，直到你对自己的代码运行自己的测试。这听起来很明显，但却是事实。

例如，我一直认为 Sinatra 是最快的 Ruby web 框架，但事实并非如此。事实上，虽然它比 Rails 快，但它远不如普通的老式 Rack 或框架快，感觉像 Sinatra，但性能更好，如 Cuba。

此外，我对 JRuby 的性能潜力感到惊讶。与标准的 Ruby 运行时 MRI 相比，一旦预热，JRuby 在几乎所有情况下都要快得多。到目前为止，我认为 JRuby 在企业 Java 商店的环境中是有用的，这些商店正在从 Java EE 中转移出来。我现在意识到，JRuby 提供了一种高性能的替代方案，可以推迟或消除迁移到更高性能语言(如 Java、Scala 或 Go)的需求。

如果没有我自己的测试，我是不会知道这些的。

当你看我的数字时，不要只看表面。做你自己的测试。你证明他们是对是错并不重要。通过亲身体验测试过程，你会学到一些东西。如果没有别的，这个经历会让你看到更频繁地对你的代码进行基准测试的好处。

拥有自己的数据很棒，因为我可以用它来决定什么应该改变，什么应该保持不变。没有自己的数据，感觉自己在瞎飞。

## 这些工具有时会改变结果

最初，我的计划只是简单地使用 [Apache Bench](http://httpd.apache.org/docs/2.2/programs/ab.html) 来运行我所有的测试。然而，一些案例表明，某些服务器，如 WEBrick，不能很好地与 Apache Bench 一起工作。所以，我使用了一个叫做 [wrk](https://github.com/wg/wrk) 的工具，它也在 [TechEmpower Web 基准测试](http://www.techempower.com/benchmarks/)中使用。

因为这两个工具的工作方式不同，所以您不能期望每秒的请求数完全相同。但是，您可以看到多个工具之间匹配的趋势。观察适合这两种工具的趋势很重要。它有助于发现测量工具不正确的地方，以至于扭曲了性能数据。

就像您校准已知重量的秤一样，您需要验证您的测量工具是否准确和合理。

有些服务器或框架不喜欢 Apache Bench 或 wrk。其他时候，一台服务器使用一种工具会表现不佳。在这种情况下，你会责怪工具、框架、服务器甚至运行时吗？当您花时间用多种基准测试工具运行测试时，您可以看到裂缝。有时这只是一个大系统中非常小的故障，但在其他情况下，数字永远不会与现实相符。

因此，我的建议是，当谈到基准测试工具时，不要过于依赖某个特定的工具。在你自己的测试中使用两个或三个或四个。您不必走得太远，但是即使您只是对一个更小的测试子集运行多个测试工具，您也会有更好的数据来处理。

我希望从这一部分学到的是，你不能满足于坐在一个工具或一组数据上，因为那最终会把你引入歧途。如果您跨多个工具验证您的数据，您将更好地了解真实性能。

## 错误导致好的对话

进行基准测试最吸引人的地方之一是，特定场景中的结果导致了与框架、运行时和服务器创建者的一些非常好的对话。

在某些情况下，一个框架需要一个补丁，因为默认的设置并没有产生像样的基准测试结果。在其他情况下，有一些补丁可以显著提高框架的速度。很高兴听到各种项目的创建者告诉我可以做些什么来加速他们的成果。

这个项目引发的另一个话题是关于方法论本身。实际运行这些基准测试的最佳方式是什么？它们应该在本地机器上运行吗？它们应该在远程机器上运行以更好地模拟互联网环境吗？它们应该在云中运行吗？这些都是很好的对话，因为它们会带来更好的数据和更好的推理。

我认为，最激动人心的对话是关于这些基准在现实世界中的影响有多大。考虑到我测试的是一个简单的“Hello World”web 应用程序，基准测试并没有显示理论峰值吞吐量之外的任何东西。我的想法是，你永远不会有一个比“Hello World”更简单的应用程序，所以你创建的其他任何东西都会比它慢。

然而，其他人反驳说，我们谈论的是几毫秒的差异，对于大多数应用程序来说，这并不重要。数据库几乎总是比较慢。在大多数情况下，即使只是减少图像上的文件大小，也会对页面加载速度产生更大的影响。

我其实同意。我们不是在谈论在现实世界中决定大多数应用成败的性能差异。也就是说，现实世界中有一种看法认为 Rails 很慢，这导致许多团队在他们的应用程序需要伸缩时远离 Ruby。我希望这种基准测试的努力将表明 Ruby 可以比大多数人部署它的方式更快。

我的基准测试工作至少重启了关于 Ruby 性能和提高速度的讨论，这很好。我希望谈话继续下去。

## 我们总是可以测试更多

我学到的最后一课很简单，就是总有其他东西要测试，或者有其他变化要尝试。当人们看到 Hello World 基准测试时，他们想要看到数据库基准测试，他们想要更多的框架、不同的配置等等。这真的很棒，它揭示了我们可能没有对我们的工作做足够的测试。

关于我们的系统和 gem 的各个部分的性能，并没有很多很好的数据。什么框架最快？嗯，现在看起来像古巴。什么 ORM 最快？我不知道。我还没有任何关于 ORMs 的数据。缓存呢？JSON 解析呢？你明白了。

我们没有大量的性能数据。然而，如果我们围绕性能和基准建立一种文化，我认为我们可以围绕我们的工具改进并做出更好的决策。

## 包裹

基准测试很有趣，虽然可能有点耗时。如果我们都多花一点时间对我们的代码进行基准测试，那么 Ruby 社区会更好，这样我们就可以更好地理解和了解我们创建的软件。对于每个应用程序来说，性能并不是最重要的事情，但是了解我们的应用程序性能将有助于我们创建更好的软件，这对每个人来说都是一个更好的结果。

Ruby Web 基准测试是探索性能的起点，但我不打算让它成为终点。我计划继续探索高性能 ruby 的世界，如果你想继续，我会在我的高性能 Ruby 页面和 SitePoint 上发布更多的文章、基准和相关项目。

## 分享这篇文章