# SitePoint 迁移到 Amazon EC2

> 原文：<https://www.sitepoint.com/sitepoint-migrates-to-amazon-ec2/>

上个月对 SitePoint 来说是一个巨大的里程碑。以前，我们的大部分网页都是通过从主机提供商那里租用的专用服务器提供的。我敢肯定，当这些服务器被租用时，SitePoint 一定对性能感到非常兴奋。然而，像所有美好的事情一样，这种感觉会结束。

随着时间的推移，基础设施开始给我们带来各种各样的限制，有时还会让我们非常沮丧。机器正在老化，不管机器的年龄和负载如何，租用机器的成本都是固定的。随着网站的发展和变得越来越复杂，无法扩展的局限性也成为了一个问题。我们的数据库复制日志需要越来越频繁地清理，否则服务器将会耗尽空间。随着交通流量的增加，负载持续增加。当上传的新代码不够高效或者搜索引擎会抓取我们的页面时，网站的性能会显著下降。

操作系统最初的安装方式也造成了一些限制，随着时间的推移，这些限制变得更加明显。例如，我们的安装没有提供快照支持，所以我们不能按需从单个时间点进行完整备份。我们也经常受制于主机提供商的支持人员。如果我们需要从备份中恢复系统映像，我们可能会面临数小时的停机时间。我们无法直接访问备份；任何恢复都必须由托管提供商手动请求，占用他们员工的时间来执行这样的手动操作可能会增加我们的月费用。

久而久之，机器上安装的软件变得一塌糊涂。不同的开发人员在不依赖包管理系统的情况下定制编译和安装应用程序。这些没有安装在一致的位置:似乎每个人都有自己的想法，他们应该放在哪里。也严重缺乏解释这些定制背后的理由的文件。在某些情况下，甚至连源代码都不见了。是否应用了补丁来生成正在使用的给定程序的版本？拥有这种知识的人已经不在了。RedHat 的 Apache 更新会破坏不依赖于包管理系统安装的模块吗？如果我们忘记将定制的修改合并到启动脚本中，那么包更新可能会改变这些脚本。

最终，我们使用的 GNU/Linux 发行版开始接近它的支持临界点，我们的主机提供商催促我们升级。如果我们在操作系统停产后继续使用我们的服务器，我们会被警告不能指望他们的任何帮助。RedHat 也不再提供安全更新，我们将不得不自己承担更新易受攻击的应用程序的任务。

很明显，我们别无选择，只能迁移到更新的操作系统，最好是更实用的基础设施。有很多方法可以解决这个问题，但是我们决定借此机会脱离我们的主机提供商，将我们的 web 服务迁移到 EC2。

## EC2 解决方案

亚马逊的 EC2 IaaS 解决方案已经帮助 SitePoint 解决了我到目前为止提到的所有问题。我们已经在其他项目中使用它并取得了巨大的成功，所以我们很熟悉它带来的好处。有了 EC2，我们不再有专用的物理硬件，但我们有实例——可以按需创建或删除的虚拟机。这有什么帮助？

### 价格

价格不需要固定。亚马逊已经多次降低了每个人运行实例的成本，大概是因为所用硬件的价值降低了。Amazon 为不同的价格提供了不同的实例硬件规格，管理一个允许在实例大小之间轻松切换的设置并不困难。如果您没有使用所有的周期，为什么要购买昂贵的服务器呢？

### 可量测性

另一方面，如果你需要更多的处理能力来跟上流量需求，会发生什么？增加实例大小也很容易。此外，您可以决定在一个负载平衡代理后面有多个应用服务器实例。这样，随着流量的增加，您可以启动新的实例来处理负载，并在负载下降时减少实例的数量。

### 备份

根据您的应用程序，您可以选择让弹性块存储卷可用于您的映像。这些工具允许您为它们包含的所有数据创建时间点快照，无论是数据库、用户上传的文件，只要是您能想到的。您还可以使用任何快照轻松地获得新的 EBS 映像。现在，我们可以自己管理备份。可以很容易地指定它们的制作时间和方式，而且我们还可以完全控制自己执行恢复操作。

### 硬件故障

惊喜！EC2 托管在物理硬件上——不是神秘的云——所以像任何其他硬件一样，EC2 也容易受到硬件故障的影响。我们以前的主机提供商非常擅长处理这些情况。有一次，我们被告知我们的一台服务器上有一个降级的 RAID 阵列，支持人员立即纠正了它——所有这一切都发生在我的日常 RAID 状态检查 cron 作业向我发送电子邮件通知我有问题之前。这是一项无与伦比的服务，那么 EC2 的表现如何呢？

使用 EC2，您不了解基本的硬件水平，因为您是在虚拟机内部工作的。你需要相信 Amazon 正在照看硬件，如果可能的话，会在需要时将实例实时迁移到其他硬件上。话虽如此，我们也有过实例完全死亡的情况。一旦一个实例死亡，您就不能再对它进行实时迁移了。此外，如果 Amazon 的整个数据中心停电，那么实时迁移到数据中心的其他地方并不是特别有利。但是，您可以在不同的区域创建冗余实例，或者进行自我设置，以便可以根据需要在另一个区域快速引导实例。相比之下，如果我们托管服务提供商的物理服务器出现故障或断电，我们无法立即采取措施。

虽然 EC2 失败在我的经验中感觉更常见，但这被它们提供更容易解决几乎任何类型问题的能力的好处所抵消。

### 保持事物有条理

迫使您合理地组织安装可能是 EC2 的典型实例存储模型的一个好的副作用。实例存储不是持久的。一旦虚拟机关闭，实例存储卷上的所有内容都将丢失。起初，这看起来像是一个主要的限制，但正如我所了解的，它有许多积极的方面。

如果当你关闭系统时，你的存储设备不见了，你的网站文件会怎么样？你有两个主要的选择。首先是附加一个 EBS 卷，这将使您的数据持久化。但是，这样做时，您将使 EBS 卷数据与其他所有数据(如操作系统)完全分开，这些数据将成为引导映像的一部分，而不会作为 EBS 快照的一部分进行备份。

第二种选择是在引导映像中嵌入脚本，这些脚本会按照您的要求自动设置实例。这个选项使您能够创建一个真正可伸缩的解决方案，因为您可以在任何需要的时候启动和关闭实例。

实际上，在 EC2 中托管动态网站可能会使用这两个选项——我们会使用一个 EBS 卷来存储数据库内容，并使用一组引导脚本来检查应用程序实例的版本控制系统的必要代码库。此外，EC2 将允许我们轻松、准确地克隆我们的生产设置，以便我们可以快速创建一个真实的试运行环境来测试这些变化，并且只支付我们需要的时间。

## 婴儿学步

正如您可能想象的那样，更新如此大量的 PHP 代码和 SQL 查询以兼容现代 GNU/Linux 发行版所包含的软件的新版本，这本身就是一项艰巨的任务。此外，实现充分利用 EC2 所需的大量代码更改并不是立即可行的。虽然我们已经决定了我们想要前进的方向，但是我们仍然需要一个直接的解决方案来解决我们的专用主机问题。

亚马逊再次用一个相对较新的功能来拯救我们——可引导 EBS 卷。这个工具使我们能够有效地引导实例，从而获得 EBS 为其所有数据带来的好处。拥有一个可引导的 EBS 卷意味着在需要备份时可以对整个系统进行快照。虽然事情处于不断变化的状态，但这帮助我们快速解决问题并备份修复，而不必担心创建许多图像修改。当我们的配置稳定下来后，我们可以创建一个新的操作系统映像，并将其从 EBS 中取出。

我们策略的第三阶段是将所有代码完全提交给 VCS。对于我们的应用服务器实例来说，我们可以几乎完全消除 EBS，因为代码可以在启动后立即从 GitHub 上的 Git 等 VCS(安全地通过 SSH)中签出，使新实例在启动后几分钟就可以投入生产。我们将继续使事情尽可能地动态化，这样我们就可以充分利用 EC2 提供的所有优势，比如根据需要快速扩展到多个应用服务器。

## 结论

我们迁移中最困难的阶段已经完成——它主要要求我们更新代码。不管我们最终决定在哪里托管我们的代码，这一步都是不可避免的。虽然我们尚未完全实现我们的所有目标，但我们正在实现这些目标的道路上前进。我们现在比以往任何时候都更能控制我们的数据和基础架构，因此我们为未来的发展做好了更充分的准备。

**注:**想了解更多关于云托管的知识吗？

从亚马逊网络服务的高级布道者杰夫·巴尔[这里下载*在云中托管你的网站*的免费样本章节！](https://www.sitepoint.com/books/cloud1/)

## 分享这篇文章