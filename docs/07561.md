# 实用代码重构，第 4 部分——效率

> 原文:[https://www.sitepoint.com/practical-code-refactoring-4/](https://www.sitepoint.com/practical-code-refactoring-4/)

在本系列的第三部分中，我们讨论了重构代码的可扩展性，并讨论了逻辑可扩展性、模块化设计、解耦和封装。在本系列的最后一部分，我们将讨论 web 应用程序的主要效率问题，以及如何进行重构以获得更高的效率。

大多数 web 应用程序本质上都是轻量级的，因此效率通常围绕着将瓶颈保持在最低水平(完美世界中没有)，无论是内存消耗、处理器可用性还是网络流量。我们都希望应用程序的计时和内容呈现“相当快”。

在我提到一些低效率的来源以及如何处理它们之前，您应该知道在谈到效率时您有两个“最好的朋友”:缓冲和缓存。缓冲允许有效利用内存和网络资源，缓存允许有效利用内存和处理器。这是两个重要的概念，你可以将它们用于更高性能的 web 应用程序。

您可以使用这些想法在细粒度级别重构您的代码，而不仅仅是作为一个大问题的大解决方案。粒度缓存的一个很好的例子是带有缩略图的图库；不要每次加载图库时都动态生成缩略图，只需生成一次并缓存它们即可。它们可以从缓存中加载，每当有新图像上传到服务器时，缓存就会更新。细粒度缓冲的一个例子是从磁盘或网络上成块地读取一个大文件(进入缓冲区)。否则，您可能不知道读取整个文件需要多长时间，这会阻塞应用程序的响应。

除了常见的问题和它们的重构策略，请记住，既然我们在谈论效率，那么不仅仅是简单的重构，还有一些优化。

## 网络带宽效率低下

**1。来自服务器的资源请求是否保持在最低水平？**

web 应用程序是一些业务逻辑(例如用 PHP 编写的)，它生成 HTML、CSS 和 JavaScript 供客户端(通常是浏览器)下载。请记住，总有人在“等待”你的页面加载，他不愿意等太久。一般来说，在 512Kb 的连接上，你的页面应该在 2.5 秒左右加载。对于沉重的页面，这不应该超过 5-10 秒，否则用户会开始感到不耐烦。为了能够实现这一点，您需要减少从服务器请求的资源数量。不要加载许多 CSS 文件，而是将它们合并到一个文件中。JavaScript 也是如此。然后，进一步优化这些聚合文件。

如果你使用 JavaScript 压缩程序/最小化程序，比如 YUI JS Compressor 和 CSSO，你可以很容易地将 CSS 和 JavaScript 文件的大小减少至少 30%。有些人可能会认为这些被认为是优化而不是代码重构，但在这一点上有一些重叠，因为您最小化了代码以最小化文件大小。

对于图像，你应该使用 CSS 精灵，这是一种技术，通过它你可以将图像组合在一个文件中，以最小化带宽。下载单个较大的文件比下载大量较小的图像更节省网络资源。你可以在这里了解更多关于创建精灵的知识。

**2。你明智地使用服务器回调了吗？**

大多数现代的基于 web 的应用程序都是基于 Ajax 的，自然会在后台调用服务器。只要您的服务器回调没有太多的延迟，这是没问题的。对于不需要服务器的简单任务，不要过度使用 Ajax。只有当你真的需要从服务器获取数据的时候才使用它，而不是真正的实时数据。如果需要实时数据，可以考虑使用数据推送技术，比如 Comet 和 WebSockets。

## 内存效率低下

**1。你在用递归吗？**

递归是一个强大的编程特性，在解决一些复杂的问题时，比如树遍历和搜索，它可以帮你省去很多麻烦。但是递归是有代价的:在 PHP 这样的语言中，如果你不知道自己在做什么，它会耗尽你所有的内存。大多数用递归解决的问题都可以用迭代来解决，所以把递归留给那些特别值得递归的问题。

**2。是不是迭代太多？**

使用迭代而不是递归不会给你开绿灯去做任何你想做的事情；每种技术都有其局限性，当谈到效率时，使用嵌套循环是完全低效的。只对类似矩阵的问题使用嵌套循环，这些问题需要 2 维或更多维的迭代，并且不能用其他方法解决。

同样，对于大多数循环，您应该总是有一些接近中断的条件，以避免页面加载延迟。例如，您可能想要迭代最近的 20 个新闻提要，但是为什么不仅仅是最近的 5 个，然后提供一个漂亮的“更多”链接呢？用这种方式思考，你可以提高你的页面速度。

**3。您的查询是有计划的吗？**

数据库延迟是 PHP 应用程序中非常常见的瓶颈，因此您应该总是计划您的查询。我们中有多少人写过这样的东西？

```
select * from users;
```

当表超过 10，000 个用户并且有很多列时，这个问题就变得很重要了。您在单个查询中选择了所有行的所有列！这是一个典型的计划外查询。

如果您没有使用 ORM，您应该花一些时间来计划您需要的查询。准确地决定你需要检索什么数据，否则在你的第一个 1K 用户之后，你将很容易使你的网络应用变得无用。

有些记录可能会呈指数级增长，因此您应该提前考虑到这一点。不要认为桌子是理所当然的。总是选择特定的列和行，如果不确定，可以使用 limit 子句来限制生成的结果集。

## 处理效率低下

**1。你需要动态语言功能吗？**

PHP 有很多动态特性，比如重载 getters 和 setters，动态实例化和方法/函数调用，甚至是最危险的`eval()`方法。明智地使用这些。这些可能是一些非标准问题的创造性解决方案的神奇元素，但一般来说，在标准的 web 应用程序中不需要它们，在这些应用程序中广泛使用任何元素都是不必要的，会增加复杂性。

**2。你有良好的编码习惯吗？**

如果你需要基于数组的计数进行循环，那么在循环之外进行计数，这样它只被计数一次。这也适用于任何需要进行比较的函数调用。

## 摘要

应用程序的效率是几个方面的因素。这里建议的指导原则并不能替代编码后优化，后者要求您使用分析工具来衡量效率低下的情况。它们是重构前的步骤，您可以采取这些步骤来帮助减少瓶颈。重构代码应该是一个渐进的过程；用简单的小步骤，一次做一点点。

重构是软件开发中确保代码健康的一项重要技术。在本系列中，我介绍了一组重构时可以使用的实用列表。我谈到了好的代码，以及如何在可读性、可扩展性和效率方面实现好的代码。我希望你喜欢阅读这个系列，就像我喜欢写它一样！:)

<small>图片 via[Fotolia](http://us.fotolia.com/?utm_source=sitepoint&utm_medium=website_link&utm=campaign=sitepoint "Royalty Free Stock Photos at Fotolia.com")T3】</small>

## 分享本文