# 遗留代码是一种癌症

> 原文：<https://www.sitepoint.com/legacy-code-cancer/>

我经常看到人们为了向后兼容而回避最新的技术。“我们不能将 PHP 的最低要求转移到 5.5，因为我们有 50%的用户仍然使用 5.4！”他们说。“我们没有办法转移到 Guzzle 4+，我们的后端是建立在版本 3 上的，这将花费太多的时间和金钱”。我最喜欢 WordPress 的一个常见论点:“我们无法实现完全的 OOP 和逻辑/表示解耦，因为我们的大多数用户都在运行 PHP 5.1 的共享主机，或者不知道 OOP 和/或 MVC”。

废话。

## 遗留代码——一个很大的否定

这可能会引起争议，但我坚信在现代系统中没有遗留代码的空间。在你磨尖你的干草叉，点燃你的火炬之前，请允许我详细说明。我的意思是:应该有绝对**零**的理由继续实现你添加到新版本的功能，追溯到旧版本，只是因为一些人仍然在使用它，即使使用它的人是绝大多数。

澄清一下:修正遗留版本的错误，直到他们的长期支持合同到期，或者如果你负责的话，你愿意。在 X-1 版本中加入你为 X 版本想出来的新特性是为了不让 X-1 用户抓狂，绝对是，100%不会。同样，仅仅因为 X-1 代码可以“服务于目的”而将其添加到 X 版本中也应该是非法的。如果你还在为 X-1 收费，并以此为基础进行升级，你的商业计划是糟糕的，你应该感到难过。

![](img/2ab1ac0cc83e38a65a548efd1f89b4c7.png)

不过，我有什么资格说这些废话，对吧？我从来没有为了取悦利益相关者和董事会而维护过一个大型项目，一个进展非常缓慢并且只要能工作就能让每个人都开心的项目，尽管事实上它可能会更安全 100 倍，更快 1000 倍，对吗？不完全是。我最大的宝贝是一个基于 ZF1 的大型发布网站，有一个复杂的后端。如果你曾经在 ZF1 中做过什么，你就会知道这是一个多么痛苦的反模式漩涡。当应用程序由于流量增加而开始出现恶化的迹象时，我在 ajax 接口和 API 调用上完全重建了后端的前端(应用程序中使用最频繁的部分),大大减轻了负载，并赢得了足够的时间来重建我们在更高的 ups 唯一允许的东西上拥有的整个应用程序套件——Zend Framework 2。如果你在*和*上做过什么，你会知道这是一个稍微不那么密集的反模式漩涡，但仍然是一个反模式和膨胀的漩涡——但我在这里想说的是——巨大的升级和完全重写是可能发生的，如果有能干的人支持它们的话。如果你所做的只是敏捷会议和头脑风暴，那么再多的 LTS 合同也无法阻止你在五年内变得愚蠢。

即使你在做免费和/或开源的工作，你也不应该为 X-1 用户累死累活，因为你只是帮了他们一个大忙，做了一个主要的版本增量，随之而来的是一个潜在的 BC 中断的主要升级。他们要么适应，要么枯萎。

那么我们为什么要将遗留代码从现代系统中驱逐出去呢？

### 永无止境的 LTS 诅咒

通过采取“尽我们所能支持一切”的方法，你正在把自己埋在一个无底洞里，当你发现自己必须维护四个不同的版本时，你会发现自己几年后会变得很瘦，你会把自己的头撞向墙壁，想知道为什么在你仍然可以做的时候没有切断 V1 和 V2 用户的联系。为了保持更大的受众群，开发人员经常竭尽全力帮助旧版本的用户，唯一的目的就是留住他们。这也是为什么 WordPress 在目前的状态下是一堆不可修复的业余代码。不要让自己被旧版本束缚住。

![](img/b37a99a8b5acedf72fa9f71b52db3310.png)

这些用户是累赘，应该被抛弃，不管他们给你带来多少钱。给他们一些过渡的方法，然后继续前进——如果他们有能力，他们会很快赶上。如果不是，他们就不值得。

支持旧版本太久，你就进入了 WP 的魔咒，旧版本，糟糕到令人生厌的版本，需要更多的人力和努力来修复。这些人力最好花在构建新版本和雇佣开发人员来帮助用户过渡上。

### 你正在疏远和负面影响高级用户

上一次这种绝望的遗留问题直接影响到我是在[安装一个 CMS](https://www.sitepoint.com/13-steps-get-ez-publish-5-x-homestead/) 的时候，这个 CMS 被证明特别难以在一个流浪的环境中安装——不仅仅是因为到目前为止众所周知的符号链接问题(甚至对于流浪者的创造者来说也是如此),还因为它们在主 CMS 中包含了一个 CMS 的遗留版本，因为它们共享一些安装属性，并且后端还没有完全重写到新版本中。那为什么要迁移到一个新的版本呢？如果你显然还没有准备好，为什么要着急呢？

通过匆忙推出新版本，他们最终得到了一种不相干的混合体——弗兰肯斯坦式的遗留代码怪物，它仍然可以工作，但很糟糕，而新代码有潜力，但如果没有遗留代码的混乱，就无法实现它。虽然这种方法确实让仍停留在 20 世纪 90 年代的开发公司的工作变得更加容易，但它让高级用户的工作变得更加困难。通过迎合一个从逻辑上来说应该灭绝的人群，你正在疏远和负面影响高级用户。

![](img/93a6b3d54e826b1a6920fc77f97770ce.png)

你知道这是怎么回事:不要浪费太多的时间去做遗留浏览器中的小细节。反正使用这些浏览器的人不会注意到。这同样适用于图书馆或内容管理系统的用户——那些关心遗留系统的人不会关心你在新系统中引入了什么，所以你不应该为他们付出不必要的汗水。

### 失败有时会带来成功

当然，有时这是不可能的，这些例外是非常珍贵的学习材料。Python 是版本控制和 BC 中断的一个奇怪例子。Python 是一门很棒的语言。你几乎可以在里面建造任何东西。它不会像在为此目的而构建的语言中那样工作得很好，但这是多面手类型的本性——他们可以把任何事情做得很好，只是没有什么是完美无缺的。当 Python 3 出现时，它引入了一些 BC 中断，阻止了 Python 2 用户进行简单的转换。

大多数借口是“还没有足够的 Py3 包”和“我们在 Py2 中有太多的代码要重写”——对此我分别说“自己构建你需要的”和“可怜的程序员，被迫编程等等”。诚然，有一些[有效的论点](http://www.robg3d.com/2014/01/why-ccp-is-still-using-python-2/)，并且这些倾向于出现在如此大得荒谬的项目中，但是 Py2 与 Py3 的问题实际上导致了其他东西——Python 裂缝。到 Python 4 推出的时候，那些强烈拒绝过渡到版本 3+的人将仍然停留在 Python 2 中，BC 转变对他们来说将变得更大。在这种情况下，他们还不如尝试学习一门新的语言。另一方面，那些“勇敢面对裂痕”并毫不犹豫地升级到 3+的人，他们自己重写关键模块并使语言适应他们的需求，而不是相反，将会更容易过渡到新版本。

![](img/5af12903de440d79653eaf2b14f8cab2.png)

这次 BC 休息有效地砍掉了懒惰，为新一代开发者准备了 Python 的版图。在我看来，这是一个版本碰撞失败带来的成功。编程和许多其他行业一样，仍然是基于适者生存——如果你不能充分利用新技术，那就为那些能利用新技术的人让路。

### 应用程序与库/包

还有应用程序和库的问题。换句话说，“无遗留”规则应该适用于依赖于(例如)获得新版本的框架的应用程序，还是应该只适用于库，因为当新版本出现时，它们应该切断与以前版本的联系？

![](img/1990cd0d11ed91fc768c3e1839eebdb4.png)

在某种程度上，两者都有。

升级到 X+1 版本的库应该沿着清晰的道路前进——从你有一个公开的新版本开始，在最后一个版本上保持一个只修复 bug 的方法。

使用这种库的应用程序处于更加困难的境地，因为它们的逻辑依赖于可能已经改变的 API。明智的做法是等待来自社区的稳定性报告，并在得到验证后开始转换。在过渡期间，旧版本和新版本的库/框架都可以继续使用，一旦所有必要的部分都升级了，旧版本就应该废弃。不过，这不是要花很长时间吗？

### 没有足够大的网络应用

“但是布鲁诺，有些应用程序太大了，需要几个月才能重写”，你可能会说。“从 ZF1 过渡到 ZF2 是一年的工作！”对此，我说:胡说。没有足够大的 web 应用程序来保证这个时间范围。事实上，我会更进一步说，没有一个 web 应用程序大到足以保证使用像 Symfony 或 Zend 这样的大框架。

我无意冒犯这两个框架，它们都是由专业代码组成的超级复杂的庞然大物，但如果你遵循最佳实践，尊重关注点的分离，封装你的服务并简化你的应用程序，这样你就可以编写完全独立于后端的前端，无论应用程序的大小和/或受欢迎程度如何，绝对没有什么可以阻止你在不到一个月的时间内完成完整的重写——前提是你的团队成员是程序员，而不是理论家。不管你知道多少模式和算法，你需要知道如何使用它们来有效地完成转换。

### 升级方案

那么应该使用哪种升级方案呢？无论 app/lib 受欢迎程度如何，任何软件开发人员都只能使用一种可接受的升级方案:

1.  为新版本引入新分支
2.  将旧版本/分支标记为已弃用
3.  公开声明旧版本还剩多少寿命
4.  向旧版本的所有用户发出警告
5.  仅在新分支中实现新功能，修复旧分支/版本的错误
6.  当旧版本停产时，切断所有联系。不要修复错误，不要咨询，甚至不要在文档中引用它。杀了它。

就是这样——遵循这个程序将让你永远不会陷入遗留问题。

在某种程度上采用这种方法的一个项目是 [Guzzle](http://guzzle.readthedocs.org/en/latest/overview.html#requirements) 。他们有一个 3+版本，一个 4+版本是为那些能够跟上 21 世纪快速发展的人准备的，还有一个前沿版本是为那些时刻想要最新最好升级的人准备的。

## 结论

作为一名 web 开发人员，我坚信对于主要版本变化中的新特性，应该放弃遗留代码。如果你有一个大型项目依赖于两个多月前升级的软件，你应该停止所有操作，重写一切以尊重新版本—*尤其是*如果你使用的软件是业务关键型的。世界上没有任何应用程序大到需要超过两个月的时间来完成完全过渡，如果有的话，应该废弃并从头开始编写——网络比我们所有人表现出来的要简单得多。

你怎么想呢?遗留代码应该无限期保留吗？具体几个版本？一点也不？你对大型项目使用的第三方项目中的遗留代码和这些第三方项目本身的遗留代码有何看法？你觉得这两者在处理过时代码的方式上应该有所不同吗？从各方面来看，我都大错特错了吗？我很想好好讨论一下这个问题——毕竟，我的观点和经历显然是我自己的。请在下面的评论中告诉我们。

## 分享这篇文章