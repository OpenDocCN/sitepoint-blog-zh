# 你知道你的字符编码吗？

> 原文:[https://www . site point . com/do-you-know-your-character-encodings/](https://www.sitepoint.com/do-you-know-your-character-encodings/)

这篇文章转载自《科技时报》第 134 期。

上个月，我参加了 web 标准组织墨尔本分会的一次会议，会上 W3C 的国际化活动负责人 T2 的 Richard Ishida 非常清楚地介绍了 Web 开发中最被忽视的一个问题:字符编码。

你有没有注意到你的网站上的某些字符不能正常显示？也许这些卷曲的引号看起来像小盒子，或者长破折号已经被问号取代。像这样的问题通常是由负责站点的开发人员对字符编码的不完全理解引起的。

我甚至猜测，至少在英语圈里，大多数 web 开发人员从未学习过字符编码，只是在出现上述问题时处理后果。

然而，当一个网站发展到必须面向国际受众(或者仅仅是喜欢引号的受众)时，就越来越难以忽视这些问题。更糟糕的是，在这个每天都有黑客尝试的令人兴奋的时代，字符编码的不正确处理会导致严重的安全漏洞(正如[谷歌最近发现的](http://shiflett.org/archive/177))。

那么到底是什么字符编码呢？好吧，让我们从它不是的东西开始:字符编码不是字符集。

## 字符集

字符集，或者更具体的说，**编码字符集**是一组字符符号，每个字符符号都有一个唯一的数字 ID，称为字符的**码点**。

字符集的一些例子包括 128 个字符的 ASCII 字符集，它主要由英语中使用的字母、数字和标点组成，以及 256 个字符的 ISO-8859-1 或 Latin 1 字符集，它包括所有 ASCII 字符加上重音字符和其他在相关语言(如法语)中使用的附加字符。最常用的扩展字符集是[通用字符集(UCS)](http://en.wikipedia.org/wiki/Universal_character_set) ，在 [Unicode](http://www.unicode.org/) 标准中定义，包含超过 110 万个代码点。

首先要理解的是**每个 HTML 文档都使用 Unicode 的 UCS** 、<ins datetime="2006-03-22T01:48:41+00:00">或者更准确地说[ISO 10646 字符集](http://www.unicode.org/unicode/faq/unicode_iso.html)，这是一个描述相同字符集的不太复杂的标准。</ins>一些较旧的浏览器或功能较弱的设备可能不支持(因此不会显示)完整的字符集，但事实是任何 HTML 文档都可能包含 UCS 中的任何字符。

因文档而异的是**字符编码**，它定义了 UCS 中的每个字符如何在页面的文本数据中表示为一个或多个字节。

此图显示了三个字符(字母“A”、重音符字母“e”和希伯来字母“alef”)的 ASCII、ISO-8859-1 和 Unicode 码位，以及这些字符如何映射到五种常见字符编码中的一系列字节:

![Some sample character encodings](../Images/bc90632ebfeb2411334e398d8fcb87cf.png)

首先看一下字符集，注意字母“A”在所有三个字符集中都可以作为字符使用，但是在 ASCII 中不能使用尖音“e ”,而“alef”只能在 Unicode 中使用。字符在多种字符编码中保持相同的码位是因为 ISO-8859-1 是作为 ASCII 的扩展而设计的，而 Unicode 则是作为 ISO-8859-1 的扩展而设计的。当然还有其他字符集，这些字符的代码点(如果存在的话)会有所不同。

然而，正如我在上面提到的，web 页面总是使用 Unicode 字符集，所以这些代码点是唯一对 web 开发有用的。

## 字符编码

现在看看图中的字符编码。第一个是 7 位 ASCII 码，它可以追溯到 MS-DOS 时代的之前很久的<ins datetime="2006-03-17T02:15:13+00:00">,现在被普遍用作电子邮件系统中的“最小公分母”。如果电子邮件消息只包含 ASCII 字符集中的字符，并且这些字符是按照它们的 ASCII 码点编码的(例如，字母 A 是码点 65，在十六进制(base-16)中是 41，因此用于表示它的字节值应该是 41)，那么它应该与任何互联网电子邮件系统兼容，不管它有多过时。因为 ASCII 只包含 128 个码位，所以一个字节中只需要 8 位中的 7 位来表示任何 ASCII 字符。因此，7 位 ASCII 文档中的字节值永远不会超过 7F(在十进制中是 127)。</ins>

ISO-8859-1 是许多浏览器和相关英语软件采用的默认编码。它使用每个字节的全部八位来表示 ISO-8859-1 字符集中的全部 256 个码位。尽管这提供了绝大多数英语文档以及许多相关语言(如法语)文档所需的字符，但仍有许多语言基于该集合中不包含的字符。甚至英语文档中的某些特殊字符，例如，花引号和长破折号，也不是 ISO-8859-1 的一部分。这解释了为什么这样的字符通常是揭示字符编码问题的原因。

为了满足其他语言的需求，有很多像 ISO-8859-1 这样的字符编码，它们利用可能的字节值来表示一组 256 个字符。此外，有许多字符编码使用*每个字符两个*字节，允许 65，536 个不同的字符。通常用于需要大量字符的中文和其他语言，这些编码被称为**双字节字符集** (DBCS)，尽管它们实际上是编码。

但是对于可能包含任何语言的字符的文档，最好的编码是那些能够处理 Unicode 的整个 UCS 的编码。其中最简单的是 UTF-32，它简单地使用四个字节通过代码点来表示每个 UCS 字符。“a”是代码点 65 (41 十六进制)，由四个字节值 00 00 00 41 表示，锐“e”(代码点 E9 十六进制)是 00 00 E9，“alef”(05d 0 十六进制)是 00 00 05 D0。

UTF-32 的问题是，因为文档中的绝大多数字符都出现在 UCS 的早期，所以给定文档中的几乎每个字符都以两个 00 字节开头，这是相当浪费的。实际上，大多数 UTF-32 文档的大小是 ISO-8859-1 这样的单字节编码文档的四倍。

UTF-8 和 UTF-16 编码通过对每个字符使用可变的字节数来解决这个问题。在 UTF-8 中，最常见的字符只使用一个字节，等于该字符的 UCS 码位，而不太常见的字符使用两个，甚至更罕见的字符使用三个，只有非常罕见的字符使用四个字节。UTF-16 容纳了更多的“常见”字符，它们的双字节编码与它们的 UCS 码位相匹配，为罕见的字符保留了三字节和四字节编码。

从图中可以看到,“A”字符的编码与 UTF-8 和 UTF-16 中的 UCS 码位相匹配。另一方面，尖音“e”和“alef”是不太常见的字符，它们在 UTF-8 中都有一个特殊的双字节编码，与其 UCS 码位不同。然而，在 UTF-16 中，acute 'e'e 和' alef '都被认为是足够常见的，以获得与其双字节码位匹配的编码(分别为 00 E9 和 05 D0)。

有道理吗？如果您已经学习了这么多，那么您已经掌握了智能使用字符编码所需的所有概念。请继续阅读，了解这一切是如何影响你作为一名 web 开发人员的工作的。

## 字符编码和网络

好的，所以字符编码指定了一组字符(像 Unicode 的 UCS，它在 web 上被使用)如何在存储的文档中被写成字节。那么这对 web 开发者意味着什么呢？

作为一名 web 开发人员，您需要处理两种类型的文本数据:组成站点页面的文本，以及用户浏览器发送的文本(通常作为表单提交)。在每种情况下，您都应该知道正在使用的字符编码，并相应地处理这些数据。

原来这两种文本数据的编码是联系在一起的:浏览器在提交表单时使用的默认编码是由包含表单的文档的编码控制的。以 ISO-8859-1 编码的页面将以 ISO-8859-1 提交其表单数据，而以 UTF-8 编码的页面将以 UTF-8 提交。

因此，您需要做的第一件事是在您用来创建 web 文档的编辑器中选择合适的编码。取决于您的编辑器，这将涉及设置配置选项(例如在 Dreamweaver 中)，或者在您第一次保存文件时简单地选择正确的编码(例如在记事本中)。

您还需要告诉浏览器您的文档使用的是哪种编码。浏览器无法猜测字符编码——每个文档看起来只是一系列字节值，直到提供一种编码来解释它们。因此，接下来您必须声明每个文档的字符编码。为了表示 HTML 文档的编码，包含一个适当的`<meta>`标签。对于 ISO-8859-1:

```
<meta http-equiv="Content-Type"
    content="text/html; charset=ISO-8859-1" />
```

对于 UTF-8:

```
<meta http-equiv="Content-Type"
    content="text/html; charset=UTF-8" />
```

是的，没错:你用一个名为`charset`的属性指定字符*编码*。难怪人们会觉得这种东西令人困惑！

您可能想知道，如果浏览器还不知道字符编码，它怎么能读取这个标签，但是事实证明，大多数常用的编码有足够多的共同字符，导致这个标签的简单 HTML 代码通常可以通过猜测一个简单的编码(比如 ISO-8859-1)来解释，然后如果标签表明浏览器猜错了，就重新开始。

对于 CSS 和 JavaScript 文件，事情要复杂一些。虽然这些标准提供了指示这些文件编码的方法，但对这些方法的支持却是参差不齐的。如果您需要在这些文件中使用相对安全的 ASCII 字符集之外的字符，您需要配置您的 web 服务器来识别与这些文件一起发送的 HTTP 头中的字符编码。例如:

```
Content-Type: text/css; charset=UTF-8
```

您也可以对 HTML 文档使用 HTTP 头方法，但是您仍然应该包含`<meta>`标记作为备份，以防文档在没有 HTTP 头的情况下被加载(例如，它是使用`file://` URL 从文件系统直接加载的)。

一旦你指定了一个编码，你就可以验证浏览器是否会选择它。在 Firefox 中打开页面，右键单击背景并选择页面信息。出现的窗口将显示用于解释文档的字符编码。

![Page Info window](../Images/2a3d3cf7d649798faefbf63b9931149d.png)

所以所有这些都回避了一个问题，你应该使用哪种字符集？嗯，在大多数情况下，答案是 UTF-8。它使您能够访问文档中的大量字符，而不会显著增加文件大小，并且它与不支持 Unicode 的旧浏览器和简单设备向后兼容。但是，如果您需要使用大量的 CJK(中文、日文或韩文)文本，这将需要更大的字符集，那么您可能会发现 UTF-16 是更有效的选择。

也就是说，除非你用的是 PHP。PHP(直到并包括 PHP 5.1)最大的弱点之一是其内置的字符串函数不能正确处理多字节字符编码，如 UTF-8 和 UTF-16。PHP 是在假设一个字节等于一个字符的情况下编写的，但在这种编码中根本不是这样。一个[可选模块](http://php.net/mbstring)或[库](https://www.sitepoint.com/php-utf-8-01/)可以用来提供*所做的*支持多字节字符的替代字符串函数，但是许多流通中的 PHP 脚本使用内置函数，因此根本不能处理 Unicode 字符。

这个问题将在 PHP 6 中得到解决，其中 Unicode 支持将是该语言不可或缺的一部分，但同时让 PHP 正确对待 Unicode 是一种黑色艺术。这当然是可以做到的——像 [WordPress](http://wordpress.org/) 和 [phpBB](http://www.phpbb.com/) 这样的高质量 PHP 脚本可以很好地处理 Unicode——但你真的需要了解你的 PHP 才能做到这一点。

因此，基于 PHP 的网站通常使用 ISO-8859-1 编码来编写。例如，SitePoint 的文章和论坛页面都是使用 ISO-8859-1 编写的。

正如您可能会发现的那样，使用 ISO-8859-1 有一些缺点。首先，您只能使用相对较小的字符集来编写文档。当你需要一个花引号，或者其他一些 ISO-8859-1 集合中没有的字符时，会发生什么呢？

HTML 对这个问题的回答是字符实体。我相信你对这些很熟悉:像`&rdquo;`(右双引号)和`&mdash;`(长破折号)这样的代码允许你在你的文档文本中包含你选择的编码中没有的字符。对于在 HTML 中没有易于记忆的代码的更多外来字符，可以使用**数字字符~~实体~~ <ins datetime="2006-03-22T01:48:41+00:00">引用</ins>** 来代替。例如，要在 ISO-8859-1 文档中包含字符“alef ”,您可以使用`&#1488;`或`&#x05d0;`,分别是字符的 UCS 码位的十进制和十六进制版本。

花一点时间来理解这样一个事实，即数字字符实体引用字符的 UCS *代码点*，而不是任何特定编码中字符的字节值。“alef”的数字字符实体是相同的，无论您在文档中使用什么编码。

所以当*编写*文档时，字符实体允许您处理您选择的编码之外的字符，但是硬币的另一面呢？在提交表单时，如何处理 ISO-8859-1 这样的有限编码之外的字符？

可悲的是，这是一个浏览器长期以来意见不一的地方，即使在今天，经过许多争论和咬牙切齿之后，大多数浏览器现在支持的解决方案都不太理想。

最大的问题之一是 Windows，它在英语语言系统上使用稍加修改的 ISO-8859-1 版本，称为 Windows-1252。萨姆·鲁比在他的生存指南中记录了这些差异。Windows-1252 将某些有用的字符(如花引号)表示为单字节，取代了不常用的 ISO-8859-1 字符。因此，Internet Explorer 浏览器通常会将此类字符视为文档编码中的*，并照此提交。在服务器上，这些单字节编码被解释为它们的 ISO-8859-1 等价物，这通常会导致网页上出现难看的框和其他无意义的字符，以代替花引号等，特别是当在 Windows 系统上输入的文本在 Safari 等非 Windows 浏览器上显示时。*

除此之外，大多数当前的浏览器，当遇到一个字符不在提交表单的编码中时，会把这个字符转换成一个数字字符实体并提交它。起初这听起来很合理，但是考虑到 HTML 表单应该提交纯文本，而不是 HTML 代码。像< and >这样的特殊字符不会自动编码为`&lt;`和`&gt;`以供表单提交，也不应该这样。这种编码外字符的自动转换意味着，在 ISO-8859-1 文档中，您无法从提交的表单数据中判断用户实际输入的是字符‘alef’，还是一系列字符`&#1488;`。

一些浏览器以不同的方式处理这个问题，用编码内的等价字符替换某些编码外的字符(例如，用直引号替换弯引号)，用一般的替代字符替换其他有问题的字符(例如，'？')).虽然这种解决方案在技术上更胜一筹，但你确实错过了一些情况，上面描述的更常见的方法设法保留了想要的字符而没有任何副作用。

关于不同浏览器如何处理表单提交中的字符编码问题的完整讨论将花费太多时间，无法在此赘述，但是对于那些有兴趣的人来说，有一些很好的文章可供参考。然而，简而言之，克服这些问题的最好办法是尽快将您的站点迁移到 UTF-8(或者 UTF-16，如果合适的话)。

## 进一步阅读

本期上面的许多信息都是从理查德·石田不久前给墨尔本网络标准组织的第二个小时的演讲中提炼出来的。如果我激起了你的兴趣，但你对细节仍有一点模糊，你可以听听那个演示的完整音频，通读一下[的幻灯片](https://www.w3.org/International/tutorials/tutorial-char-enc/)，并辅以完整的教程笔记。

一旦你开始使用 Unicode，你会发现石田的
网站上的一些[实用程序](http://people.w3.org/rishida/utilities)会非常方便。有一个工具用于浏览完整的 UCS，另一个工具用于在 Unicode 字符、代码点、编码和数字字符实体之间进行转换，这两者都绝对值得添加书签。

<ins datetime="2006-03-17T02:15:13+00:00">**更新:**在这篇文章的原始版本中，重音‘e’的代码点是错误的。</ins>

## 分享这篇文章