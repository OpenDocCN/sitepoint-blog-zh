# 7 大 PHP 安全错误

> 原文:[https://www.sitepoint.com/php-security-blunders-2/](https://www.sitepoint.com/php-security-blunders-2/)

## SQL 注入漏洞

SQL 注入漏洞是另一类输入验证缺陷。特别是，它们允许利用数据库查询。例如，在您的 PHP 脚本中，您可能会要求用户输入用户 ID 和密码，然后通过向数据库传递查询并检查结果来检查用户。

```
SELECT * FROM users WHERE name='$username' AND pass='$password';
```

但是，如果登录的用户不诚实，他可能会输入以下密码:

```
' OR '1'='1
```

这导致查询以如下形式发送到数据库:

```
SELECT * FROM users WHERE name='known_user' AND pass='' OR '1'='1';
```

这将在不验证密码的情况下返回用户名——恶意用户已经作为自己选择的用户进入了您的应用程序。为了缓解这个问题，您需要对用户提交的值中的危险字符进行转义，尤其是单引号(')。最简单的方法是使用 PHP 的`addslashes()`函数。

```
$username = addslashes($_POST["username"]);  

$password = addslashes($_POST["password"]);
```

但是根据您的 PHP 配置，这可能不是必需的！PHP 备受诟病的**神奇语录**功能在当前版本的 PHP 中默认启用。这个特性可以通过将`magic_quotes_gpc` `php.ini`变量设置为`Off`来禁用，它会自动将`addslashes`应用于通过 GET、POST 或 cookies 提交的所有值。这个特性可以防止没有经验的开发人员留下如上所述的安全漏洞，但是当输入值不需要进行转义以用于数据库查询时，它会对性能产生不利影响。因此，大多数有经验的开发人员选择关闭这个特性。

如果你正在开发可能安装在共享服务器上的软件，在那里你可能不能改变`php.ini`文件，使用代码来检查`magic_quotes_gpc`的状态，如果它是打开的，通过 PHP 的`stripslashes()`函数传递所有的输入值。然后，您可以像往常一样将`addslashes()`应用于任何用于数据库查询的值。

```
if (get_magic_quotes_gpc()){  

  $_GET = array_map('stripslashes', $_GET);  

  $_POST = array_map('stripslashes', $_POST);  

  $_COOKIE = array_map('stripslashes', $_COOKIE);  

}
```

SQL 注入缺陷并不总是导致特权升级。例如，如果查询结果打印到您的 HTML 输出中，它们可以允许恶意用户输出选定的数据库记录。

您应该总是以不区分大小写的方式检查用户提供的数据，这些数据将用于字符`'",;()`和关键字`"FROM"`、`"LIKE"`和`"WHERE"`的查询。这些是在 SQL 插入攻击中有用的字符和关键字，所以如果您将它们从不必要的用户输入中剥离出来，您将很少担心这种类型的缺陷。

## 错误报告

您应该确保您的`display_errors` php.ini 值设置为“0”。否则，代码中遇到的任何错误(如数据库连接错误)都将输出到最终用户的浏览器中。恶意用户可以利用这一缺陷来获取有关应用程序内部工作的信息，只需提供错误的输入并阅读由此产生的错误消息。

可以在运行时使用`ini_set`函数设置`display_errors`值，但是这不如在 ini 文件中设置它理想，因为仍然会显示脚本的致命编译错误:如果脚本有致命错误并且无法运行，`ini_set`函数就不会运行。

不要显示错误，而是将`error_log` ini 变量设置为“1 ”,并经常检查您的 PHP 错误日志以发现错误。或者，您可以开发自己的错误处理函数，当 PHP 遇到错误时会自动调用这些函数，并且可以向您发送电子邮件或执行您选择的其他 PHP 代码。这是一个明智的预防措施，因为在恶意用户知道问题存在之前，您会收到错误通知并得到修复。阅读关于错误处理的 [PHP 手册页，了解`set_error_handler()`函数。](http://www.php.net/errorfunc)

## 数据处理错误

数据处理错误不是 PHP 本身特有的，但是 PHP 应用程序开发人员仍然需要意识到它们。当以不安全的方式处理数据时，会出现这类错误，这使得恶意方有可能截取或修改数据。

最常见的数据处理错误类型是应该通过 HTTPS 传输的敏感数据的未加密 HTTP 传输。信用卡号码和客户信息是最常见的安全数据类型，但是如果您通过常规 HTTP 连接传输用户名和密码，并且这些用户名和密码允许访问敏感材料，那么您还不如通过未加密的连接传输敏感材料本身。每当您将应用程序中的敏感数据传输到用户的浏览器时，请使用 SSL 安全性。否则，在您的服务器和最终用户之间的任何路由器上的恶意窃听者都可以非常容易地从网络数据包中嗅出敏感信息。

当使用 FTP(一种不安全的协议)更新应用程序时，也会出现相同类型的风险。通过不安全的协议(如 FTP)将包含数据库密码的 PHP 文件传输到您的远程 web 服务器会让窃听者嗅探数据包并泄露您的密码。始终使用安全协议，如 SFTP 或 SCP 来传输敏感文件。也不要让你的应用程序通过电子邮件发送敏感信息。任何能够阅读网络流量的人都可以阅读电子邮件。一个很好的经验法则是，如果你不想把信息写在明信片的背面并通过邮件发送，你也不应该通过电子邮件发送。任何人实际截获消息的机会可能很低，但为什么要冒这个险呢？

最大限度地减少数据处理缺陷是很重要的。例如，如果您的应用程序是一个在线商店，是否有必要保存超过六个月的订单所附带的信用卡号？将数据归档并离线存储，限制在您的 web 服务器遭到破坏时可能受到危害的数据量。这是基本的安全实践，不仅要试图防止入侵或危害，还要减轻成功危害的负面影响。没有安全系统是完美的，所以不要认为你的是完美的。如果你真的遭到入侵，采取措施将后果降到最低。

## 为安全性配置 PHP

一般来说，大多数使用最新 PHP 版本的新 PHP 安装都配置了比以前版本更强的安全默认值。但是，您的应用程序可能安装在已经升级了 PHP 版本的遗留服务器上，而不是 php.ini 文件上。在这种情况下，默认设置可能不如全新安装时的默认设置安全。

您应该创建一个调用`phpinfo()`函数的页面来列出您的 php.ini 变量，并扫描它们是否有不安全的设置。将此页面保存在受限位置，不允许公众访问。`phpinfo()`的输出包含潜在黑客可能会发现非常有用的信息。

配置 PHP 安全性时要考虑的一些设置包括:

1.  **`register_globals`**:PHP 安全的恶魔是`register_globals`，它在 PHP 的旧版本中默认为“开”，但后来被改为默认为“关”。它将所有用户输入作为全局变量导出。检查此设置并禁用它—没有但是，没有例外。去做吧！这种设置可能比任何其他单一原因造成更多的 PHP 安全缺陷。如果你在一个共享主机上，他们不让你禁用`register_globals`，那就换个新主机吧！

*   **`safe_mode`** :安全模式设置对于防止未经授权访问本地系统文件非常有用。它的工作原理是只允许读取拥有正在执行的 PHP 脚本的用户帐户所拥有的文件。如果您的应用程序经常打开本地文件，请考虑启用此设置。*   **`disable_functions`** :这个设置只能在你的 php.ini 文件中设置，不能在运行时设置。它可以被设置为您希望在 PHP 安装中禁用的函数列表。它可以帮助防止有害的 PHP 代码的可能执行。如果不使用的话，可以禁用 system 和 exec 函数，它们允许执行外部程序。

阅读 PHP 手册的[安全部分，深入了解。把它当作你将要参加的一次考试的材料，并且前后了解它。毫无疑问，黑客会试图渗透你的网站，他们会对你的材料进行测试。如果黑客放弃并转移到一个对这些概念掌握不足的更容易的目标，那么你在测试中获得及格分数。](http://www.php.net/manual/en/security.php)

## 进一步阅读

建议阅读以下网站，以保持您的安全知识。新的缺陷和新形式的漏洞总是被发现，所以你不能固步自封，以为你已经解决了所有的问题。正如我在这篇文章的介绍中所说，“安全是一个过程”，但是安全教育也是一个过程，您的知识必须得到维护。

OWASP 是一个非盈利性组织，致力于“寻找和消除不安全软件的原因”。它提供的资源是非常宝贵的，该组织有许多地方分会，定期举行研讨会和圆桌讨论。强烈推荐。

CGISecurity.Net 是另一个处理 Web 应用安全的好网站。他们有一些有趣的常见问题解答和关于我在本文中讨论的一些缺陷类型的更深入的文档。

PHP 手册的安全部分是我上面提到的一个关键资源，但是我再次把它包含在这里，因为它充满了直接适用于 PHP 的重要信息。不要忽略每页底部的评论:一些最好的和最新的信息可以在用户贡献的笔记中找到。

PHP 安全联盟提供了一个链接到其他有用资源的库，安全焦点时事通讯、PHP 安全指南和一些文章的 PHP 特定摘要。

[BugTraq 邮件列表](http://www.securityfocus.com/archive/1)是安全相关建议的一个很好的来源，如果你对一般的安全感兴趣，你应该读一读。您可能会对涉及允许 SQL 插入、跨站脚本和我在这里讨论的一些其他缺陷的流行 PHP 应用程序的咨询数量感到震惊。

[Linux Security](http://www.linuxsecurity.com) 是另一个很好的网站，它不一定局限于 PHP，但是，由于您可能运行 Linux web 服务器来托管您的 PHP 应用程序，所以尝试了解与您选择的 Linux 发行版相关的最新建议和新闻是很有用的。不要假设你的托管公司在这些发展的顶端；你自己要意识到——你的安全取决于你最薄弱的地方。让一个安全的 PHP 应用程序运行在一个过时的服务器上，暴露出一个众所周知的可利用的漏洞，这对你没有任何好处。

## 结论

正如我在本文中所展示的，在编写安全的 PHP 应用程序时，有许多事情需要注意，尽管这适用于任何语言和任何服务器平台。PHP 的安全性不亚于许多其他常见的开发语言。最重要的是培养正确的安全意识，并充分了解您的工具。我希望你喜欢这篇文章，也学到了一些东西！记住:仅仅因为你是偏执狂，并不意味着没有人会了解你。

如果你喜欢读这篇文章，你会爱上[可学的](https://learnable.com/)；向大师们学习新技能和技术的地方。会员可以即时访问 SitePoint 的所有电子书和交互式在线课程，如 [PHP & MySQL 初学者网络开发](https://learnable.com/courses/php-mysql-web-development-for-beginners-13)。

**Go to page:** [1](/php-security-blunders) | [2](/php-security-blunders-2/)

## 分享这篇文章