# PHP 用 PHPNG 对抗 HHVM 和泽菲尔

> 原文:[https://www.sitepoint.com/php-fights-hhvm-zephir-phpng/](https://www.sitepoint.com/php-fights-hhvm-zephir-phpng/)

*本文由[新遗迹](http://newrelic.com/)赞助。感谢您对使 SitePoint 成为可能的赞助商的支持！*

***这篇文章的前一个版本错误地陈述了 PHPNG 是 JIT。事实并非如此，已经进行了必要的修正。更多信息见文章底部。*T3】**

* * *

旧世界的混乱！几年前第一次跳 HipHop，没人会在意。然后，突然， [HHVM](https://www.sitepoint.com/hhvm-and-wordpress/) 发生了，引入了[黑客](https://www.sitepoint.com/premium/books/hacking-the-hacker/read/1)，一切都乱套了——脸书做了一个新的 PHP，破坏/修复了一切(取决于你问的是谁)。此外， [Zephir](http://zephir-lang.com) 催生并威胁着所有 PHP 代码的 C 级编译，完全支持当前的 PHP 扩展(虽然 Zephir 不打算取代 C 或 PHP，但它确实让您编写接近 PHP 的代码并将其编译成 C，这让您可以轻松地将所有 PHP 应用程序重写为一种格式，这种格式可以在速度和安全性方面进行封闭源代码和编译)。替代 PHP 运行时的快速增长期到了，HippyVM 也出现了。

在变化的海洋中，另一个声音响起来了。

正如曼努埃尔·莱默斯介绍的那样，PHPNG 是 PHP 的一个新分支，是 PHP 尚未确定的未来版本。

## 等等，什么？

这个有点俗气的名字(NG = new generation)和[笨拙地呈现的](https://wiki.php.net/phpng)版本的 PHP 是核心团队试图彻底优化 PHP，并允许 JIT 编译器在未来进一步推动它。PHPNG 是一个 JIT 的**而不是**，而是一个升级版本，允许以后构建一个好的 JIT 编译器。PHPNG 分支本身[不包含任何 JIT 特性](http://www.php.net/archive/2014.php#id2014-05-27-1)。

PHPNG 是由 Dmitry Stogov 在一个内部新闻组帖子中提出的。Dmitry 负责 Zend 的性能和优化，主要处理 Zend 引擎。NG 升级的重点是重写 Zend 引擎的核心部分，以便在 PHP 的数据类型上实现更好的内存分配。

引自 [Reddit](http://www.reddit.com/r/PHP/comments/26iqdp/php_fights_hhvm_and_zephir_with_phpng/chs2n93) :

> NG 的存在是因为 Zend 在引入 JIT 中进行的实验在现实世界中失败了，这是因为引擎当前的设计方式，主要是因为我们一直在分配一切。NG 补丁改变了规范，所以我们不再默认分配 zvals，这提高了性能，并允许更整洁的 API。

就像任何“让 PHP 变得更好”的尝试一样，这种尝试有其利弊。

## 赞成的意见

### 速度！

更快的执行意味着更快的资源分配，意味着更快的请求处理，意味着更大的请求吞吐量。初步结果很有希望( [1](http://news.php.net/php.internals/73888) ， [2](https://wiki.php.net/phpng) )。

性能仍然需要与其他替代解决方案进行比较，但 10-30%是不容轻视的。

### 扩展！

由于这次升级是在官方的 Zend 引擎上进行的，而不是一个替代的运行时，它很好地保证了与当前扩展的兼容性。人们对转移到 HHVM 犹豫不决的最大原因之一是无法获得他们习惯的基本扩展(我的例子是 Phalcon)。就个人而言，一个支持 Phalcon 的更快的 PHP 引擎会让我对 Hack 今天提供的升级不那么关心。

所以它保证了扩展的兼容性…等等。是吗？啊哦。

## 骗局

### 扩展！

好得难以置信。

> 并不是所有的扩展都被支持，一些
> 测试失败了，我们也有更多的想法来进行额外的改进。

平心而论，NG 还年轻。比我们在 PHP 世界中真正处理过的任何东西都要年轻得多，而且更是一个重大的更新——所以不言而喻，一些兼容性问题是肯定的。但是我同意 Manuel 的观点，当升级的时候，这可能是大多数共享主机提供商的痛点。

尽管我对共享主机提供商颇有微词，但我完全理解这可能带来的问题。当我们试图让提供者“转向 PHP5”时，我们也遇到过类似的混乱，最近当他们需要[与](https://groups.google.com/forum/#!topic/php-fig/ogp03OHbVJ0)更新版本的 PHP 对话时，让他们做出有可能引入 BC 中断的重大转变将是一项艰巨的任务。

这种对变化的恐惧会巩固旧 PHP 版本的使用，反过来会滋生更多可怕的不合格的 PHP 开发人员，他们从事过时的代码，完全忘记最佳实践和漏洞。简而言之，我们期待历史重演。正如一些人所指出的，这听起来像是世界末日，但是我深深地卷入了 PHP 的所有圈子，并且每天都通过一个满满的收件箱接触到质量最差的内容，我明白了我们现在所处的位置和未来的方向。然而，并非所有东西都是黑色的 Heroku 和 DigitalOcean 等解决方案将让人们以与共享主机提供商一样低(或更低)的价格运行最新和定制版本的 PHP。

我最真诚的希望是，核心团队将设法使新的 Zend 引擎保持与所有扩展的向后兼容性，但对所有未能遵守 ng 规则和最佳实践的扩展开发者发出编译警告。

### 内部慢度

核心开发团队因适应变化缓慢而臭名昭著。在其他语言中存在多年的现代特征在过去被[投票反对](http://www.mail-archive.com/internals@lists.php.net/msg03925.html)，却在几年后被[实现](http://php.net/releases/5_4_0.php)。

这是因为核心开发团队根本没有愿景，就像 Anthony 和 Phil 的帖子所说的那样，还是因为它太小了，资金不足以快速做出任何重大改变，这都无关紧要——内部的缓慢意味着我们可能永远不会看到 NG 公开和脱离“alpha”状态，就像神话中的 PHP6 的情况一样。

这就把我们带到了最后一点。

### 派对又迟到了

由于 PHP 核心开发小组经常见证的固有的缓慢，当 NG 实现时(如果有的话),它将提供的只是性能升级。到那时，超越标准 PHP 的 HHVM Hack 将会提供如此多的附加功能，这场竞赛将会被操纵，PHP 将毫无胜算。

如今在 Hack 和 Zephir 中都可用的类型提示将在这些实现中扎根。多线程、编译、独立的 web 服务器——所有这些功能现在都可以在替代解决方案中使用，并且几乎都可以投入生产。虽然核心开发小组正在研究其中的一些技术，而且 PHP 可能会在 HHVM 之前就有 IIS 支持(这显然对一些人来说很重要)，但我个人仍然认为从 PHP 官方的角度来看，这还不够快。

即使核心小组决定对所有这些存在问题和需求的奇特功能投“是”票，他们也需要太长时间来实施——并且他们将默认迟到，除非引入范式转变，彻底改变他们的工作方式。将源代码转移到 GitHub 是一个很好的举措，但这只是皮毛。

也就是说，拉斯穆斯本人据说说过 HHVM 在几年内成为 PHP 的核心引擎并不是什么科幻故事。

## 结论

抛开与脸书相关的所有权不谈(这本身就带有许多负面含义)，HHVM 通过展示如何进行这种升级，将 dev 推向了正确的方向。这推动了创新，迫使那些在宝座上舒服了太久的人站起来，伸伸腿，看看自己是否还能跑。脸书咄咄逼人的方法迫使 PHP 世界采取双重措施，并想知道发生了什么，很快它就流行起来了。

竞争太棒了。不管接下来我们会走向何方，我都很乐观。

#### *文章更新 2014 年 5 月 28 日*

在与 Phil Sturgeon 通过电子邮件交流，并阅读了[官方声明](http://www.php.net/archive/2014.php#id2014-05-27-1)后，我编辑了上述文字的部分内容。简而言之，我将 PHPNG 归类为 JIT，但显然**不是**,而是一个简单的性能升级，这将允许核心团队在以后开发一个合适的 JIT 编译器。

## 分享这篇文章