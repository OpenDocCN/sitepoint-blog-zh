# 字符编码和输入

> 原文:[https://www.sitepoint.com/character-encodings-and-input/](https://www.sitepoint.com/character-encodings-and-input/)

曾经通过 HTML 验证器运行数据库驱动的 PHP 站点时遇到过这样的错误消息吗？

> 第 9 行，第 3 列:非 SGML 字符数 145

更糟糕的是，您是否曾经以 XHTML 的身份通过 XHTML 验证器运行过您的 XHTML 站点，并遇到过这样的错误消息？

> 抱歉，我无法验证这个文档，因为在第 9 行，它包含了一个或多个我无法解释为 utf-8 的字节

如果是这样，那么你就有了编码蓝调的字符。

文本格式使用字符编码将字符映射到其二进制表示形式。当只使用 ASCII 范围内的字符(美国英语)时，字符编码似乎“正常工作”。你可能永远也不会意识到你正在使用的字符编码。这是因为在网络上使用的所有流行的字符编码中，ASCII 字符都以相同的方式表示，所以如果你从来不需要外来字符，你就不会遇到问题。然而，一旦您偏离了 ASCII 字符的这一公分母，并开始使用外语字符，它们的二进制表示形式可能取决于所使用的字符编码，如果您弄混了编码，您最终可能会得到无效的字符。

问题是，如果您使用 ISO-8859-1 字符编码编写 PHP 应用程序，这是 HTML 中最常见的编码，那么您不能指望 PHP 的所有输入在这种字符编码中都有效。浏览器通常会忽略或不知道应用程序需要的字符编码。ISO-8859-1 包含不应使用的保留值，但是如果您从 Word 文档复制到 Web 表单并提交它，您复制的文本很可能包含 Windows 代码页 1252 (Windows-1252)字符，这在 ISO-8859-1 中是无效的。

如果这些字符随后显示在 CMS 中，生成的页面将不会验证。或者，如果您使用 XHTML 作为 XML，页面根本不会显示！

不幸的是，PHP 无法在字符编码之间进行转换，也无法验证字符串以确保它在特定的字符编码中是有效的。也就是说，除非你启用了 [mbstring](http://www.php.net/manual/en/ref.mbstring.php) 扩展(默认禁用)。mbstring 扩展支持大量的字符编码，常见的和不常见的。它可以将一个字符串从一种字符编码转换成另一种，对字符串执行许多功能(比如改变字母的大小写),甚至可以为您解析表单中的输入。

如果您不能安装 mbstring 扩展，您可能需要求助于快速修复。如果您在 CMS 中使用 ISO-8859-1 编码，您可以使用以下正则表达式来删除在此编码中无效的任何字符:

 `// strip out characters that aren't valid in ISO-8859-1
$string = preg_replace('/[^x09x0Ax0Dx20-x7FxC0-xFF]/', '', $string);`

对此更好的解决方案是在内部使用一种字符编码，它可以用任何其他编码表示任何字符。Unicode 字符编码能够做到这一点，UTF-8 是一种 Unicode 字符编码，它将 ASCII 字符表示为单字节，而将其他字符表示为多字节，这是一个很好的选择。不幸的是，如果没有 mbstring 或第三方库，在内部使用 UTF-8 是不切实际的。很难剔除在 UTF-8 中无效的字符，或者从其他格式转换到 UTF-8([utf8 _ encode](http://www.php.net/utf8-encode)函数无法检测或过滤出无效字符——它只是假设输入是有效的 ISO-8859-1)。

utf8_encode 函数中的[注释](http://au.php.net/utf8-encode#usernotes)展示了人们在代码中使用字符编码时遇到的问题。

## 分享这篇文章