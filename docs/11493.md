# 克服您的缓存难题

> 原文:[https://www.sitepoint.com/overcome-cache-conundrums/](https://www.sitepoint.com/overcome-cache-conundrums/)

处理浏览器缓存是一种平衡行为。一方面，您的目标是通过确保图像、脚本和样式表被访问者缓存来最小化加载时间和带宽使用；但是，您仍然希望确保他们正在访问您所有文件的最新版本。

在本文中，我将向您展示几种控制浏览器如何缓存站点文件的方法，这样您就可以两全其美:在保持最佳性能的同时，确保所有用户都能立即看到任何更新，而不会遇到任何问题。

## 问题的来源

假设您在页面中包含一个样式表，带有如下所示的链接标签:

```
<link rel="stylesheet" href="/css/styles.css" type="text/css" />
```

浏览器将获取文件`/css/styles.css`一次，然后缓存该文件。这通常是一种理想的行为。对于缓存了您的样式表的访问者，您的站点将加载得更快，因此您的服务器将处理更少的请求并消耗更少的带宽。

默认情况下，缓存文件相对较快地过期。这意味着，虽然您或您的团队可能会在做出更改后立即遇到缓存样式表的问题，但不经常访问的站点访问者(比如每隔几天访问一次)可能不会注意到缓存内容的任何问题。然而，这也意味着访问者将经常下载不必要的文件，导致更长的加载时间和浪费带宽。

为了提高性能(也许是受到一个伟大的网站性能基准测试工具 YSlow 的启发)，你会希望让浏览器在更长的时间内缓存来自你网站的文件。你可以在韦恩·谢伊(Wayne Shea)的文章[中找到更多关于如何做到这一点的信息，在这篇文章中，他主张将你的服务器配置为给你的内容附加“过期”标题，告诉浏览器将这些文件保存在缓存中几周或几个月。](https://www.sitepoint.com/article/save-cash-optimize-cache)

但是这样做之后，当你对图片、样式表或者脚本进行修改时，你的站点的访问者可能会遇到问题。你可能认为这是相当无害的——简单地向一些访问者呈现一个过时的网站版本似乎是一个相对较小的问题。但是，如果一些元素(如 HTML)被更新，而另一些元素(如 JavaScript 文件)从缓存中加载，则功能元素可能会对用户显示为中断。

## 解决方案

有几种方法可以解决这个问题，我将按照复杂程度的顺序来介绍它们。它们都涉及到同一个主题的一些变化:欺骗浏览器，让它认为下载的文件与缓存的文件不同。

### 修改文件名

最简单的解决方法是在每次更新样式表、图像和 JavaScript 文件时对它们进行重命名。例如，您可以在文件名中包含一个版本号，如下所示:

```
<link rel="stylesheet" href="/css/styles.1234.css" type="text/css" />
```

虽然这已经足够好了，但是如果你经常改变你的文件或者有大量的静态资源，这很快就会变得乏味。然而，它确实有一个优势，即可以兼做基本的源代码控制——您可以在文件系统中保存对站点所做的所有更改的历史记录。

### 查询字符串

另一种流行的方法是在文件名末尾添加一个查询字符串，例如:

```
<link rel="stylesheet" href="/css/styles.css?v=1234" type="text/css" />
```

使用这种方法，每次更改查询字符串中的版本号，都会迫使浏览器获取新版本的样式表、图像或 JavaScript 文件。这种方法的优点是不需要重命名文件本身；你只需要改变你的 HTML 中的引用。

然而，查询字符串方法有一些注意事项。首先，在某些情况下，它可能与文件名后的查询字符串的另一个合法需求相冲突(尽管这对于静态资源来说不太可能)。另一个更重要的缺点是，如果修改 CSS 中使用的图像(例如，作为背景图像)，还需要编辑样式表，将查询字符串追加到每个图像引用中。根据样式表的大小、它们引用的图像数量以及修改这些图像的频率，这可能需要大量的工作。

### 路径法

最后一种方法——也是我想重点介绍的方法——包括将版本信息包含在资源的 *路径* 中，而不是包含在文件名或查询字符串中。比如说:

```
<link rel="stylesheet" href="/css.1234/styles.css" type="text/css" />
```

您可能认为这将涉及与重命名文件本身一样多的工作。虽然这在理论上是正确的，但在实践中有一个聪明的变通方法可以让你不必这么做。

我们要做的是使用重写规则使 URL `/css.1234/styles.css`(以及该路径的任何其他数字变体)指向服务器上的`/css/styles.css`。要用 Apache 做到这一点，您需要使用`mod_rewrite`。如果您已经安装了`mod_rewrite`并且拥有对`.htaccess`文件的权限，那么为此设置一个规则就很简单了。您可以将以下几行添加到位于您站点的根 web 文件夹中的`.htaccess`文件中:

```
RewriteEngine OnRewriteRule css[.][0-9]+/(.*)$ css/$1 [L]
```

这个规则使用一个正则表达式来匹配由以下部分组成的任何路径:`css`，后面是一个句点(`.`，后面是任意数量的数字字符，最后是一个斜杠。任何匹配这个模式的路径都将被重写为`/css/<filename>`。`[L]`(意为“最后”)指定不应对该请求应用进一步的重写规则。如果包含您的样式表的目录与`css`的名称不同，您需要相应地调整规则，用您的目录名替换`css`的两个实例。

## 图片

图像呢？你 *可以* 手动将上面列出的任何一种方法应用到你网站上的每一个图片 URL 这包括样式表中的所有`url()`语句和每个`img`标签的每个`src`属性。

不过，那会是很大的工作量。幸运的是，事实证明这是不必要的。如果您使用 path 方法来处理 CSS 文件的缓存，那么您可以自动获得使用`url()`加载到样式表中的图像的缓存控制的好处，而无需任何额外的工作。

这种技术依赖于一个经常被抱怨的事实:CSS `url()`属性是相对于 *样式表* 的位置，而不是样式化文档的位置。

为了使这种方法有效，样式表中使用的图像必须位于样式表所在位置的子文件夹中(例如，`/css/images/`而不仅仅是`/images/`)。这无论如何都是有意义的，因为样式表使用的资源在逻辑上是与样式表本身组合在一起的。

它是如何工作的？在您的样式表中，您可能有这样的规则:

```
#foo{    background-image: url(images/foo-background.png);}
```

按照前面描述的路径方法，您可以在文档中包含带有如下标记的样式表:

```
<link rel="stylesheet" href="/css.1234/styles.css" type="text/css" />
```

因为样式表中的图像是相对于样式表的路径的，所以您使用的图像的路径现在是`/css.1234/images/foo-background.png`！这个 URL 将被`RewriteRule`重写，就像 CSS 文件本身的 URL 一样。

任何时候你改变样式表中的 CSS 或者它引用的图像，你可以简单地改变这个版本号，所有你站点的访问者将检索到正确的样式和图像。除了比单独更改每个图像参考要少得多的工作之外，您还可以避免忘记任何图像，因为这都是自动完成的。

## JavaScript

我还没有明确提到 JavaScript 文件，但是当然任何用于 CSS 的方法也可以用于 JavaScript。因此，对于 path 方法，您应该有一个脚本标记，如下所示:

```
<script src="/js.1234/scripts.js" type="text/javascript"></script>
```

以及重写规则，例如:

```
RewriteRule js[.][0-9]+/(.*)$ js/$1 [L]
```

这些说明假设您的`.js`文件位于`/js/`目录中，因此您可能需要调整它们以匹配您站点的目录结构。

## 结论

只有最小的网站才能忽略浏览器缓存。当您考虑到缓存并设计您的站点来利用它时，您可以为您的用户显著提高性能，并节省带宽成本。但是就像任何技术一样，它很容易被错误地使用，很快就会导致比它的价值更令人头疼的问题。使用我描述的方法，您应该能够以尽可能少的努力从浏览器缓存中获得最大的收益。

记住缓存只是站点优化策略的一部分也很重要；在你所有的网站上下载并使用 YSlow 来确保你给你的访问者提供最快的体验。祝你好运，并快乐优化！

## 分享这篇文章