# 如何使用触发器和事件自动化您的数据库

> 原文：<https://www.sitepoint.com/database-triggers-events/>

数据库非常强大。不幸的是，他们以复杂而神秘的野兽著称，由说着奇怪语言的黑暗领主统治。我犯了开发 web 应用程序的错误，这些应用程序避开了我不了解的伟大的数据库技术。我不认为我是孤独的——许多开发人员更喜欢重新发明 PHP 的轮子，而不是实现数据库功能，这样可以节省时间和精力，同时提高性能。

今天，我们将看看**触发器**和**事件**——大多数流行的商业和开源数据库系统支持的特性…

## 扳机

触发器是在特定数据库表上发生插入、更新或删除 SQL 事件之前或之后运行的代码。该代码可以验证或修改传入的数据、执行计算、运行更多的 SQL 命令等。

MySQL、PostgreSQL、SQLite、Firebird、DB2、Microsoft SQL Server 和 Oracle 都支持触发器。实现各不相同，因此您应该在编码前查阅适当的文档。

## 事件(或时间触发器)

事件通常被称为“时间触发器”，因为它们是按时间而不是表更新来安排的。事件可以计划在特定时间段运行一次或多次。实际上，它们是数据库专用的 cron 作业，可以用于归档数据、清理日志或为复杂的报告计算信息。

支持事件的数据库较少，但大多数都提供类似的解决方案。在典型的 web 应用程序中，并不是所有的都很容易实现，所以请查看您的文档。

## 什么时候应该使用触发器？

触发器可以简单也可以复杂。也就是说，有一些情况应该避免:

1.  不应使用触发器来代替[外键约束](https://www.sitepoint.com/mysql-foreign-keys-quicker-database-development/)。外键强制引用完整性，因此不可能添加、删除或编辑会留下孤立记录的数据。例如，如果你从你的社交网络系统中删除了一个用户，你不一定希望来自那个人的消息被保留。
2.  触发器不能替代[事务](https://www.sitepoint.com/mysql-transactions-php-emulation/)。触发器代码可能会失败，因此您仍然应该在单个事务中包装相关的更新。
3.  小心不要在数据库和后端系统(用 PHP、C#、Java 等编写)之间分割业务逻辑。如果你的代码是分离的，维护会变得更加困难。
4.  避免重复劳动。您的后端代码应该清理用户输入，这样就没有必要在数据库中重复这些检查。
5.  触发器会导致性能开销。它们将比后端代码传递的一系列 SQL 命令执行得更快，但是您应该避免在定期修改的表上使用复杂的触发器。

理想情况下，当触发器自动执行特定于数据库或其数据管理的更改时，应该考虑触发器。审计日志就是一个很好的例子。考虑一个类似 WordPress 的 CMS 系统，它有一个包含标题和正文内容的“博客”表。“审计”表可以记录文章被添加、编辑或删除的日期和时间。您的 web 系统可能永远不会显示这些信息，甚至不知道这些信息已经被记录下来，因此触发机制是理想的选择。

我们的“博客”表将与“审计”表有一对多的关系；换句话说，一个或多个审计记录将指向一个员额。假设我们的系统想要检索标题、正文内容和最后更新日期，即文章本身及其在“审计”表中最后记录的条目。我们可以获得这些信息，但是 SELECT 命令很复杂，需要子选择来确保我们只检索最后的审计记录。

触发器可以帮助我们降低复杂性并提高性能。例如，我们可以在“博客”表中添加一个“last_audit_id”字段。每当一篇文章被更新时，一个新的条目将被添加到‘audit’表中，其 ID 将被记录在 blog.last_audit_id 中。

## 什么时候应该使用事件？

计划事件非常适合在非高峰时段批处理大量数据。

假设我们想从“博客”表中删除一篇文章。我们不执行 SQL DELETE，而是将一个布尔‘deleted’字段设置为 true，这样就可以取消删除 post。过一会儿，我们的表会变得更大、更慢，并且可能包含很大一部分被删除的文章。为了解决这个问题，可以每周运行一次预定事件，将旧的已删除帖子和审计记录移动到归档表中。它还可以在一篇文章达到特定年龄时，将其删除。

这些只是简单的建议，您的应用程序会有不同的要求。幸运的是，web 上最常用的关系数据库系统 MySQL 5.x 支持触发器和事件。

另请参见:

*   [PHP 开发人员犯下的 10 大 MySQL 错误](https://www.sitepoint.com/mysql-mistakes-php-developers/)
*   [如何使用 MySQL 外键加快数据库开发](https://www.sitepoint.com/mysql-foreign-keys-quicker-database-development/)
*   [MySQL 事务&为什么它们不能在 PHP 中被模拟](https://www.sitepoint.com/mysql-transactions-php-emulation/)

## 分享这篇文章