# 闪电网络如何帮助区块链扩大规模

> 原文:[https://www . site point . com/how-the-lightning-network-helps-区块链-scale/](https://www.sitepoint.com/how-the-lightning-network-helps-blockchains-scale/)

*这篇关于闪电网络的介绍最初发表在 [Bruno 的 Bitfalls 网站](https://bitfalls.com/2018/04/15/lightning-network-work/)上，经允许在此转载。*

由于缓慢而昂贵的交易困扰着它的[区块链](https://www.sitepoint.com/blockchain-what-it-is-how-it-works-why-its-so-popular)，比特币目前无法使用。大多数人把它作为价值储存手段(数字黄金谬误)或者在交易所交易。一个被称为闪电网络的概念被引入作为这个*可扩展性*问题的解决方案。

## 闪电网络的基础知识

Joseph Poon 和 Thaddeus Dryja 在 2015 年的白皮书中首次描述了闪电网络。然而，这个概念实际上是由中本聪在 2013 年写给迈克·赫恩的[邮件中介绍的。](https://lists.linuxfoundation.org/pipermail/bitcoin-dev/2013-April/002417.html)

闪电网络通过*支付渠道*工作，这些支付渠道实际上是多签名钱包(多重签名)。多签名[钱包](https://bitfalls.com/2017/08/31/what-cryptocurrency-wallet/)只是一个[比特币地址](https://bitfalls.com/2017/09/01/send-receive-bitcoin/)，它需要几个所有者的签名或[私钥](https://bitfalls.com/glossary/#private-key)才能使用该地址中的钱。你可以把它们看作银行保险库，需要同时转动两把不同的钥匙才能打开。

![A vault with two keys](../Images/d7f16f1d7829b948c3e51806b08700d2.png)

例如，多签名钱包可以是已婚夫妇的共同比特币地址，其中他们都必须签署交易才能花费他们的共同比特币。

支付渠道的目的是定期执行小额支付和避免高额交易费用。LN 渠道的理想关系包括雇员-雇主、消费者-生产者、公用事业提供商-公用事业消费者、咖啡饮用者-咖啡店等。这个想法是让顾客在他的咖啡店开一个支付通道，定期支付咖啡而不必等待确认(目前是 10 到 60 分钟)。

## 闪电网络是如何工作的

![Alice and Bob](../Images/e411d379989b7a12e3bae2a1c9af640f.png)

我们用一个循序渐进的例子来解释一下。我们想象的场景如下:

鲍勃想付钱给艾丽斯为他写文章。这笔交易是总共 100 个职位 10 BTC，或每个职位 0.1 BTC。

在传统的比特币系统中，这平均需要一个小时，每笔交易的费用为 5 至 500 美元，具体取决于网络的积压程度。因为爱丽丝和鲍勃都是比特币狂热主义者，他们选择开设一个 LN 频道，而不是选择更便宜、更容易使用的 T2 替代币。

### 步骤 1:打开频道

![Bob sends an initial channel-opening transaction](../Images/94adbe9af869bcd795d064e479445dc7.png)

Bob 在主链上创建了一个常规的比特币交易，定义如下:

*   他在和谁开频道
*   他向频道发送了多少 BTC(10 BTC)
*   经过多长时间(在这种情况下为一周)后，如果爱丽丝没有回应，他有权收回 10 BTC。

后者实际上是主交易中的子交易，具有“时间锁”功能，确保尽管双方已经确认，但资金在一周内是不可移动的。

因此，Bob 向 Alice 发送了两笔交易——一笔交易中，他建议在随该交易一起打开的 multi-sig 上用 10 BTC 的存款打开一个支付通道，另一笔交易中，他说如果通道中一周没有任何活动，10 BTC 将返还给他。

### 步骤 2:接受通道的开放

![Alice accepts and signs](../Images/a9e41bc3f8d8435f64e611a9c1a46d98.png)

Alice 收到两个交易，其中她可以看到 Bob 在多签名地址上提供 10 BTC，他们两个是参与方。她还可以看到他增加了一个条件，在一周不活动后把钱还给他。她接受这一点，并在交易上**签名**，之后她**广播**交易，交易被发送到主区块链，最终完成了频道的创建。

![Signed transactions waiting](../Images/c5cab0921ac1f2fb451aaa381a520b7f.png)

*这里定义两个概念很重要:**签署**交易和**确认或广播**交易。已签署的交易只是准备发送到区块链，并构成双方之间的协议。在区块链上是看不到的。广播或确认的交易被发送到区块链，并关闭支付通道，结算余额。*

对第一笔交易进行签名打开了通道，并使得 Bob 的 10 BTC 被存入多签名地址。签署另一个，尽管允许鲍勃拿回所有 10 个 BTC，只能在一周后生效。

![Channel is open, transactions are in the blockchain](../Images/27229bc8bd6449cf74c1a7d7f97b9074.png)

爱丽丝和鲍勃现在有一周的时间来做第一件事。

### 3.发送第一笔交易

爱丽丝写了一篇文章，鲍勃喜欢它。他通过执行以下操作支付 0.1 BTC:

*   他生成了一个新的事务，声明“我从包含 10 个 BTC 的多签名地址发送 0.1 个 BTC，我向自己发送 9.9 个”。除此之外，他还生成了另一笔交易:“如果前一笔交易在签署后一周内没有播出，那么我会从 multi-sig 地址向自己发送所有 10 个 BTC”。
*   他通过闪电网络[节点](https://bitfalls.com/2017/11/26/whats-bitcoin-node-mining-vs-validation/)将交易发送给爱丽丝签名，而不发送给主区块链。记住:交易只有在双方签字并广播后，才能在区块链完成。
*   爱丽丝收到交易并检查条件:0.1 BTC 为一篇文章，好，一周接受并得到 0.1 BTC，这意味着我有一周的时间来发送一篇新文章。

![Bob sends the first transaction](../Images/fb49ac0482991ef2178c4cc8a28e6883.png)

爱丽丝不必签署这些新的交易。如果没有回复，她将触发为期一周的暂停，这将把钱退还给 Bob 并取消他们的安排。为了保持交易公开，她需要通过签署协议而不公开来保持交易“公开”。

这个“留在桌子上”是闪电网络节点正在处理的部分。该软件接受并签署交易，但仅在 LN 层，而不是主要的比特币区块链。在来自 Alice 的签名之后，通道的*新状态是有效状态*。

![Alice signs](../Images/2efe59dda9d621c3dc67274f79d7d2a9.png)

在任何给定的时间点，该事务都是不可变的，并且在发生任何变化之前，必须满足其中描述的条件:要么需要一周期满，要么需要由 Alice 或 Bob 广播该事务，以最终确定最新的分布:0.1–9.9 BTC。

### 4.发送第二个事务

三天后，Alice 发送了一篇新文章，由 Bob 发送一篇新的 0.1 版 BTC。由于不可能改变现有的事务，并且 Bob 不能像以前一样将另一个 0.1 发送到同一事务中，所以他生成了一个新的事务，该事务说:“从具有 10 个 BTC 的多签名地址，我将 0.2 个 BTC 发送给 Alice，9.8 个发送给我”，以及另一个“如果 Alice 没有在一周内签名并广播该状态，我将得到所有 10 个 BTC”。

![The new transaction overwrites the old](../Images/b927f6eb640e7c7dd3a7db76dac2c87d.png)

爱丽丝现在有机会要么签署并广播新的交易，从而获得 0.2 BTC 并结束工作关系，要么继续这样做，发送更多的文章，并获得更多的这种增量交易。她也可以保持离线或闲置一周，失去这一切。

![Alice signs the second transaction](../Images/6f8c63708a8d4e5d016284b1ecb29c4b.png)

### 5.扣工资

在第二篇文章中，爱丽丝指控一家竞争公司剽窃，但没有做足够的事实检查。这损害了公司的声誉，鲍勃决定从她的工资中扣除 0.05 英镑。

Bob 生成了一个新的事务，该事务表示“从具有 10 个 BTC 的多签名地址，我将向 Alice 发送 0.15 个 BTC，向我自己发送 9.85 个 BTC”，旁边还有一个事务表示“如果 Alice 不在一周内签名并广播此消息，我将获得所有 10 个 BTC”。

![Docked payment](../Images/5616c381be8bf71dc8a582583cda2aab.png)

爱丽丝现在有以下选择:

*   容忍减薪并签署交易，继续工作
*   播放最后一次签约的交易，0.2 BTC 的交易，得到比鲍勃目前提供的更多的钱，但这将结束他们的关系
*   不回应，失去一切。

### 5a。爱丽丝作弊

让我们假设，由于第二篇文章的事件，这种关系已被永久破坏，爱丽丝想退出，但她已经签署了 0.15 BTC 交易。她能决定签署 0.2 BTC，而不是仍然在桌子上吗？

![Alice aims to send an older transaction](../Images/72217ee98bf80d2605f19d7f044435fa.png)

LN 的设置方式是，已签名(但未发送)的交易按时间排序。试图发送旧的签名交易在网络中是一种应受惩罚的违法行为，它将来自多方签名的所有钱发送给非违法方。

这个安全系统确保只有最新签署的交易可以被广播，但也有其他含义:它要求用户不断在线，以使他们的节点能够相互通信。为了防止用户不得不一直在线，引入了了望塔的概念，我们将在另一篇文章中解释。

### 5b。鲍勃作弊

让我们假设鲍勃是骗子。Alice 发送了第三篇文章，但是 Bob 决定通过不付款来进一步惩罚她。爱丽丝不知道她是否还能得到报酬，她想结束这段关系。她可以简单地广播最后签署的交易，0.15 BTC 将被发送给她。她只会损失她写一篇(第三篇)文章所花的钱。

![Last transaction is still OK for sending to the blockchain](../Images/3fbf6890154320115de8856a87e98314.png)

但是如果这进一步冒犯了 Bob，并且他决定发送另一个事务，在该事务中他说“从多签名地址，我发送 0 给 Alice，10 给我，并且如果她不在一周内签名和广播，它都是我的”。

这就是前面提到的签名和广播事务的概念发挥作用的地方。LN 交易要有效，需要双方签字。如果未签名，则最后签名的交易对广播有效。

![Alice rejects Bob's attempt at a robbery](../Images/9760295e3e5113f02fc1083c7e3f20b8.png)

这使得爱丽丝免受最终的欺诈。

### 5c。一切都好

对每个人来说最好的选择是 Alice 完美地完成她的工作，Bob 发送增量事务。假设爱丽丝又犯了一两个错误，最后赚了 9.9 BTC，那么鲍勃最新的交易就是这么说的:爱丽丝 9.9 BTC，他 0.1 BTC。双方都对该协议感到满意，爱丽丝签署了*并广播了*该交易。

![Alice signs and broadcasts the last transaction](../Images/a5c3985458d22ca4a45afd74560e73fe.png)

会发生以下情况:

*   Alice 签署并广播该交易，并将其写入区块链。
*   交易需要支付交易费，从支付总额中扣除。鉴于现在只有一个 tx，而不是 100 个，这只是一个 tx 的成本。
*   在 10 分钟到 1 小时内，交易将在比特币区块链上完成，钱将被转移，通道关闭。

![The final transaction is in the blockchain](../Images/5aade242922f2a5ea93e0bf446e827c1.png)

值得注意的是，虽然这个过程听起来非常复杂，但他们正在努力掩盖这种复杂性，并对用户隐藏起来。预计支付渠道在最终用户软件中是不可见的。

## 网络和路由

在上面的例子中，Alice 和 Bob 有一个明确定义的关系，并有一个最终目标。理论上，由于*路由*，支付渠道将无限期保持开放。这个想法是连接几个节点，然后将支付从一个节点路由到另一个节点，允许支付通过连接的节点发送到没有连接的节点。这个软件应该能找到到达那里的方法。

例如，如果爱丽丝与平面设计师 Roko 一起工作，鲍勃也与他一起工作，让我们假设爱丽丝需要完成 0.1 BTC 平面设计工作。她可以通过鲍勃将此发送给 Roko，只要鲍勃在对 Roko 开放的通道中至少有 0.1 BTC，并且爱丽丝在对鲍勃的余额中有 0.1 BTC。在这种情况下，Bob 正在运行一个介体闪电网络节点。

![Sending through Bob to Roko](../Images/18b9345d27fce816a0f866075f7f09d4.png)

问题是，如果有人已经通过鲍勃支付了 Roko，而鲍勃对 Roko 不再有 0.1 的 BTC 余额，那么没有其他人可以通过鲍勃支付 Roko；他们需要找到另一条路。[这个视频很好的解释了这一点](https://www.youtube.com/watch?v=pOZaLbUUZUs)。

这是一个保持渠道无限期开放和永久锁定 LN 资金的论点，因为它假设 LN 的受欢迎程度将如此之大，任何人都可以在任何地方向任何人支付。但是所有这些都有自己的问题，我们将在另一篇文章中讨论。

## 结论

本质上，LN 是对比特币网络中目前*不存在*的一些问题的实际解决方案。这是否使其成为一种高效的比特币缩放方式？我们认为不会，因为有些问题似乎不可能解决。然而，我们确实觉得这个概念很有趣，并期待看到开发人员能把它带到哪里。

## 分享这篇文章