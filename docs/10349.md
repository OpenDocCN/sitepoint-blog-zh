# MySQL 事务&为什么它们不能在 PHP 中被模拟

> 原文:[https://www.sitepoint.com/mysql-transactions-php-emulation/](https://www.sitepoint.com/mysql-transactions-php-emulation/)

我最近的一篇文章[“PHP 开发人员犯的 10 大 MySQL 错误”](https://www.sitepoint.com/mysql-mistakes-php-developers)比我想象的更有争议。一些更有趣的回答来自 PHP 程序员，他们认为事务是不必要的开销。他们认为，有了高质量的 PHP 代码，你就不需要事务或 MySQL 的 InnoDB 存储引擎。

当然，你并不总是需要交易。然而，它们是有用的——不仅仅是银行或金融应用。每当您需要更新两个或更多记录并希望确保它们都成功时，应该使用事务。

例如，假设我们正在创建一个简单的购物车系统。购买后需要进行三次更新:

1.  将客户的详细信息添加到数据库中
2.  标记购物车中的物品已经被购买
3.  相应减少库存物品的数量

在 SQL 代码中，这可以解析为:

```
INSERT INTO customers (name,email,cartid) VALUES ('Customer1','customer@email.com',123);
UPDATE cart SET status='paid' WHERE id=123;
UPDATE product SET stock=stock-1 WHERE id=567; 
```

我们不希望任何更新被破坏。如果最后一个声明失败，我们的库存水平不会相应减少，客户可以订购不可用的产品。

现在我不会怀疑你的 PHP 代码的质量了。您可以运行这些 SQL 更新并验证它们是否成功。您甚至可以查询现有数据，以便在出现故障时可以恢复到原始记录。

可惜，这还不够。您的代码可能是完美的，但 PHP 解释器肯定不是。运行它的网络服务器也是如此。也不是你正在使用的操作系统(是的，甚至是 Linux)。MySQL 也可能消失。让我们不要忘记硬件…处理器死亡。硬盘崩溃。记忆失效。服务器爆炸。IT 管理员踢掉网络电缆。电力网关闭了。托管公司破产。

简而言之，你永远不能确定一个 PHP 程序会成功运行并按预期执行所有的 SQL 命令。但是，在发生灾难性故障时，您可以防止数据库被污染。

## 酸是解药

事务提供原子性、一致性、隔离性和持久性。本质上，当您提交事务时，一组包装在事务中的 SQL 更新肯定会应用到数据库。如果不提交，更新永远不会发生。如果发现错误，您还可以撤消所有更新。

与流行的观点相反，事务并不一定会降低应用程序的速度。更新是一次批量应用的，因此可以提高效率。在某些情况下，在 web 页面的开头启动一个事务并在结尾运行 COMMIT 可能是合理的。

## InnoDB 或 Bust

MySQL 的默认 MyISAM 存储引擎不支持事务，所以它不是一个选项。如果您想要使用事务，请确保您的所有表都被定义为 InnoDB。即使您现在不使用事务，您也永远不知道您的应用程序将如何发展——如果有疑问，InnoDB 是最佳选择。

## 使用交易

尽管笼罩在神秘之中，但交易非常简单。以下 SQL 语句启动一个事务:

```
START TRANSACTION; 
```

或者，您可以使用:

```
SET autocommit=0; 
```

默认情况下，每个 SQL 语句都在自己的事务中运行。关闭自动提交会取消此操作，因此所有后续的 SQL 更新都是单个事务的一部分。

**note:** Alternative PHP transaction methods

当开始一个事务时，PHP 提供了一些其他的选择。如果使用 PDO 库，可以执行 [beginTransaction()](http://php.net/manual/en/pdo.begintransaction.php) 方法。对于 mysqli，将 false 传递给[自动提交()](http://uk3.php.net/manual/en/mysqli.autocommit.php)方法。

现在事务已经开始，我们可以运行任意数量的 SQL 查询、插入、更新和删除。在我们确定它是正确的之前，没有一个命令会永久影响数据库。此时，我们运行:

```
COMMIT; 
```

假设单个命令成功运行，我们可以确定我们的数据库被更新了。PHP PDO 和 mysqli 库也提供了`commit()`方法。

但是如果出了问题呢？也许顾客被允许订购一件没有库存的商品？我们可能不希望我们的库存水平被设置为-1，所以我们可以取消整个交易并提醒管理员。

如果我们不执行提交，当 PHP 页面结束时，不会应用任何数据更新。然而，由于我们都是优秀的程序员，我们应该明确声明我们想要使用以下命令来撤消事务:

```
ROLLBACK; 
```

或者，PHP PDO 和 mysqli 库提供了`rollback()`方法。

简而言之，这就是交易。有几个陷阱和例外，但是我们将把它们留到我的下一篇文章中。现在，享受你的应用程序的事务化吧！

## 分享这篇文章