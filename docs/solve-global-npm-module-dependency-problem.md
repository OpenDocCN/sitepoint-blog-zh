# 如何解决全局 npm 模块依赖问题

> 原文：<https://www.sitepoint.com/solve-global-npm-module-dependency-problem/>

[节点包管理器](https://www.npmjs.com/)(又名 npm)让 web 开发人员可以轻松访问大量出色的 JavaScript 模块，并让我们在寻找和管理应用程序的依赖关系时变得更加轻松。这也使得开发人员很容易创建和[发布他们自己的模块](https://quickleft.com/blog/creating-and-publishing-a-node-js-module/)，这意味着其他开发人员可以通过一个简单的`npm install -g your-tool`来获取它们，并在他们想要的任何时候开始使用它们。是乌托邦！对吗？

呃，实际上…

## 我们有一点小问题

我永远不会说在安装 npm 模块时不要使用`-g`选项，但是我不得不说我们过多地使用它会导致问题。有几个原因让我认为我们应该减少使用全局模块安装，尤其是在构建、测试或林挺工具的情况下，比如 [Gulp](https://www.npmjs.com/package/gulp) 、 [Karma](https://www.npmjs.com/package/karma) 、 [JSHint](https://www.npmjs.com/package/jshint) 以及无数其他工具。在这篇文章中，我主要指的是 Gulp，因为它很流行，说起来也很有趣，但是如果你不喜欢 Gulp，就在心里用你喜欢的东西代替它。

首先，全局模块没有被列为项目中的依赖项，即使您的项目依赖于它们，这会给使用您的应用程序的其他人带来额外的步骤。您知道您需要使用 Gulp 来为您的项目做好生产准备，所以您全局安装并使用它。当其他人想要开始工作，或者使用你精彩的开源项目时，他们不能只是键入`npm install`就开始工作。最后，您不得不在自述文件中添加一些说明，大致如下

**要使用该项目，请遵循以下步骤**:

*   `git clone`回购
*   运行`npm install`
*   运行`npm install -g gulp`
*   运行`gulp`进行构建

我看到了两个问题:首先，你增加了全局安装 Gulp 的额外步骤，其次，你直接运行了`gulp`。我看到了一个本来可以避免的额外步骤(全局安装 Gulp ),我看到用户需要知道你的应用程序使用 Gulp 来构建项目。第一个问题是我在本文中要解决的主要问题，尽管第二个问题不太严重，但是如果您最终要切换工具，您将需要更新说明。我稍后讨论的解决方案应该可以解决这两个问题。

与全局安装模块相关的第二个大问题是，由于安装了错误的模块版本，您可能会遇到冲突。以下两个例子说明了这一点:

*   你在六个月前创建了你的项目，当时你使用的是最新版本的 Gulp。今天，有人克隆了您项目的回购协议，并试图运行`gulp`来构建它，但是遇到了错误。这是因为克隆你的项目的人要么运行的是 Gulp 的旧版本，要么是新版本，这两个版本有一些重大的不同。
*   你六个月前创建了一个使用 Gulp 的项目。从那时起，你已经转移到其他项目，并在你的机器上更新 Gulp。现在你回到这个老项目，试着运行`gulp`，你会遇到错误，因为自从你上次接触这个项目以来，你已经更新了 Gulp。现在，在项目取得任何进展之前，您必须更新您的构建过程以使用新版本的 Gulp，而不是将其推迟到更方便的时候。

这些都是潜在的严重问题。就像我之前说的，我不会一概而论地告诉你永远不要全局安装。也有例外。

### 关于安全性的简要说明

默认情况下，在某些系统上，全局安装 npm 模块需要提升权限。如果你发现自己在运行类似`sudo npm install -g a-package`的命令，你应该改变这一点。我们的[NPM](https://www.sitepoint.com/beginners-guide-node-package-manager/)初学者指南告诉你怎么做。

## 规则的例外

那么可以全球安装什么呢？简单来说:你的项目不依赖的任何东西。例如，我安装了一个名为[本地网络服务器](https://www.npmjs.com/package/local-web-server)的全局模块。每当我想在浏览器中查看一些 HTML 文件时，我只需运行`ws`(这是本地 web 服务器的命令)，它会将当前文件夹设置为`localhost:8000`的根目录，我可以在浏览器中弹出打开该目录下的任何文档，并对它们进行测试。

我还会遇到这样的情况，我想要缩小不属于项目的 JavaScript 文件，或者至少不属于允许我建立正式构建过程的项目的一部分(出于愚蠢的“公司”原因)。为此，我安装了 [uglify-js](https://www.npmjs.com/package/uglify-js) ，我可以在几秒钟内从我的命令行轻松缩小任何脚本。

## 解决方案

既然我们知道问题可能出现在哪里，我们如何预防它们呢？当你安装模块时，你需要做的第一件事就是移除那个`-g`。你应该用`--save-dev`来替换它，这样你就可以把这个模块保存为一个开发依赖项，当有人运行`npm install`时，它就会一直被安装。这只解决了我提到的一个小问题，但这是一个开始。

您需要知道的是，当您在本地安装一个依赖项时，如果它有任何要从命令行运行的脚本，它们将被放在`./node_modules/.bin/`中。所以，现在，如果你只是在本地安装 Gulp，你可以通过在命令行输入`./node_modules/.bin/gulp`来运行它。当然，没有人想把整件事都输入进去。你可以用 [npm 脚本](https://docs.npmjs.com/misc/scripts)来解决这个问题。

在您的`package.json`文件中，您可以添加一个类似如下的`scripts`属性:

```
{
    ...
    "scripts": {
        "gulp": "gulp"
    }
}
```

现在你可以在任何时候运行本地版本的 Gulp。npm 脚本会在检查您的`PATH`之前，在`./node_modules/.bin/`目录中寻找一个可执行命令的本地副本。如果你愿意，你甚至可以通过在参数前添加`--`来传递其他参数，例如`npm run gulp -- build-dev`相当于`gulp build-dev`。

糟糕的是，如果你在全局范围内使用 Gulp，你仍然需要输入更多的内容，但是有两种方法可以解决这个问题。第一种方法是使用 npm 脚本来创建别名，这也解决了我前面提到的一个问题。例如，您不必将您的应用程序绑定到 Gulp，因此您可以创建运行 Gulp 的脚本，但不要提及 Gulp:

```
{
    ...
    "scripts": {
        "build": "gulp build-prod",
        "develop": "gulp build-dev"
    }
}
```

这样，您可以使您的调用更短，并保持您的脚本通用。通过保持它们的通用性，你可以在任何时候透明地移除 Gulp，并用其他东西替换它，没有人需要知道(除非他们在构建过程中工作，在这种情况下，他们应该已经知道了，并且可能已经成为远离 Gulp 的对话的一部分)。可选地，您甚至可以在其中加入一个`postinstall`脚本，以便在有人运行`npm install`之后立即自动运行构建过程。这将清理您的自述文件相当多。此外，通过使用 npm 脚本，任何克隆你的项目的人都应该在`package.json`文件中获得关于你在项目中运行的所有过程的简单而直接的文档。

除了使用 npm 脚本，还有一个技巧可以让你使用命令行工具的本地安装:一个相对的`PATH`。我将`./node_modules/.bin/`添加到我的路径中，这样只要我在一个项目的根目录中，我就可以简单地通过输入命令名来访问命令工具。我从[对我写的另一篇文章](http://www.joezimjs.com/javascript/no-more-global-npm-packages/#comment-1952307113)的评论中学到了这个技巧(感谢 [Gabriel Falkenberg](https://disqus.com/by/kitbuilder/) )。

这些技巧并不一定能取代你想使用 Gulp 这样的工具的每一种情况，而且它们的设置也需要一些工作，但是我相信在你的依赖项中包含这些工具应该是一种最佳实践。这将防止版本冲突(这是依赖性管理器背后的主要原因之一)，并且将有助于简化某些人接手您的项目所必需的步骤。

## 超越自我

这可能有点过分，但我也相信 Node 和 npm 是您的项目的依赖项，有几个不同的版本可能会冲突。如果您想确保您的应用程序适用于所有人，那么您需要某种方法来确保用户也安装了正确版本的 Node 和 npm。

您*可以*将 Node 和 npm 的本地副本安装到您的项目中！然而，这并不能让一切都变得美好。首先，Node 在每个操作系统上是不一样的，所以每个人仍然需要确保他们下载的是适合他们操作系统的那个。其次，即使有办法安装通用节点，您也需要确保每个人都有简单的方法从他们的命令行访问 Node 和 npm，比如确保每个人都将 Node 和 npm 的本地副本的路径添加到他们的`PATH`。没有简单的方法来保证这一点。

因此，尽管我很希望能够在每个项目中强制实施特定版本的 Node 和 npm，但我想不出一个好方法来做到这一点。如果你认为这是一个好主意，并提出了一个好的解决方案，请在评论中让我们都知道它。我很想看到一个足够简单的解决方案，它可以成为一个标准的实践！

## 最后一句话

我希望您现在可以看到将您的工具列为项目的版本依赖项的重要性。我还希望您愿意做在您自己的项目中实现这些实践所需的工作，这样我们就可以将这些实践作为一个标准向前推进。当然，除非你有更好的主意，在这种情况下，大声说出来，让全世界都知道！

## 分享这篇文章