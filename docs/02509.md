# PHP 应用程序环境

> 原文:[https://www.sitepoint.com/php-application-environment/](https://www.sitepoint.com/php-application-environment/)

![phpenv](../Images/d125c4c65b476c10e4e6580d043daaf6.png)

*以下是我们最近出版的书的一个简短摘录， [Jump Start PHP Environment](https://www.sitepoint.com/premium/books/jump-start-php-environment) ，免费提供给 [SitePoint Premium 会员](https://www.sitepoint.com/premium/join)。印刷版和电子书在世界各地的商店都有出售，或者你也可以[在这里](http://shop.oreilly.com/product/9780994182647.do)订购。我们希望你喜欢这个摘录，并发现它很有用。*

这篇文章将关注应用程序环境。我们还将讨论*AMP 捆绑包，如 XAMPP，以及为什么它们是一个糟糕的选择；生产/开发平价；以及性能和调试。

## 应用环境

**应用程序环境** 是一个术语，用来描述您的应用程序在其生命周期的各个阶段所处的环境:生产环境、开发环境和登台环境。

**环境** 这个词是指围绕你的应用的硬件和软件；也就是用来给它提供动力的一切。

### 生产

我们将从最简单的环境开始: **生产环境** 。

当你 **部署** 你的应用程序时——换句话说，将它上传到一个服务器上，并使它对目标受众公开可用——你是在将它 *投入生产* ，或 *投入使用* 。生产环境是应用程序的最终目的地，也是代码的用途。

在一个应用程序的生命周期中，生产环境是 **实时服务器**——一台服务器计算机，它被设置成其他人可以连接到它并看到你的网站。此实时服务器将被配置为尽可能高效地为您的应用程序提供服务。开发过程中使用的所有额外文件都将通过一个称为编译或构建的过程从应用程序中删除，这将在后面进一步解释。

在生产中，您的站点被认为是活动的(或已部署的),可以通过自己的域访问；比如`http://mysite.com`。当你启动你的站点(将它投入生产模式)时，你有理由庆祝，因为这是你的应用程序开发过程的最后一步。

这就相当于一个厨师在餐馆里做一顿饭，然后把它送到点餐的顾客手中。

### 发展

在开发环境中，您的应用程序正在被积极地开发。 **开发环境** 就是你作为开发者用来开发 app 的电脑，包括你所有团队成员的电脑，不管他们是在你身边还是在远处。需要注意的是，尽管涵盖了这两个方面，开发环境更多地指的是你的应用程序处于 的 *状态，而不是它的物理位置——应用程序处于正在开发的*状态。**

 *在开发环境中，您有各种各样的工具可以使用——从 ide(参见第 2 章)到单元测试库和标准修正器、编译器和构建器、文件监视器等等——完成手头工作所需的任何东西。

如果我们把我们的应用程序比作智能手机，那么制造它的组装厂就是开发环境。这种环境包含所有必要的部分——屏幕、外壳、电池、各种 LEDs 每个部分在用于智能手机单元的构造之前都经过单独测试。这被称为 **单元测试**——确保每个单元都工作。

关于应用程序开发中的单元测试的例子，请参见本章末尾的“为那些想要更多的人”一节。

进一步类比智能手机组件，被测试的电池可能需要单独的充电器附件，或者可能需要使用带有人工手指的机械臂来测试屏幕，以确保屏幕的触摸灵敏度正常工作。

![robot](../Images/2a0c8d0686d363b67d3faeb52d743b8f.png)

所有这些附加组件仅在开发期间存在。当从开发环境转换到生产环境(也称为 *部署* )时，这些附加组件被移除。对于我们的应用程序，这意味着前面提到的编译/构建步骤:将各种 CSS 和 JavaScript 文件合并在一起并缩小，以减小网站的大小，使其在人们访问时显示得更快；单元测试被忽略并留在开发环境中；还有各种其他的优化(本章后面会讲到)――所有这些都是为了让最终产品在发布时最大化它的吸引力和潜力。

#### 主机和虚拟主机

当你在自己的电脑上开发时，不可能访问 URL `http://mysite.com`并期望看到你的站点；毕竟，你的网站还没有上线――它不在互联网上。为了避开这一点，看到我们的网站就像它是活的一样，我们通过定义虚拟主机来伪造互联网。

简单来说，一个 **虚拟主机** 给你电脑上安装的服务器程序下达指令，比如:如果用户在浏览器中请求`http://mysite.com`，通过 PHP 运行文件`mysite.php`，并在浏览器中显示其输出。

如您所见，这几乎与实时网站的常规请求流相同。但是是什么让浏览器向我们自己计算机的服务器程序查询`mysite.com`域名，而不是在互联网的域名服务器上查找呢？`hosts`文件。

`hosts`文件是每个操作系统上都有的特殊文件。我们在第一章“为那些想要更多的人”一节中简单提到过。它包含一个域及其相应 IP 地址的列表，因此您计算机上的任何浏览器都可以读取它并直接转到该 IP 地址，而不必与 DNS 对话来检查要去哪里。在 Windows 上，这个文件在`C:\Windows\System32\drivers\etc\hosts`中，在 Linux 和 Mac 机器上，它在`/etc/hosts`中。如果你在这个文件中放入一个 IP-name 对，计算机将服从它。我们甚至可以现在就试一试。不要害怕――没有什么会出错的。准备好了吗？

***在 Windows*** 上，进入搜索栏，输入“记事本”，一旦出现，右键点击，选择以管理员身份运行。然后系统会要求您确认。在打开的窗口中，选择文件>打开进入:我的电脑>C:>Windows>System32>驱动>等。在记事本窗口的右下角，您可能需要选择所有文件以便显示`hosts`文件。双击打开它。

在 Linux/Mac 机器上，通过搜索打开终端。 ***在 Linux*** 上，以管理员身份打开默认的文本编辑器，在终端中键入`sudo gedit`。您将被要求输入管理员密码。 ***在 OS X 的*** 上，输入`sudo /Applications/TextEdit.app/Contents/MacOS/TextEdit`，这将完成同样的任务。在任一编辑器中，进入文件- >打开，进入`/etc`目录找到`hosts`文件。双击打开它。

文件打开后，请注意前几行:它们都以散列符号(#)开头。这表明它们是 **注释** ，并且对文件没有影响。这些用来向用户解释文件的用途，它们也存在于 PHP 中。

现在，在所有这些注释行下，添加以下行:

```
208.117.229.217 bing.com
```

保存文件并在浏览器中打开`http://bing.com`。您刚刚成功地将所有对微软搜索引擎 Bing 的请求重定向到了 Google！当然，我们不想保留这些变化；你可以随意删除这一行，或者在它前面加上一个散列符号，把它变成一个注释，然后保存文件。你应该可以正常访问`http://bing.com`了。

使用这种方法，我们稍后将把所有浏览器对`http://mysite.com`(这将是我们的应用程序的示例域)的请求重定向到我们自己的计算机服务器。这将使我们能够轻松地测试我们的网站的开发版本，而不需要部署它。*  *### 暂存和维护

**暂存环境** 是一个单独的服务器(或几个服务器)，包含生产环境的副本，也称为镜像。在较小的公司或项目中，通常会跳过登台环境。它旨在尽可能地模拟生产环境，具有匹配的已安装软件版本、相同的配置值等。准备阶段用于执行最终测试；例如，脸书可能会重新设计它的首页，在将它部署到生产中供所有用户查看之前，它会部署到它的临时服务器，以便员工(专门的非程序员也称为质量保证团队)可以像定期使用一样首先测试一切。如果一切顺利，就可以进行从试运行到生产的最终部署。

分期不在本书的讨论范围之内，但是了解一下还是有好处的。在虚拟机和小型一次性项目的时代，阶段化可能是不必要的，只有在更大的长期 web 应用程序中才会发挥作用。

还有*维护模式*，这是我们在此上下文中必须涉及的一个术语。这是一个 *模式* 而不是一个 *环境* 因为应用程序周围的环境不会改变――只有应用程序的状态会改变。它通常只是生产服务器上的一个开关，告诉那些试图访问网站的人“马上回来，调整好！”*  *## AMP 捆绑包的罪恶

当开始 PHP 开发时，下载并安装诸如 [XAMPP、](https://www.apachefriends.org/index.html)[【WAMP】、](http://www.wampserver.com/en/)[【MAMP】、](http://www.mamp.info/en/)或 [EasyPHP](http://www.easyphp.org/) 之类的软件包是很诱人的。这些名称中的 AMP 代表“Apache、MySQL 和 PHP”XAMPP 在 Perl 语言的末尾又加了一个 P。第一个字母指的是操作系统:Windows，Linux，Mac OS X，或者在 XAMPP 的情况下，跨平台(意味着它可以在任何操作系统上工作)。

这些包包含了在你的电脑上快速简单地运行 PHP 应用程序所需的所有软件。只需一次点击，您就可以安装编写第一个 PHP 脚本所需的所有东西。那么，这其中的邪恶在哪里呢？

*   你的电脑会被不必要的软件污染

*   与手动安装相比，您学到的东西会更少

*   测试是困难的

*   如果你犯了一个错误，很难或者不可能回到以前的状态

让我们逐一解决这些问题。

### 机器污染

每当你在电脑上安装了*AMP stack 之类的软件，你的电脑就会有一大块死机。即使你后来删除了这个软件，令人不舒服的痕迹通常还是会留下来――通常是以 Windows 中的注册表项或 Linux 中的文件灰尘的形式。事实上，这在 Linux 上尤其明显。Windows 和 OS X 应用程序安装在一个应用程序文件夹中，所有相关文件都在其中，而在 Linux 上安装软件就像拿着猎枪去一个用乐高积木搭建的城堡。一键点击，他们就到处都是*。*

 *随着时间的推移，你会安装另一个库，另一个包，另一个工具。随着应用程序的进一步开发，你会不断添加补充软件，也许会添加完全不同的项目，因为你已经开始并行处理一个新项目。也许 *app1* 需要一个 PHP 扩展来编辑图像， *app2* 需要一个 PHP 扩展来允许它将代码打包到封闭的源代码档案中，这样你的代码就对你的竞争对手隐藏起来了。到时候，你的机器上会有几百兆字节的开发软件，却不知道你是否还需要它。

您的机器将会变慢，应用程序将变得不那么可用，并且您的开发机器——您正在使用的计算机——将变得与您最终打算在其上部署应用程序的生产服务器如此不同，以至于您将无法很好地处理这种差异。你最终会定期在一个实时网站上与 bug 战斗，并且没完没了地骚扰你的访问者。*  *### 学习就是进步，或者说你的舒适区的舒适度被高估了

通过依赖这些预建的包，你也剥夺了自己学习系统管理工作的经验(简而言之就是 **ops** )。在较大的公司中，Ops 是负责服务器问题的团队或个人——无论是修复错误、安装新软件、升级现有软件，等等。在较小的团队中或单独为客户工作时，基本的系统管理是一项必须掌握的技能。

虽然只需一次点击就能把你需要的所有东西安装到你的电脑上是很好的，但是服务器上没有用户界面，因此没有什么可以点击的；您需要掌握设置服务器软件所需的命令，以便它可以运行您的 PHP 应用程序。否则，你要么注定要雇佣一个服务器管理员来帮助你，或者更糟，使用共享主机(这是一个恐怖的故事，在第 6 章中解释)。

通过拒绝依赖这些*AMP 包，你将被迫爬上手动安装服务器和其他软件的学习曲线——如果你认真对待这条职业道路，这些知识将在多个方面有用。此外，正如您将在本书后面看到的那样，确定基础并不困难。

### 测试

比方说 *app1* 和 *app2* 构建于 PHP 5.3 之上，运行 MySQL 4.0，打算在 Apache(服务器软件)支持的服务器上上线。然后，有一个新的要求:确保 *app1* 可以在 PHP 5.6 和 MySQL 5.1 上工作，并且可以由 Nginx(另一个与 Apache 竞争的服务器程序，发音为“engine x”)支持。啊哦，又怎么了？

我们可以将 PHP 更新到一个新的版本，并检查 *app1* 是否仍然工作，但是如果我们的整个计算机现在运行的是 5.6，我们如何继续开发 *app2* 而不意外地使用 PHP 5.3 中不可用的代码呢？同样，我们可以将 MySQL 升级到 5.1，并检查它是否仍然工作，但我们如何知道 MySQL 没有在版本 5+中丢弃一些会破坏 app2 的旧功能，即使我们修复了 app1 以在 5.1 上工作？毕竟，app2 仍然需要在 4.0 上工作，因为它可能仍然部署在这样的生产服务器上。见鬼，我们如何处理 Apache 对 Nginx 的问题？我们是否在我们的计算机上安装了两个 web 服务器并分别进行测试？我们怎么把它们切换出来？我们如何确保我们记得在一台运行的同时在另一台上测试我们的站点？

而这还只是针对两个应用。现在想象一下，如果您必须处理来自十个不同客户的十几个应用程序，每个应用程序都有不同的需求。这一切很快就不再有趣了。

这种不同软件版本的分离很容易通过虚拟机来解决，我们将在第 4 章中讨论。

### 不可收拾的烂摊子

最后，如果我们试图安装一个新版本的 PHP，但是出了问题怎么办？这种情况在 OS X 和 Linux 中尤其常见――现在我们在机器上安装的 PHP 版本都无法工作，而且事实证明不可能运行一个单独的站点。真是一团糟！我们不能轻易地恢复到之前的运行状态，而是被迫花一整天调试我们自己的系统，并试图让它运行――不一定是正确的版本，而只是 *运行* 。

如果我们只需输入一个命令，就能让一切恢复到 10 分钟前的样子，这不是很好吗？嗯，我们可以！这也将在第四章中演示。*  *## 生产/开发平价

这个听起来复杂的短语实际上非常简单――我们以前实际上间接提到过它。 **生产/开发对等** 无非是让生产和开发环境尽可能地相似，最好是完全相同，这样你开发的任何东西都将自动在生产中运行，而无需任何过多的配置或额外的调试或调整。

实现对等对于一个人的工作流程非常重要，因为它可以节省大量的时间。避免为您的应用程序在生产环境中运行而做任何额外的工作，意味着您有更多的自由和时间来关注与业务相关的重要逻辑问题，这些问题实际上有益于您的应用程序环境，而不是陷入不断追赶的窠臼。在开发中做一个改变，然后在生产中做两个改变以使改变变得明显，这在最好的情况下是乏味的，在最坏的情况下是有害于项目的健康。你永远不知道团队中的谁会犯错误，导致应用程序以错误屏幕向人们问候。

实现奇偶校验的最佳方式是在开发环境中运行与生产环境中完全相同的软件。例如，如果您的目标是将您的应用程序部署到运行 Ubuntu Linux 版本 14.04 操作系统的服务器上，那么最好也在这个操作系统上进行开发。然而，如果我们运行的是 Windows，因为我们喜欢消费游戏等高级多媒体内容，或者我们需要强大的图像和视频处理软件，而这些软件在 Linux 操作系统上是不存在的，那该怎么办呢？我们是否应该放弃所有其他的兴趣，把 Linux 安装在 Windows 之上，并努力与其他任何东西平起平坐？或者我们应该放弃奇偶性而冒险，同时保持我们的计算机强大、美观和稳定，坚持我们选择的操作系统？

幸运的是，有第三种方法可以让你两全其美:虚拟机(在第四章讨论)。

## 性能和调试

我们需要接触的应用程序环境的最后一个方面是确保应用程序是快速的(性能)和无错误的(调试)。这一节完全是理论性的；这只是为了让你知道，当我们以后遇到这些术语时，会发生什么。

性能是通过各种方法实现的**。与这个词的意思相反，在应用程序开发中，优化通常有几个层次，并且很少是立即带来完美解决方案的变化。绩效包括但不限于以下几个方面:**

 **Optimizing the database

数据库通常是任何网站中最慢的部分，在运行一段时间后，它可以受益于额外的优化，瓶颈(最慢的部分，因为它们不能足够快地处理大量的传入请求)变得明显。数据库优化的方法包括建立索引、拆分读写、更改数据库引擎、缓存获取的数据以及其他听起来神秘的短语。

Optimizing the front-end assets

我们之前提到过编译和构建――这是我们优化网站前端的方式。当一个网站展示给用户时，他们看到的输出包括图像、HTML、CSS 和 JavaScript，所有这些都需要下载并在浏览器中执行，如第 1 章所述。这些文件越小，数量越少，网站的加载速度就越快。通常，一个网站会有多个 CSS 文件和多个 JavaScript 文件。将每种类型合并到一个更大的 CSS 或 JavaScript 文件中，可以显著提高网站的下载速度。另一个经常使用的前端资产优化技巧是通过 **内容交付网络** 或 CDN 提供图像，这是一种第三方服务，为您托管图像，并确保您网站的访问者从离他们最近的服务器下载图像，从而进一步提高速度。你也可以缩小图像尺寸，通过将所有图像放入一个文件来创建一个 **图像精灵** ，等等。

Optimizing the back end

这也是一个编译/构建步骤。测试文件被忽略，文件被合并到更大的文件中使用，而不是一百万个更小的文件。一些 PHP 应用程序甚至被编译成另一种编程语言，比如 C++，这要快得多。

Caching

**缓存** 是保存以前需要的文件和响应以备后用，并期待它们被再次请求。如果您向数据库询问您的数据库中的用户总数，它会对这些用户进行计数并给出数字。如果您让它保存这个数字以备后用(也就是说，缓存它)，下一次它被请求时，它可以只获取已经准备好的信息。当你问服务器“如果我去 mysite.com/user/5?",，我会得到什么?”它会告诉你。如果你告诉它下次问问题时记住答案，服务器就没有必要看起来像已经知道了一样。缓存在 web 开发中非常重要――有一句俗话说“缓存为王”当流量突然激增时，对于您的应用程序来说，这可能意味着生与死的差别。

调试与性能紧密相关。除了给用户一个讨厌的错误屏幕之外，代码中的一个 bug 还会导致执行锁、代码中不应该出现的停顿、对数据库的重复和不必要的查询等等。

那么，如何衡量性能或发现缺陷呢？有很多工具可以用来对**PHP 应用程序进行评测(这就是所谓的查找 bug 和测量应用程序各方面的性能)。其中两个比较好的是 [Z-Ray](http://www.zend.com/en/products/server/z-ray) 和 [Blackfire](https://blackfire.io/getting-started) (我们不会在本书中涉及它们，因为它们不在讨论范围之内)。**

 **### 警告:小心微优化

需要注意的是，一个常见的新手错误是微优化。例如，曾经有人认为在字符串中使用单引号(`$var = 'Some String'`)比双引号(`$var = "Some String"`)更快。这种优化带来的性能提升是微不足道的，几乎总是微不足道的；相反，改进一个复杂的 SQL 查询或缓存一个远程 HTTP 调用总是要大一个数量级。当有疑问时，使用基准和真实数据(如来自 Z-Ray 或 Blackfire 的数据)，而不要凭直觉。****  ****## 总结

在这一章中，我们探索了应用程序环境，涵盖了在应用程序生命周期的给定阶段中围绕着应用程序的各种生态系统。我们讨论了虚拟主机和配置您的计算机以将网站 URL 重定向到您自己的 PHP 安装，而不是在线查找结果，我们还讨论了非常重要的开发/生产对等性。

如果这一切看起来过于复杂，不要绝望。这只是因为到目前为止我们几乎只讨论了理论――勇敢地进入实践领域所必需的理论。在接下来的章节中，我们将尝试一些虚拟机。

### 对于那些想要更多的人

在应用领域，测试单个组件被称为 **单元测试**——测试每一组单独的代码，这样你就知道它在工作。

例如，您的应用程序的一部分可能有能力从每个名称中删除本地符号，并将它们转换为用户友好的字母。因此，我的姓“斯克沃尔克”将变成“什科沃茨”把 kvorc 变成什科沃茨是一个小代码集，或者说是一个 **单元** 。本单元为**可测试**为；也就是说，对于任何给定的“kvorc”输入，我都期望输出“什科沃茨”然后我可以编写一个 **单元测试** ，这是一个定义输入和期望输出的文件，当我运行它时，它会测试这个功能是否仍然有效。如果两个月后，我更改了应用程序中的一些内容，我可以很容易地运行这个测试(它仍然存在)并检查这个转换是否仍然有效。这种工作流确保您可以在以后升级您的应用程序，而不用担心破坏您以前构建并忘记的东西。在本章开始的智能手机类比中，单个可测试单元可以是触摸屏或电池。**** 

## ****分享这篇文章******