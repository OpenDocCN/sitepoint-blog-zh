# 现实世界中的 MySQL 3 到 4 迁移

> 原文：<https://www.sitepoint.com/mysql-migration-real-world/>

关于从 MySQL 3 迁移到 MySQL 4 的特性和优势，有各种各样的白皮书和架构文档。有时候，最好的情况是看到它在真正的网络业务的前线完成。

我最近有机会与在线梦幻棒球网站[SimDynasty.com](http://www.simdynasty.com)的开发者和所有者泰森·洛维里聊天，了解他在 MySQL 迁移、网站营销方面的经验，以及他对 Java 和 PHP 的看法。

你能给我们介绍一下你自己的背景吗？

我在俄亥俄州阿克伦市长大，后来在波士顿学院主修计算机科学和商业。之后，我开始在通用电气资本(通用电气的一个部门)工作，在那里我参与了各种各样的项目。大部分技术是微软的变种，一些 Java 和 Oracle 项目散布在各处。

离开通用电气后，我创办了自己的技术咨询公司 Teeloh Technology。我的专长是数据库驱动的 Web 应用程序，尤其是在金融服务和房地产行业。但最近，我也在为游戏公司做一些项目工作。

***是什么驱使你设计并推出了梦幻棒球网站？***

我真的被一些正在开发的开源技术吸引住了，尤其是 Java 和 MySQL。我在通用电气工作的时候，利用晚上的时间创建了我的棒球模拟网站 SimDynasty.com，主要是为了尝试 Java 和 MySQL。我一点也不知道它会成为一个大热门。

***能否在网站的技术平台上拓展？***

当然，但首先，让我告诉你一点关于这个网站的信息，这样你就可以跟着例子，了解我们如何更好地使用 MySQL。《模拟王朝》是一个棒球模拟游戏，挑战人们在棒球的团队所有权和经理方面的能力。每个球队所有者起草一个虚构的棒球运动员队，并担任球队的所有者和经理。他们可以交易球员，设定阵容，培养小联盟的潜力，等等。

游戏每天模拟 3 次，你可以现场观看，类似于 ESPN 游戏。这项运动最酷的部分是，你要在几个赛季中管理球队，并且必须决定在业余选秀中选择哪个球员，或者征召哪个新秀来代替在淡季退役的老将，或者是否要牺牲你球队的未来，用几个前景来换取顶级投手。

您可以想象，当游戏被模拟时，它会导致大量记录被更新并插入到数据库中，以说明玩家统计数据、团队记录和比赛实况。但用户仍然在网站上不停地阅读，查看统计数据，查看比赛结果，并查看弃权声明书。用户也通过设置阵容，提供交易，甚至改变球员的名字来完成他们的数据库写入。因此，您可以看到，在 MySQL 的资源方面，我们有许多不同的竞争对手，包括读取和写入方面。

该网站在 Linux 服务器上使用 Java、JSP 和 MySQL 4.0 运行——我们确实在论坛和其他一些小领域使用了一点 PHP。我们目前使用的是 MySQL 4.0.18。我迫不及待地希望 4.1 可以投入生产——子选择终于来了！

***当你启动网站的时候，听起来你是在 MySQL 3.2x 上？您是如何计划迁移到 4.x 的？***

可能像很多人一样，我们出于需要做出了改变。我们迫切需要 4.0 中的一些特性来提高网站的性能。我们从 3.23 开始，仅仅是因为它是预装在服务器上的版本，并且在一段时间内运行良好。

***是什么因素让你做出了迁移的决定？***

我们升级的主要原因是为了能够利用 InnoDB。我注意到页面真的很慢，并在监控 SHOW STATUS 中锁定查询的数量时意识到了这个问题。

我们有一个有趣的情况，大多数网站没有经历过。许多 MySQL 网站有大量的选择查询，但是没有多少插入、删除或更新。或者，如果他们有那些，他们在非高峰时间做。

我们网站的本质就是每一张表都在一小时内被更新几百到几千次。随着我们站点的增长，这使得升级到 4.0 变得至关重要，这样我们就可以利用 InnoDB 表。对频繁更新的表使用 InnoDB 已经改变了我们的游戏规则，因为它在执行更新时使用行级锁而不是表锁。这允许我们的 Java 程序和 JSP 页面在访问者查看表中的数据时更新表，甚至更新数据。

***能否分享一些在过程中发现的 MySQL 小技巧和窍门？***

我学到的一些技巧不是凭直觉的。如果在两个表之间使用联接，并且列的大小相同，那么性能会大大提高。例如，如果您有一个名为 customer 的表，它的主键为`customer_id`，并与一个名为`order_customer_id`的字段上的 order 表相连接，请确保您没有将类似于`int(10)`的内容用于一个字段，而将`int(5)`用于另一个字段。例如，将它们都改为`int(10)`，将有助于提高这些连接的速度。

我们在 4.0 中利用的另一个特性是查询缓存。即使表每小时更新很多次，我们仍然可以看到使用缓存查询的良好数字。

我建议您打开 MySQL 的慢速查询日志。这是识别哪些查询运行缓慢的良好起点。当我发现一个缓慢的查询时，我使用 MySQL 的 Analyze 查询，它向您显示从每个表中读取了多少行，以及它们是如何连接的。您通常可以找到一种更好的方法来获得相同的结果集，而无需扫描这么多行，方法是在表上添加索引，或者以不同的方式联接查询。

一路走来有没有什么打嗝或者吸取的教训？

决定将哪些表从 MyISAM 转移到 InnoDB 是一个持续的过程。如果可以避免表范围的锁定，MyISAM 在读取时的性能会更好。我们的主数据库有 34 个表，现在其中 7 个是 InnoDB 表。

还有一些其他的表可能是将来要改变的候选表。我们监视查询，看锁定是否成为其中任何一个的问题。我们发现了一个很好的工具，叫做 mytop。它从 MySQL 的 SHOW STATUS 和一些其他命令中获取一些内容，并以类似于 Linux top 命令的格式呈现出来。您可以看到正在您面前执行的查询—您可以看到它们需要多长时间，以及是否有任何查询被锁定。

我们注意到的另一个问题是，在某些情况下，大约每个月的某几天，一个表可能会经历一段时间的更新。例如，我们所有联盟的季后赛几乎在同一时间举行。因此，某些表会被频繁地读写，但这种情况只会持续 3 天左右，而且每隔一个月才会发生一次。在此期间，我们实际上将表切换到 InnoDB 以利用行级锁定，并在其余时间将其恢复为 MyISAM 当它通常不被写入时。

整个过程的关键是反复试验。稍微更改一个设置或更改索引，测试并测量差异，然后决定是保留更改还是丢弃更改。这可能是一个乏味的过程，但结果是惊人的。一些人试图告诉我投资一个更大的服务器，但我不确定这能在多大程度上缓解我们的问题。

***成绩怎么样？自迁移以来，您是否跟踪过任何性能指标？***

抱歉，我希望我有一些数字。从客户的角度来看，我只能说这个网站很棒。过去我们白天运行模拟游戏时速度非常慢，以至于我们不得不整夜运行免费游戏，这样网站的其他部分才不会太慢。这已经不是问题了。

我们玩这个游戏的玩家数量已经突破了屋顶，我认为这很大程度上与更好的服务器性能有关。有时，在过去，某些页面可能需要 10 秒钟才能加载完毕——对于一个日复一日处理这些页面的人来说，这可能会令人厌倦，我认为我们因此失去了很多人。

***你用 Java 和 PHP，对吗？与 PHP 相比，你有什么建议或技巧可以让你在 MySQL 上使用 Java 吗？***

JSP 和 PHP 各有优缺点。如果您需要程序在服务器上运行，我的理念是您应该使用 J2EE 解决方案，这样您就可以在可执行程序和 Servlets 或 JSP 之间共享代码。但是 PHP 通常比 Tomcat 给服务器带来的压力更小，而且 PHP 在服务器设置和配置方面的活动部分似乎更少——这意味着出错的情况更少。

在与 MySQL 的接口方面，我没有注意到在性能方面有太多的不同。对于初学者来说，PHP 在解决如何连接数据库的问题上稍微简单一些。但是从性能上来说，我并没有看到太大的区别。使用 PHP 和 JSP 执行相同的查询并测量结果将是一个有趣的实验——也许我可以在雨天做些事情。

你是如何营销这个网站的？它带来了更多的订户吗？

该网站主要通过付费搜索引擎列表进行营销，如 Google Adwords 和 Overture。我们也在其他与棒球相关的网站上做广告。我们的网站通常每天有 75，000 到 100，000 次页面浏览，有近 25，000 名注册用户。

我们也有一个推荐给朋友的项目，所以网站的消息会通过口口相传传播开来。

***在网站的建设和维护过程中，你有没有发现其他像 mytop 这样有价值的工具？***

我们开始在服务器上使用一些监控脚本，让我们知道站点何时出现问题。但是我们发现的一个问题是，如果出现重大问题，脚本也会停止运行。我们现在使用一家名为 Alerta 的公司来监控我们的网站。一个月几块钱，如果网站出了问题，他们就会呼叫我们。

Webmasterworld.com 是一个包罗万象的网站，从寻找托管公司，到如何营销你的网站，到 HTML 语法问题，都有很好的提示。如果你以前没看过，这真的是一个很有价值的网站。

对于营销来说，使用横幅广告交换可能看起来像回到了 1996 年，但它确实帮助我们带来了新的客户，并摆脱了我们额外的横幅广告库存。在对其中的一些进行试验后，我们专门使用了 BCentral.com 的 exchange，它现在归微软所有。

SitePoint 感谢泰森抽出时间。看看 SimDynasty.com 的。

## 分享这篇文章