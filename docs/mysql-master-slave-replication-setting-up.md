# MySQL 主从复制:设置

> 原文：<https://www.sitepoint.com/mysql-master-slave-replication-setting-up/>

最近，在[Fraudpointer.com](http://www.fraudpointer.com/)，经过短短六个月的运营，我们的数据库容量达到了 25Gb，我们决定开始使用复制技术作为我们的后端持久存储。

## 你为什么想这么做

MySQL 的复制可以解决您可能想要解决的各种问题:

*   横向扩展解决方案
*   数据安全
*   分析学
*   远距离数据分发
*   备份来自从设备，而不是主设备

关于复制的 MySQL 文档，可以在[这里](http://dev.mysql.com/doc/refman/5.1/en/replication.html)找到，很有解释力，给出了关于这些用途的更多细节。

## 我们去过哪里？

在实施复制之前，我们有如下配置:

![what we had](img/a0dc3b990903d93baf1f55991788b6d2.png "figure1")

我们有一台装有 MySQL 5.1 的 debian squeeze machine(名字:Plato)。安装并处理所有 Fraudpointer 流量。当我们决定实施复制时，它已经是 25Gb 了。每分钟都有大量的交易发生，我们面临着两个主要问题。

1)我们希望进行每日备份，备份会给机器带来大量负载。尽管我们使用的备份实用程序( [Percona xtrabackup](http://www.percona.com/doc/percona-xtrabackup/index.html) )没有锁定数据库，但在备份期间，机器变得相当没有响应。

2)我们希望非常频繁地运行大量查询并获得报告。这正是开始讨论复制的好理由。

## 复制之后我们在哪里？

MySQL 复制后，我们现在在下图中:

![what we want](img/c420f11036ec1a1f3c469ecd6a6f0372.png "figure2")

我们现在有两台安装了 MySQL 的机器。旧的柏拉图现在充当主人，而新的阿瑞斯现在充当复制方案的奴隶。在我们的设置中，这种配置的优点如下:

1)我们可以从从属服务器获取每日备份。对于此任务，生产主机上没有负载。

2)我们可以从从节点获得我们的报告。

3)如果从节点宕机，这根本不是问题。复制是异步执行的，当从节点在停机后启动并运行时，它会从暂停点继续复制。

4)在主机上创建或更新的记录几乎立即“传输”到从机(即使是异步的)。

## 我们是怎么做到的？

下面是我们执行复制时遵循的流程:

### 假设

1.  主从都是 debian 压榨机。
2.  主有静态 IP: 10.100.10.80。
3.  从机具有静态 IP: 10.100.10.103。
4.  主机和从机在同一个局域网上。
5.  Master 安装了 MySQL，并且您拥有从“localhost”连接到它的 root 密码。MySQL 默认不允许远程连接，我们的情况也是如此。
6.  Slave 还没有安装 MySQL。
7.  主 debian 允许在 3306 端口(标准 MySQL 监听端口)上的传入连接。

### 第一相

#### 概观

在工作的第一阶段，我们所做的工作概述如下:

1)在主机上

1.  允许远程连接
2.  设置绑定地址
3.  启用二进制日志
4.  建立唯一的服务器 ID
5.  重启服务器
6.  为复制创建用户

2)从机上

1.  安装 MySQL
2.  停止 MySQL
3.  设置绑定地址
4.  启用二进制日志
5.  设置唯一的服务器 ID

### 详细操作

#### 在主人身上

1)允许远程连接

由于您将要更改 MySQL 服务器上的绑定地址，您实际上是允许从“远程”机器访问您的 MySQL 服务器。如果不这样做，在更改绑定地址并重新启动 MySQL 服务器后，来自远程或本地机器的用户将无法连接到您的服务器。所有远程和本地机器 IP 都需要被授权给从这些机器访问 MySQL 的用户。

以下 mysql 命令(可以使用 mysql shell 发出)

```
mysql> grant all on *.* to bar@’10.100.10.55’ identified by ‘bar_password’;

mysql> flush privileges;
```

允许用户“bar”从 IP 为“10.100.10.55”的机器连接到该 MySQL 服务器和所有数据库。即使用户从安装了 MySQL 服务器的机器上连接，这也是必要的。

因此，使用 mysql 连接到您的 MySQL 服务器，并在继续下面的操作之前相应地设置这些命令。不要忘记，对于“根”用户来说也是如此，即使他从本地机器连接。

2)将绑定地址设置为机器的 IP 地址。

这是在`my.cnf`文件中完成的。`bind-address`是`[mysqld]`部分的配置参数。将其设置为您的主机 IP。在我们的例子中，它是 10.100.10.80。请注意，如果您启用了`skip-networking`，您需要禁用它。

3)设置二进制日志文件模式

该参数称为`log_bin`，它应该存在于`[mysqld]`部分。请注意，应该给出二进制日志文件的完整路径。例如:`/var/log/mysql/mysql-bin.log`。

**重要问题**:确保文件夹/磁盘有足够的空间来写二进制日志。

4)设置服务器 id

这是主复制服务器 ID。在整个复制设置中使用的所有 id 中，它必须是唯一的。例如，将此项设置为“100”，并确保在从属服务器上设置“101”(请参见下文)。

参数为`server-id`，应在`[mysqld]`段设置。

5) `innodb_flush_log_at_trx_commit`和`sync_binlog`

这两个都应该设置为“1”。根据 MySQL 文档*,为了在使用 InnoDB with transactions 的复制设置中获得最大可能的持久性和一致性，您必须这样做。更多关于这个你可以在这里找到。*

这些参数在`[mysqld]`部分设置。

6)重启 MySQL 服务器

对 MySQL 服务器的配置文件做了所有必要的更改，并授予所有现有用户使用其 IP 进行连接的权限后，您就可以重新启动 MySQL 服务器了。

7)为复制创建用户

您需要创建一个有权作为复制/从属客户端的用户。以下命令:

```
mysql> create user ‘repl’@’10.100.10.103’ identified by ‘slavepassword’;

mysql> grant all on *.* to ‘repl’@’10.100.10.103’;

mysql> flush privileges;
```

正在创建用户“repl ”,并授予他使用指定密码从 IP 为 10.100.10.103 的从属计算机进行复制的权限。

#### 论奴隶

1)安装 MySQL 服务器

在从机上，你需要安装 MySQL 服务器。

2)停止 MySQL 服务器

你暂时不需要让它运行。继续更改 MySQL 配置参数以支持从属复制。

3) `bind-address`

将`bind-address`设置为从机的 IP 值。在我们的例子中是 10.100.100.103。该参数应在`[mysqld]`部分设置。

4) `log_bin`

设置二进制日志文件的完整路径。比如:`/var/mysql/log/mysql-bin.log`。该参数设置在`my.cnf`文件的`[mysqld]`部分。

**重要提示**:::确保你的二进制日志文件夹有足够的空间。你会需要它的。

5) `server-id`

您需要为此复制设置提供从属节点的服务器 ID。举个例子“101”。它必须不同于配置中主节点和其他从节点的服务器 id。

不要启动从 MySQL 服务器。你仍然不需要这样做。

你现在完成了。第一阶段已经结束。

在第 2 阶段，我们将开始复制。

## 分享这篇文章