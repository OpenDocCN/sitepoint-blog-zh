# 让网站变慢的七个错误

> 原文：<https://www.sitepoint.com/seven-mistakes-that-make-websites-slow/>

随着假期即将来临，公司正在增加 SEM 支出，密切关注 SEO 和修改登录页面。然而，如果假日期间网站流量的增加导致网站运行速度变慢甚至关闭，那么所有这些时间、精力和金钱都将付诸东流。

众所周知，性能对用户至关重要。网站速度直接影响跳出率、转换率、收入、用户满意度、搜索引擎优化(明确体现在谷歌的页面排名中，间接影响网站的受欢迎程度)以及几乎所有其他值得追踪的商业指标。用户离开慢站点，很多不会再回来。

不久前，8 秒被认为是一个临界点，超过这个临界点，用户就会放弃一个网站。然后是六秒。然后是四个。经验法则是两秒钟。门槛很高，而且一直在涨。

### 小的性能变化会产生大的影响

用户的耐心不是线性的。几乎没有人会因为一秒钟内太慢而放弃一个网站。但是超过第一秒，缺少一些反馈(比如浏览器标题栏显示页面标题)，用户开始加速反弹。三到四秒，一个典型的网站可能会失去一半的潜在访问者。当然，具体的阈值因网站、用户行为和意图以及其他因素而异……但原则是相同的。

### 瓶颈

快速测试:用户在等待页面加载的时间中，有百分之多少是在 HTML 返回浏览器之后的时间？如果您不在 web 开发或性能优化社区，这个答案可能会让您大吃一惊。通常超过 90%。*用户在网站上等待的大部分时间是在浏览器检索到 HTML 页面之后。为什么会这样呢？*

### 获取 HTML 只是开始

对浏览器如何工作的认真分析已经超出了这里的范围，但是简单地说，浏览器解析页面的 HTML，依次发现它的资产(比如脚本、样式表和图像)，请求，然后解析和执行它们，或者适当地显示它们。

但是这些资产并不是一下子就能得到的。相反，浏览器会打开与页面引用的服务器的有限数量的连接。建立 TCP 和 HTTP 连接会产生开销，在网络上来回推送请求和响应字节时会产生一些不可避免的延迟。

所以，一般来说，浏览器和服务器之间的往返是很昂贵的。HTML 标记的结构、其资源的数量和顺序是影响其性能的绝对关键因素。

在我们进入假日网站流量的核心之前，花点时间考虑一下网站开发者和网站所有者在网站性能方面犯的七个最大的错误，以及如何避免或纠正它们的建议。

### 1.太多 HTTP 请求

这是大多数网页出现性能问题的最大原因。许多最有效的 WPO 技术都与解决这个问题有关，尽管方式非常不同。以下是一些解决方案:

#### 连接脚本和样式表

简单地将多个脚本文件连接(组合)成一个。样式表也是如此；简单地包括后续的内容。css 文件合并成一个组合样式表。手动操作会产生维护成本，但自动化解决方案比比皆是。

#### 将图像与精灵结合

CSS 精灵已经成为一种主流技术。这个想法是把许多常见的图像(例如你的网站的模板、主题或导航的所有图形)放到一个大的图像文件中。然后使用 CSS 精确定位并有选择地在每个需要图像的地方显示 sprite 图像的适当部分。所以你只有一张照片，而不是几十张。

预先警告，这种技术的维护开销可能很大，因为即使是很小的编辑通常也需要更新图像和 CSS，甚至 HTML。幸运的是，自动化 CSS spriting 的工具已经涌现出来，以帮助解决这一维护负担，如 [SpriteMe](http://spriteme.org/) 、 [Compass](http://compass-style.org/help/tutorials/spriting/) 和 [Yottaa](http://www.yottaa.com/web-performance-optimization) 。

#### 使用较少的图像

一页中有太多图片是一个普遍存在的问题，这个问题几乎和标签一样古老。解决方案分为两类。一个是技术性的:用 CSS 替换图像文件(例如背景颜色、边框、按钮、悬停效果和样式文本)，或者甚至使用“[数据 URIs](http://jonraasch.com/blog/css-data-uris-in-all-browsers) ”将它们嵌入较小的图像。

在图像对页面的目的至关重要的情况下，例如电子商务目录，也可以考虑分页。

另一个解决方案可能更难:与网站的设计师和产品负责人合作，创建不依赖太多图片的简单页面。

### 2.最少的客户端处理

许多网站未能利用客户端的能力，而是将所有工作推给服务器。一个简单的例子是表单验证。将表单数据发送到服务器，在那里进行验证，然后发回一条错误消息(更不用说整个页面了)，效率低得令人难以置信。

#### 在客户端验证

相反，应该从页面内部验证用户的输入，就在输入发生的地方。出于安全原因，web 应用程序应该总是*也*在服务器端验证；网络安全的第一条规则是用户输入不可信。因此，出于性能和 UX 原因，在客户端进行验证，出于安全原因，在服务器端进行验证。

#### 使用 web 标准和 MVC 分离

使用 web 标准对于创建可维护、可访问、经得起未来考验的网站至关重要。一个很大的副作用是它也是最大化性能的最好基础。现代 web 标准的使用鼓励内容(HTML)、样式(CSS)和行为(JavaScript)的分离。

换句话说，古老的“MVC”[模型/视图/控制器]设计模式在你网站代码的客户端层发挥作用。

将 HTML(实际上是 DOM)视为模型，将 CSS 视为视图，将 JavaScript 视为控制器。这种分离有助于提高代码的效率和可维护性，并使许多优化技术更加实用。

#### 将表示代码推送到客户端层

除了前面提到的表单验证示例，许多其他场景都需要在客户端做更多的工作。图表和图形——任何好看的数据可视化——曾经是服务器的专有领域。

不会了。现在，更有意义的做法是将原始数据从服务器推送到客户端(例如 JSON 格式)，并使用 JavaScript 和 CSS 在浏览器中创建漂亮的图形、图表和可视化效果。通过这种方式，许多用户交互可以完全避免访问服务器。

而且，通过仅推送数据，您可以节省服务器 CPU，缩短等待时间，并利用每个客户端未充分利用的资源。有很多很棒的 dataviz 工具，包括[处理](http://processingjs.org/)、 [D3](http://mbostock.github.com/d3/) 和 [Flot](http://code.google.com/p/flot/) 。

#### 利用 Ajax 技术

通过只需要改变页面的一小部分来响应用户的动作，您可以使您的站点或 web 应用程序响应更快、效率更高。有不同的有效方法(例如获取 HTML、脚本和数据)。但是不需要的话不要刷新整个页面！如果你参加 Ajax 聚会迟到了，这本书已经有几年了，但仍然是一个很好的概述。

### 3.并行请求数量少

获取一个脚本，解析并执行它，然后获取另一个脚本。冲洗并重复。然后从同一个服务器上下载一些图像，用尽所有可用的连接。下载完成后，再获取一些。听起来有效率？不是的。用户连接的带宽大部分时间不是制约因素；相反，这是低效的标记，没有考虑到浏览器的行为。

你可以对你的 HTML 做一些事情来允许几乎任何浏览器同时发出许多请求，这对延迟有很大的影响。

#### 使用适合浏览器的域分片

一些旧的但仍受欢迎的浏览器，如 IE 7，从“域分片”中受益匪浅，这是一种为同一网络服务器使用不同主机名别名的做法，目的是规避微小的每服务器同时连接限制。使用`img1.foo.com`和`img2.foo.com`指向同一个地方会有额外的 DNS 查找成本，但是可以让您有效地将并行下载的数量增加一倍。请注意，不要将这种技术应用到支持大量并行连接的新浏览器上，这一点很重要，因为这样会带来 DNS 成本，却没有任何好处。WPO 大师史蒂夫·索德斯很好地解释了权衡[在这里](http://www.stevesouders.com/blog/2009/05/12/sharding-dominant-domains/)。

#### 使用智能脚本加载

脚本加载器出现了爆炸式增长，这有助于最小化多个脚本对性能的影响。在有些情况下，连接某些文件不方便或不实际，智能加载脚本可以大大降低非连接脚本文件的成本。

这些加载器通常异步加载脚本(以绕过它们的阻塞行为问题)，并且还可以保持执行顺序，而不需要顺序下载。通常来说，提供级联的异步 JavaScript 仍然是最好的(也是最简单的)方法，但是如果您没有或者不能级联 JavaScript(并将其转换为异步的)，那么利用一个好的脚本加载器会是一个真正的区别。这里是脚本加载器的[列表。](https://docs.google.com/spreadsheet/ccc?key=0Aqln2akPWiMIdERkY3J2OXdOUVJDTkNSQ2ZsV3hoWVE)

#### 杠杆保活

这很简单:确保您的 web 服务器不会覆盖 HTTP 1.1 的默认行为，即在多个 HTTP 请求/响应周期中重用同一个 TCP 连接。也有例外(例如对于专门的图像服务器)，但是对于你的普通网站来说，这是显而易见的:使用它，你的页面会更快。

### 4.未能利用浏览器缓存/本地存储

有人说，“计算机科学有两个难题:缓存、命名、一错再错”(哈)。说真的，加载资产的最快方式是从本地缓存。未能利用浏览器已有的资源是一个常见但可以解决的问题。

#### 使用正确的标题

为静态资产设置未来缓存头——尤其是在多个页面中引用的静态资产——是提高性能的一个好方法。因为客户端缓存的显式失效是不可能的，所以处理缓存内容更新的方法是文件名更新(重命名资产并更新对它的引用)。

如果手动操作，这是另一种维护成本很高的技术，但是自动化(例如通过构建脚本)使它变得轻而易举。该方法使用“`Expires`”标题。对于频繁更新的内容，使用“`Last-Modified`”响应头，以便从浏览器触发条件“`If-Modified-Since`”请求。条件请求显然比本地缓存查找慢，但仍然比全往返好得多。

这里有一个很棒的 [HTTP 缓存概述](http://www.mnot.net/cache_docs/)。

#### 利用本地存储

WPO 军火库中的一个新武器是 HTML5 的本地存储。对于支持它的浏览器来说，它允许比 cookies 多得多的东西被显式地存储在客户机上，而且与 cookies 不同，它不会加重每个请求的重量。

### 5.第三方小部件

第三方小部件是每个注重性能的网站运营商的克星。

#### 避免第三方插件！

如果可以的话，不要使用它们。一些社交媒体插件和分析集成通常是必要的，但如果可以的话，尽量避免它们。

#### 使用异步实现

尝试使用提供异步实现的窗口小部件，这样它们不可避免的糟糕性能会影响它们的窗口小部件，而不会拖累整个 UX。

#### 衡量性能(并停止使用慢的)！

仔细观察它们，要么坚持一个 SLA，转换小部件提供商，要么找到一种不用小部件的方法。(关于衡量的这一点适用于性能的所有方面。你测量的东西有一个有趣的改进趋势，你不能优化你不测量的东西。)

### 6.太多字节

像“太多的 HTTP 请求”一样，这是一个由许多不同的 WPO 技术解决的高级问题。有很多方法可以使响应(甚至请求)变得更小:

#### 压缩

一个明显但重要的解决方案是引入压缩(a la gzip)。客户端解压缩的轻微性能损失通常与减少的延迟相比相形见绌，因为通过网络传输的字节更少。在服务器端，预压缩静态资源有助于减少 CPU 开销。像 Apache 的`mod_deflate`这样的服务器端解决方案使得压缩动态内容变得很简单，并确保压缩后的内容只发送给能够处理它的客户端(如“`Accept-Encoding: gzip, deflate`”这样的请求头所示)。

需要注意的一个问题是压缩和缓存的结合:确保使用一个“`Vary: Accept-Encoding`”头，这样缓存就可以用适合请求的内容来响应。

其他技术包括:

*   更无情的内容编辑
*   图像优化(http://www.smushit.com/ysmush.it/)
*   JavaScript 和 CSS 的重构和缩小
*   客户端层代码重用
*   页码
*   埃阿斯
*   无 Cookie 域(用于图像和其他静态资产)

### 7.未能使用全球网络

一个很常见的错误就是忽略了地理。如果你的站点托管在纽约的数据中心，波士顿的用户和加利福尼亚的用户(更不用说亚洲了)在延迟上有巨大的差异。从边缘提供内容是传统 CDN 的角色。使用云提供商将你的内容分发到更多的地方，这样用户总是从他们附近的服务器上下载内容就更好了。

像 Yottaa 这样的尖端 Web 性能优化服务可以在多个云提供商之间路由请求，并将您的页面及其内容分发给全球用户，代表了为地理上不同的受众进行优化的下一代解决方案。

表现很重要，尤其是在假期前后。在黑色星期五、网络星期一和更远的地方到来之前，衡量一下你网站的表现，然后改进它。

无论您是手工操作、在构建时操作、在部署时操作、在请求时在您的服务器上操作，还是在云中使用您最喜欢的 web 性能优化服务来操作……只管去做！

#### 进一步阅读和其他资源:

[Firebug](https://getfirebug.com/)
[YSlow](http://developer.yahoo.com/yslow/)
[WPT](http://www.webpagetest.org)
[dynaTrace](http://ajax.dynatrace.com/ajax/en/)
[Yottaa](http://www.yottaa.com)
[高性能网站](http://stevesouders.com/hpws/ )
[更快的网站](http://stevesouders.com/efws/ )
[速度之书](http://www.bookofspeed.com/)
[Web 2.0 Expo](http://www.web2expo.com/)
[速度大会](http://velocityconf.com/)

## 分享这篇文章