# 与 CiJoe 的持续集成

> 原文：<https://www.sitepoint.com/continuous-integration-with-cijoe/>

![](img/36ca6a7d85559e0a6b22adfb0704db44.png "687474703a2f2f696d672e736b697463682e636f6d2f32303039303830352d673461327168747477696a386e326a72397435353265666e336b2e706e67")

你很可能为你的 Ruby 代码编写测试。我们可以采用多种测试形式，从孤立的单元级到完整的堆栈集成。一个常见的工作流程是获取代码库的最新“干净”提交，执行一些操作，然后准备将代码合并回当前的开发分支。引入一个开发团队，工作流程会变得更加复杂。你必须处理合并冲突，有时你甚至必须*和其他开发者*交谈，从应用程序的高层次和低层次的角度来解决变更。

在提交之前，您需要提取代码库中的任何更改，合并它们，并确保应用程序符合测试套件的所有绿色指标。自动化持续集成(CI)为开发团队提供了重要的帮助，确保他们手头有一个经过验证的正确版本的应用程序。

## 唯一的开发商

一个小小的警告是孤独、孤立和幸福快乐的开发者。一个普遍的概念是，CI 对于团队来说是至关重要的，但并不适用于独立/自由职业开发人员。我理解这样一种观点，如果一个开发人员单独负责一个代码库，并且他/她在每次提交之前运行他们的测试套件，那么是的，还有什么会出错呢？

对我来说，测试套件应该运行在一个与生产代码将要登陆的环境相似的环境中。我发现我的本地开发机器总是最不适用。还有，来吧。我们都是人，过去有几次我可能有一个绿色的测试套件，但是忘记提交一个新添加的文件，或者正确地配置一个资源。CI 将我们从部署破损或不完整代码的痛苦中解救出来。如果频繁地或者仅仅是普通的 ole 可靠发布，我们必须成为“构建”的奴隶。

## 外面有什么？

网上有很多 CI 解决方案。老实说，挑一个名字，在末尾打个“-ci.org”，看看你会得到什么。詹金斯和[哈德森](http://hudson-ci.org/)似乎抢走了很多商业上的风头，如果你在开源世界工作，那么我不需要告诉你关于[特拉维斯](http://travis-ci.org/)的事情。

对于我的朝九晚五的就业，我们使用詹金斯。它很灵活，而且足够简单，只要您精通服务器命令行，就可以开始运行。对于一个开源项目(遗憾的是我没有，但想改变这一点)特拉维斯将完全满足我的需求，被托管和免费的操作系统。但是对于个人/商业项目，我用什么呢？

## 红色和蓝色激光器

CiJoe 是一个轻量级、简单的 CI 解决方案，无论您的服务器管理技能如何，都可以轻松运行。您安装 gem，提取存储库，并运行 Joe。

它不是 Ruby 特有的，但是需要一个命令行命令`test`,在失败时用非零值来响应。毫不夸张地说，在 5 分钟之内，我就有了 3 个 CI 下的个人项目。这对我来说是一个巨大的胜利，我不确定如果用别的方法，我会不会很快得到这样的结果。

下面是获得相同结果的演练，无论您是单独的开发人员还是团队的一员。如果您没有 CI，并且喜欢获得稳定的构建/部署工作流的想法，那么这是为您准备的。

## 秋葵锻炼肌肉！对吧，医生？

除了是一个超级 GiJoe 粉丝(尽管它在英国曾被称为 Action Force over)之外，CiJoe 还在很多层面上吸引着我。我喜欢轻量级。我使用 [rbenv](https://github.com/sstephenson/rbenv) 而不是 [RVM](https://rvm.io/) ，更喜欢 [Vim](http://www.vim.org/) 而不是 [RubyMine](http://www.jetbrains.com/ruby/) 。要开始使用 CiJoe，您需要的只是一个运行 Ruby 的机器。不需要安装 Java、Redis 或其他任何东西。所以唯一的必要条件是拥有一个能够运行 Ruby 和 Gems 的远程服务器(最好配置在尽可能接近您的生产环境的地方)。目前，我在安装了 Ubuntu、Git 和从源代码构建的 Ruby 1.9.3 的 VPS 上运行 CiJoe。

## 在我们开始之前就有问题

我在运行 CiJoe 服务器时遇到了一个问题。这是一个已知问题，但尚未在主分支机构中解决。这真的很遗憾，因为看起来这个项目不再被维护了。在撰写本文时，最后一次提交是在一年多以前。但是由 [Anton Lindqvist](https://github.com/mptre) 提供的补丁很容易在你自己的项目分支中实现，或者你甚至可以使用他的分支。

这使得宝石更难安装。我们在这里没有使用 Gemfiles，所以定义 Github url 对您没有任何帮助。是时候建造一些古老的学校宝石建筑了。基本上把 gem 克隆到你的服务器上，`git clone git://github.com/mptre/cijoe.git`。导航到新的 cijoe 目录，使用`gem build cijoe.gemspec`构建 gem。现在，为了最终安装 gem，运行`sudo gem install cijoe.gem`

## 该出发了(fureal)

在我的用户的主目录中，我创建了一个名为`cijoe`的文件夹。这是我打算构建测试应用程序的地方。

这就是建立 CiJoe 最基本的形式。但是我们当然需要把源代码放到这个文件夹中。不知道你怎么样，我用的是 GitHub。Github 让这个过程变得非常简单，允许在项目上部署密钥。如果您不确定如何做到这一点，您需要做的就是[创建一个 ssh 密钥](https://help.github.com/articles/generating-ssh-keys)并[添加这个密钥作为我们想要在 CI 下的项目](https://help.github.com/articles/managing-deploy-keys)的部署密钥。

现在，像往常一样将项目克隆到我们的 cijoe 目录中，并运行`cijoe reponame`。这启动了一个 [Sinatra](http://www.sinatrarb.com/) 应用程序，我们可以通过访问`server_ip:4567`并检查测试的输出，或者开始另一个构建。

## 使配置项更易于管理

现在 CI 应该使我们的生活更容易。提交变更、登录 CI 服务器、获取最新的变更、再次启动 CiJoe、导航到 CiJoe 页面并点击“Build”按钮的想法简直是一场噩梦。正如你所猜测的，事情不需要这样。

首先，导航到一个 IP 地址是蹩脚的。所以添加一个指向`ci.yourdomain.tld`的 DNS 记录。

我使用 apache 来服务我的域，所以我需要一个“站点”来响应新的域。这与在您的服务器上创建任何域是一样的。你可以看到我在这个要点中使用的一个例子。我已经为这个域的根设置了一些基本的认证。但是，这里不会用到它，稍后您将会看到原因。

正如我前面提到的，CiJoe 使用 Sinatra 作为前端。这意味着在 apache 配置中添加基本身份验证没有任何帮助。我们将在`ci.example.com:<port_number>`访问 CI。

## 通过 Git 构建配置

CiJoe 使用 git 配置来改变构建的行为。其中一个选项是使用基本身份验证。在您的本地存储库上，使用

 `git config --add cijoe.user username
git config --add cijoe.pass secret_password` 
现在，当我们导航到 CI 服务器时，系统会提示我们输入用户名和密码。是的，如果项目在 Github 上是公开的，这是徒劳的(也是危险的)，但我们在这里只关心私人项目。

项目的构建也通过 git 配置设置来管理。在这里，我们定义设置并运行我们的测试环境。这是一个单行交易，所以你必须使用`&&`将可执行的步骤链接在一起。

 `git config --add cijoe.runner "bundle install && bundle exec rake db:drop db:create db:migrate && bundle exec rake spec"` 
或者更好的创造一个结合了很多的耙子任务。为此，我使用了一个任务`ci`。

 `desc "Setup the CI env"
task :ci do
Rake::Task['db:drop'].invoke
Rake::Task['db:create'].invoke
Rake::Task['db:migrate'].invoke
Rake::Task['db:test:prepare'].invoke
Rake::Task['spec'].invoke
end` 
这样一来，我们之前的配置设置就变成了:

 `git config --add cijoe.runner "bundle install && bundle exec rake ci"` 

## 看着它变成绿色

有了这些，我们现在可以开始构建了。在服务器的命令行上，导航到项目被克隆的地方并运行`cijoe <project_name>`。如果您查看`ci.example.com:4567`，您将看到 CiJoe 界面，单击“Build”按钮将开始构建，并显示结果。

正如我们之前所说的，这一切都没有那么自动化。CiJoe 的一个众所周知的秘密是，它会在收到 post 请求时开始构建，Github 知道如何做到这一点。但是首先我们需要在后台运行 CiJoe 服务器。只需使用`nohup`我们就可以开始这项工作，并定义 CI 服务器运行的端口。

 `nohup cijoe -p 4000 <your_repo> &` 

值得注意的是，除非启用了构建队列，否则 CiJoe 一次只会运行一个构建。同样，这是一个像`git config --add cijoe.buildqueue true`一样定义的 git 配置。这绝对适合在短时间内进行多次推送的团队或单独开发人员，或者相反，具有显著的构建延迟。

在 Github 管理界面中的“服务挂钩”下，将“Webhook URL”添加到运行 CI 服务器的域中，在这种情况下，将使用认证`http://username:secret@ci.example.com:4000`。单击此挂钩的“测试”按钮将启动 CI 构建。想要 CI 下的更多项目吗？这只是克隆项目并再次开始`nohup`的一个简单例子。

 `nohup cijoe -p 4001 <your_other_repo> &` 

## 深信不疑？

重读这篇文章，我不得不稍微重新思考一下结尾。描述所有的设置并详细说明最初问题的解决听起来，嗯，很痛苦。但我向你保证不是。就我个人而言，包括搜索错误、安装分叉的 gem 和运行基本的 CI 服务器在内，总共花了 5 分钟。设置额外的域名，网页挂钩和通知确实需要一点时间。

然而，你必须将它与建立詹金斯或哈德森及其所有的从属关系进行比较。把所有这些放在一边，CiJoe 是以固定的速度提供可发布软件链中的一个很好的工具。

有点遗憾的是，这个项目似乎不再被维护了，对我来说，这是一个很棒的小项目，它让 CI 对小团队和孤独者来说变得很容易。也许我的 dev box 上的开源目录会让 CiJoe 再次找到自己。有人吗？

## 分享这篇文章