# Ratyrate:给你的 Rails 应用添加评分

> 原文：<https://www.sitepoint.com/ratyrate-add-rating-rails-app/>

本教程探讨了如何向 Rails 应用程序添加评级功能。它将介绍一些提供这种功能的更流行的 Ruby gems，以及如何从头开始实现评级。我们将使用 Karim El Hussieny 在[在线商店文章中使用的相同应用程序，其中详细解释了基本的应用程序创建过程。请参考那个帖子，了解 Karim 如何搭建和设计基本应用程序。](https://www.sitepoint.com/build-online-store-rails/)

这是我们将在应用程序中使用的库的[分支。](https://github.com/wazery/moviestore)

## 目标

正如您在存储库中看到的，这是一个电影在线商店。我们需要为每部电影添加分级功能。每个用户将能够给可用的电影评级。然后，每部电影都会有一个基于所有用户评级计算的分数，就像 [IMDB](http://www.imdb.com/) 所做的那样。

## 主要特征

*   **评价电影:**评价可用的商店电影。*(需要登录)*
*   **显示用户评分:**每个用户都可以访问他/她的仪表盘，查看他/她评分的电影。评级可以随时更改。
*   **更改星号码**星号码可以设置为任何适合应用性质的号码。
*   **用数字显示分数**评分分数也可以用星号旁边的数字来查看。
*   **电影整体平均评分:**每部电影都有一个基于所有用户评分的评分。这个分数是从电影的所有方面计算出来的，如视觉效果、定制设计等。
*   **禁用评级的能力**在第一次评级后可禁用评级，并更改为只读模式。
*   **可定制图标**可以改变星形和取消图标。
*   **取消分级:**用户可以随时取消对任何电影的分级。

## 所需技能

*   体验 Ruby on Rails。
*   HTML/CSS3 的基础知识。
*   理解响应式 CSS 框架的概念。

## 工具

*   **红宝石**`(2.1.0)`–编程语言
*   **轨道**`(4.1.1)`–后端框架
*   **基础 5**–前端 CSS 框架
*   Ratyrate–红宝石
*   **设计**–用户认证

## Ratyrate 宝石

Ratyrate 是一个 Ruby gem，它封装了 T2 jQuery 插件的功能。它还沿着 IMDB 评级的风格添加了一些助手。因为 Letsrate 不活动，我从一个叫做 [Letsrate](https://github.com/muratguzel/letsrate) 的宝石中叉出来的。Ratyrate 有一些很棒的新功能，所以欢迎您开始使用它:)

### 第一步:安装**棘轮**宝石

要安装这个 Ruby gem，只需将它包含在您的`Gemfile`中，如下所示:

```
gem 'ratyrate'
```

在终端运行中:

```
bundle install
```

你可能想看一下[库](https://github.com/wazery/ratyrate)并使用 Ratyrate 的开发版本，因为我一直在添加新的特性。要使用开发 gem，请将以下内容添加到您的**gem 文件**:

```
gem 'ratyrate', :github => 'wazery/ratyrate', :branch => 'development'
```

### 步骤 2:准备应用程序

我假设您已经克隆了 [moviestore](https://github.com/wazery/moviestore) 存储库，并且在它的目录中。如果你不知道怎么做，下面是命令:

```
$ git clone 'git@github.com:wazery/moviestore.git'
$ cd moviestore
```

现在，您需要运行 gem 的生成器，将所需的资产和文件(jQuery Raty 插件文件、星形图标和 JavaScript 文件)复制到 Rails 应用程序中的正确位置。在终端运行中:

```
$ rails g ratyrate User
```

正如您所看到的，这个命令只有一个参数:您现有的 Devise 用户模型的名称。这是绑定用户和评级数据所必需的。

**输出文件:**

```
create  app/assets/javascripts/jquery.raty.js
create  app/asseimg/star-on.png
create  app/asseimg/star-off.png
create  app/asseimg/star-half.png
identical app/asseimg/mid-star.png
identical app/asseimg/big-star.png
create  app/asseimg/cancel-on.png
create  app/asseimg/cancel-off.png
create  app/assets/javascripts/ratyrate.js.erb
create  app/controllers/rater_controller.rb
create  app/models/rate.rb
create  app/models/rating_cache.rb
create  app/models/average_cache.rb
identical app/models/overall_average.rb
 route  post '/rate' => 'rater#create', :as => 'rate'
create  db/migrate/20140814135421_create_rating_caches.rb
identical db/migrate/20140706144643_create_rates.rb
create  db/migrate/20140814135422_create_average_caches.rb
create  db/migrate/20140814135423_create_overall_averages.rb
```

运行使用此生成器创建的迁移，这将创建评级功能所需的表。要运行迁移，请执行以下操作:

```
$ rake db:migrate
```

#### 例子

假设您有一个名为`User`的设计用户模型。设计发电机和 **ratyrate** 发电机看起来像:

```
$ rails g devise:install
$ rails g devise user

$ rails g ratyrate user # => user is the model generated by devise
```

这个生成器将创建 **`Rate`** 和 **`RatingCache`** 模型链接到您的`User`模型。然而，在我们的例子中，您不需要运行 Devise generators，因为 **moviestore** 库已经完成了这项工作。

### 步骤 3:添加 **ratyrate** 关联

打开 **`Movie`** 模型，或者您想要添加主要功能的任何模型，并添加以下行:

```
ratyrate_rateable 'visual_effects', 'original_score', 'director', 'custome_design'
```

这增加了一些用户可以评价的维度。在这里，我们增加了四个维度。这一行还创建了所需的关联。

您还需要定义将进行实际评级的模型。对于我们的 **MovieStore** 应用程序，它是 **`User`** 模型，所以在它上面添加下面一行:

```
ratyrate_rater
```

这也向**用户**模型添加了所需的关联。

### 步骤 4:在视图中使用 **Ratyrate** 助手

打开电影的“放映”视图，可以在**app/views/movies/show . html . erb**中找到

```
<div class="row">
  <div class="small-2 large-2 columns">
    <%= imdb_style_rating_for @movie, current_user%>
  </div>
  <br>
  <div class="small-2 large-4 columns">
    <% if current_user %>
      Visual Effects: <%= rating_for @movie, "visual_effects" %>
      <br>
      Original Score: <%= rating_for @movie, "original_score" %>
      <br>
      Director: <%= rating_for @movie, "original_score" %>
      <br>
      Custome Design: <%= rating_for @movie, "custome_design" %>
    <% end %>
  </div>
</div>
```

该视图使用提供的`rating_for`助手来显示指定的每个维度的等级。

### 第 5 步:**探索选项的**评分**

这是该视图当前的样子:

![1](img/7832d80a10dfa9d7813c23beedba6fa7.png)

如您所见，用户可以取消评级。这个特性可以被禁用，我们稍后会发现。

#### 明星

只需使用选项 **stars** 即可改变星星的数量:

```
Visual Effects: <%= rating_for @movie, "visual_effects", stars: 10 %>
```

![1](img/9d0d1fc7c467ef6ceb2267425b427e5c.png)

#### 禁用/启用评级

默认情况下，用户提供评级后，星星将被禁用。但是，有一个选项让它保持启用状态，以便用户可以更改评级。该选项为**在速率**后禁用*，默认设置为`true`。按如下方式将其设置为`false`:*

```
Visual Effects: <%= rating_for @movie, "visual_effects", disable_after_rate: false %>
```

现在用户第一次评级后星星不会被禁用。

#### 半颗星

一旦有几个评级，很可能平均分数将有半颗星，因此，是半突出。这是默认行为，但是如果您想要禁用半星，请使用 **half_show** 选项:

```
Visual Effects: <%= rating_for @movie, "visual_effects", half_show: false %>
```

#### 更精确的评级

有一个有用的选项，用户可以使用半值进行评级，默认情况下是禁用的。要启用它，只需使用此选项:

```
Visual Effects: <%= rating_for @movie, "visual_effects", enable_half: true %>
```

![1](img/a2d05fcd70a5456922a54c367e4e1dd3.png)

#### 自定义星形图标

这个助手中最有用的选项之一是自定义星星的图标。提供的图标包括:

*   禁用星星(star_off)
*   启用的星星
*   半颗星
*   处于关闭状态的取消按钮
*   处于点击状态的取消按钮

您可以使用特定的选项自定义每个图标，或者只需更改其他同名图标的路径。

以下是更改路径的方法:

```
Visual Effects: <%= rating_for @movie, "visual_effects", path: 'star_icons' %>
```

以下是分别更改每个图标的方法:

*   斯特拉蓬
*   星号 _ 关闭
*   星 _ 半
*   取消 _ 开
*   取消 _ 关闭

![1](img/8e403427be114972727d0d4324b4285b.png)

#### 更改取消按钮的位置

默认情况下,“取消”按钮显示在左侧。如果你愿意，你可以把它改到右边:

```
Visual Effects: <%= rating_for @movie, "visual_effects", cancel_place: 'right' %>
```

![1](img/1e54e269f6bd933122c7d4031342de37.png)

#### 向“取消”按钮添加提示

有一个向取消按钮添加自定义提示消息的选项。默认消息是“取消当前评级！”：

```
Visual Effects: <%= rating_for @movie, "visual_effects", cancel_hint: 'Cancel this vote!' %>
```

![1](img/2b662e685835661874ee9d52cba692a9.png)

#### 恒星间的空间

您可以通过以下方式轻松打开/关闭星间距:

```
Visual Effects: <%= rating_for @movie, "visual_effects", space: true %>
```

*默认为假。*

![1](img/df7b1af1fec8242ee7460741e04aa426.png)

#### 获得平均分

我添加到这个 gem 中的一个新选项是 IMDB 风格平均值。启用起来有点棘手，因为你需要启用两个选项(***disable _ after _ rate***和 ***imdb_avg*** ):

```
Original Score: <%= rating_for @movie, "original_score", disable_after_rate: true, imdb_avg: true %>
```

页面刷新后，星号将更改为使用 IMDB 样式的星号显示平均评分。

![1](img/ab3a3c4182c5c29a584862e3b37d9a6a.png)

#### 显示分数提示

您可以在自定义`div`中显示分数提示(差、差、一般、华丽)或取消提示，而不是在工具提示中显示它们:

```
Original Score: <%= rating_for @movie, "original_score", target: '#hintDiv' %>
<div id="hintDiv"></div>
```

如您所见，**“hint div”**是通过其 ID 选择的。它不仅仅局限于`div` s，因为您可以将目标设置为文本字段、文本区域或选择框。

![1](img/f49f492b44876ed399d2ebffc13977ac.png)

#### 向提示中添加文本

您可以将占位符文本设置为目标 div(您选择的自定义 div):

```
Original Score: <%= rating_for @movie, "original_score", target: '#hintDiv', targetText: 'Some text goes here!' %>
```

![1](img/cfd16375ef94ba639272b20951794cd9.png)

#### 更改目标文本的类型

你可以显示一些提示(坏的，差的，等等)或者只是分数。要改变这种情况，您有两种选择:

默认的一个是**【提示】**:

```
Original Score: <%= rating_for @movie, "original_score", target: "#hintDiv", targetType: "hint" %>
```

和分数值:

```
Original Score: <%= rating_for @movie, "original_score", target: "#hintDiv", targetType: "score" %>
```

![1](img/7069d5a5ee5311e92a5c5fbe8c01ccb2.png)

#### **改变目标文本的格式**

如果您想以自定义格式显示提示或分值，如“分数:5”或“评级:良好”，该怎么办？很简单，看看这两个例子就知道了:

```
Original Score: <%= rating_for @movie, "original_score", target: "#hintDiv", targetFormat: "Score: {score}" %>
```

![1](img/823958f90dc29d0d21b60d2164c88421.png)

```
Original Score: <%= rating_for @movie, "original_score", target: "#hintDiv", targetFormat: "Rating: {hint}" %>
```

### 用户助手的分级

这将是很好的看到当前用户的评分，所以它可以被改变。有一个名为**的助手为用户**评级*就是为了这个目的。它采用 ***rateable object*** (我们应用案例中的电影对象)、当前登录用户****(由 Devise 提供)、分级所在的 ***维度*** 和 ***选项*** 。如果当前用户尚未提供评级，它将显示一颗星。例如，如果给出的评分为 2，它会显示两颗星，这可以更改为一颗星，这意味着用户不能提高给定的分数。***

下面是它的使用方法:

```
Visual Effects: <%= rating_for_user @movie, current_user, "visual_effects" %>
```

![1](img/d1dce17a19544582babb01e7be66cf3e.png)

### IMDB 样式分级帮助程序

另一个有用的助手是所有维度的总体平均分，就像 IMDB 一样。这个助手非常容易使用，只需传入 rateable 对象(在我们的应用程序中是电影)和当前登录的用户:

```
<%= imdb_style_rating_for @movie, current_user %>
```

![1](img/dbee8f1e7e639c249d22d3f593900d1e.png)

### 摘要

在本教程中， **Ratyrate** gem 为 MovieStore 应用程序中的电影添加了分级功能。我们详细探讨了如何使用 **Ratyrate** 宝石，以及其中可用的助手和选项。我希望这篇教程今天对你有很高的评价！

## 分享这篇文章